<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BoxVolt Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Exo+2:wght@500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap");

    :root {
      --bg-top: #f2fbff;
      --bg-mid: #d6e7ef;
      --bg-bottom: #c5d8e0;
      --panel-top: #03606a;
      --panel-bottom: #03464f;
      --text: #e9fdff;
      --title: #f3ffff;
      --ink: #0f3137;
      --muted: #b6d9de;
      --accent: #53f0e0;
      --accent-2: #97fff2;
      --danger: #ffd8de;
      --ok: #a6ffe2;
      --border: rgba(161, 250, 236, 0.33);
      --glass: rgba(255, 255, 255, 0.08);
      --glass-strong: rgba(255, 255, 255, 0.14);
      --shadow: 0 22px 44px rgba(1, 28, 31, 0.24);
      --btn-shadow: 0 10px 20px rgba(2, 34, 40, 0.22);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Space Grotesk", "Exo 2", "Trebuchet MS", sans-serif;
      background:
        radial-gradient(60% 70% at 15% -10%, #f8ffff 0%, transparent 100%),
        radial-gradient(80% 90% at 100% 0%, #e7f7ff 0%, transparent 100%),
        linear-gradient(180deg, var(--bg-top) 0%, var(--bg-mid) 50%, var(--bg-bottom) 100%);
      color: var(--ink);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    body::before,
    body::after {
      content: "";
      position: fixed;
      z-index: 0;
      pointer-events: none;
      border-radius: 999px;
      filter: blur(2px);
    }

    body::before {
      width: 340px;
      height: 340px;
      top: -140px;
      left: -110px;
      background: radial-gradient(circle, rgba(31, 255, 231, 0.25), transparent 68%);
    }

    body::after {
      width: 380px;
      height: 380px;
      right: -160px;
      bottom: -120px;
      background: radial-gradient(circle, rgba(9, 184, 197, 0.26), transparent 68%);
    }

    .wrap {
      max-width: 720px;
      margin: 0 auto;
      padding: 18px 14px 44px;
      position: relative;
      z-index: 1;
    }

    .hero {
      border-radius: 24px;
      background:
        linear-gradient(135deg, rgba(0, 79, 88, 0.93), rgba(2, 56, 64, 0.93)),
        radial-gradient(130% 130% at 0% 0%, rgba(120, 255, 239, 0.18), transparent 55%);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 12px;
    }

    .hero-head {
      display: block;
      margin-bottom: 6px;
    }

    .title {
      font-family: "Exo 2", "Space Grotesk", sans-serif;
      color: var(--title);
      font-size: clamp(24px, 6vw, 34px);
      font-weight: 700;
      letter-spacing: 0.02em;
      margin: 0;
      text-shadow: 0 3px 16px rgba(0, 0, 0, 0.24);
    }

    .subtitle {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 14px;
      max-width: 520px;
    }

    .tabbar {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 12px;
    }

    button.tab-btn {
      min-width: 0;
      width: 100%;
      padding: 9px 8px;
      border-radius: 12px;
      font-size: 12px;
      line-height: 1.1;
      letter-spacing: 0.03em;
      border: 1px solid rgba(151, 243, 231, 0.68);
      color: #f1feff;
      background: linear-gradient(180deg, rgba(2, 82, 92, 0.9), rgba(1, 58, 66, 0.88));
      text-shadow: 0 1px 4px rgba(0, 0, 0, 0.32);
      box-shadow: 0 9px 18px rgba(2, 27, 32, 0.28);
    }

    button.tab-btn.is-active {
      border-color: rgba(194, 255, 247, 0.96);
      background: linear-gradient(180deg, rgba(28, 171, 164, 0.96), rgba(8, 113, 116, 0.92));
      color: #ffffff;
      box-shadow: 0 12px 22px rgba(2, 33, 38, 0.34);
    }

    .tab-panel.tab-hidden {
      display: none;
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 14px;
      background:
        linear-gradient(165deg, rgba(2, 97, 106, 0.92), rgba(1, 64, 74, 0.92)),
        radial-gradient(100% 130% at 100% 0%, rgba(152, 255, 242, 0.2), transparent 60%);
      color: var(--text);
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .card::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: 1px solid rgba(255, 255, 255, 0.06);
      pointer-events: none;
    }

    .card strong {
      font-family: "Exo 2", "Space Grotesk", sans-serif;
      letter-spacing: 0.03em;
      font-size: 15px;
    }

    .status {
      padding: 12px 14px;
      border-radius: 15px;
      font-size: 14px;
      margin-top: 12px;
      margin-bottom: 0;
      border: 1px solid rgba(178, 255, 245, 0.3);
      color: #defeff;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    .status.ok {
      border-color: rgba(166, 255, 226, 0.55);
      color: var(--ok);
      background: rgba(0, 104, 74, 0.3);
    }

    .status.err {
      border-color: rgba(255, 206, 215, 0.6);
      color: var(--danger);
      background: rgba(123, 24, 43, 0.26);
    }

    .plans {
      display: grid;
      gap: 12px;
    }

    .plan {
      border: 1px solid rgba(170, 255, 243, 0.26);
      border-radius: 18px;
      padding: 13px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
    }

    .plan h3 {
      margin: 0 0 4px;
      font-size: 16px;
      color: #f4ffff;
    }

    .plan p {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
    }

    button {
      border: 1px solid rgba(172, 255, 243, 0.55);
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      color: #ecffff;
      background:
        linear-gradient(180deg, rgba(110, 255, 236, 0.22), rgba(110, 255, 236, 0.08)),
        rgba(255, 255, 255, 0.05);
      padding: 10px 12px;
      min-width: 118px;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      box-shadow: var(--btn-shadow);
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 24px rgba(3, 33, 40, 0.28);
      border-color: rgba(195, 255, 247, 0.75);
    }

    button:active {
      transform: translateY(1px);
    }

    button.ghost {
      background: rgba(255, 255, 255, 0.03);
      border-color: rgba(183, 255, 246, 0.32);
      color: #dcfbff;
    }

    .order-row {
      display: flex;
      gap: 9px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .order-row button {
      flex: 1 1 150px;
    }

    .mono {
      font-family: "Space Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      word-break: break-all;
      color: #d9fcff;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 10px;
      margin-top: 8px;
      border: 1px solid rgba(172, 255, 245, 0.22);
    }

    .hidden { display: none; }

    .small {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }

    .pitch {
      margin-top: 10px;
      border: 1px solid rgba(178, 255, 244, 0.3);
      border-radius: 14px;
      padding: 11px;
      background: linear-gradient(165deg, rgba(255, 255, 255, 0.11), rgba(255, 255, 255, 0.04));
    }

    .pitch ul {
      margin: 8px 0 0;
      padding-left: 16px;
      color: #d9fbff;
      font-size: 13px;
      line-height: 1.5;
    }

    .faq {
      margin-top: 10px;
      border: 1px solid rgba(178, 255, 244, 0.24);
      border-radius: 14px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.04);
    }

    .faq details {
      border-top: 1px solid rgba(177, 255, 244, 0.17);
      padding: 8px 0;
    }

    .faq details:first-of-type {
      border-top: 0;
      padding-top: 0;
    }

    .faq summary {
      cursor: pointer;
      color: #e9fdff;
      font-weight: 600;
      font-size: 13px;
      list-style: none;
    }

    .faq summary::-webkit-details-marker {
      display: none;
    }

    .faq p {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 12px;
    }

    .field label {
      font-size: 12px;
      color: #c6e9ed;
      letter-spacing: 0.03em;
    }

    .field input, .field textarea {
      width: 100%;
      border: 1px solid rgba(181, 255, 246, 0.28);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.06);
      color: #ebfeff;
      padding: 10px 11px;
      font-size: 13px;
      font-family: inherit;
      outline: none;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .field input::placeholder,
    .field textarea::placeholder {
      color: rgba(200, 237, 241, 0.72);
    }

    .field input:focus,
    .field textarea:focus {
      border-color: rgba(183, 255, 247, 0.74);
      box-shadow: 0 0 0 2px rgba(138, 255, 239, 0.2);
    }

    .field textarea { min-height: 88px; resize: vertical; }

    .admin-plans {
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }

    .admin-plan {
      border: 1px solid rgba(184, 255, 246, 0.24);
      border-radius: 13px;
      padding: 11px;
      background: rgba(255, 255, 255, 0.05);
    }

    .admin-plan-head {
      font-size: 12px;
      color: #bce1e6;
      margin-bottom: 8px;
      letter-spacing: 0.04em;
    }

    .admin-plan-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .mini-block {
      margin-top: 12px;
      border: 1px solid rgba(184, 255, 246, 0.24);
      border-radius: 14px;
      padding: 11px;
      background: rgba(255, 255, 255, 0.05);
    }

    .state-line {
      margin-top: 8px;
    }

    .state-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 5px 11px;
      border: 1px solid rgba(190, 255, 248, 0.45);
      background: rgba(255, 255, 255, 0.08);
      color: #e9fdff;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .state-pill.ok {
      color: var(--ok);
      border-color: rgba(166, 255, 226, 0.58);
      background: rgba(0, 104, 74, 0.3);
    }

    .state-pill.warn {
      color: #ffd4b8;
      border-color: rgba(255, 202, 151, 0.55);
      background: rgba(120, 58, 12, 0.26);
    }

    .state-pill.info {
      color: #d6fbff;
      border-color: rgba(169, 241, 255, 0.52);
      background: rgba(8, 80, 96, 0.28);
    }

    #adminUserResults .order-row { margin-top: 8px; }

    @media (max-width: 520px) {
      .tabbar {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .plan {
        flex-direction: column;
        align-items: stretch;
      }
      .plan button {
        width: 100%;
      }
      .order-row button {
        flex-basis: 100%;
      }
      .admin-plan-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="hero">
      <div class="hero-head">
        <h1 class="title">‚ö° BoxVolt Mini App</h1>
      </div>
      <p class="subtitle">–ü–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã –≤ –æ–¥–Ω–æ–º –æ–∫–Ω–µ Telegram</p>
      <div id="status" class="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </section>

    <nav class="tabbar" aria-label="–†–∞–∑–¥–µ–ª—ã Mini App">
      <button type="button" id="accountTabBtn" class="tab-btn is-active" data-tab-target="accountCard">üë§ –ê–∫–∫–∞—É–Ω—Ç</button>
      <button type="button" id="plansTabBtn" class="tab-btn" data-tab-target="plansCard">üí≥ –¢–∞—Ä–∏—Ñ—ã</button>
      <button type="button" id="orderTabBtn" class="tab-btn hidden" data-tab-target="orderCard">üßæ –ó–∞–∫–∞–∑</button>
      <button type="button" id="adminTabBtn" class="tab-btn hidden" data-tab-target="adminCard">üõ† –ê–¥–º–∏–Ω</button>
      <button type="button" id="broadcastTabBtn" class="tab-btn hidden" data-tab-target="broadcastCard">üì£ –†–∞—Å—Å—ã–ª–∫–∞</button>
    </nav>

    <section id="accountCard" class="card tab-panel">
      <strong>–ê–∫–∫–∞—É–Ω—Ç</strong>
      <div class="pitch">
        <strong>‚ö° BoxVolt Elite Access</strong>
        <ul>
          <li>–°—Ç–∞–±–∏–ª—å–Ω—ã–π VLESS Reality —Å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª—è–µ–º–æ–π –ø–æ–¥–ø–∏—Å–∫–æ–π.</li>
          <li>–ë—ã—Å—Ç—Ä–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –¥–Ω–µ–π.</li>
          <li>–ú–æ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –≤—ã–¥–∞—á–∞ –∫–ª—é—á–∞ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤ Telegram.</li>
        </ul>
      </div>
      <div class="faq">
        <strong>FAQ</strong>
        <details>
          <summary>–û–ø–ª–∞—Ç–∏–ª –±–æ–ª—å—à–µ –∏–∑-–∑–∞ –∫–æ–º–∏—Å—Å–∏–∏. –ó–∞–∫–∞–∑ –∑–∞—á—Ç—ë—Ç—Å—è?</summary>
          <p>–î–∞. –ó–∞–∫–∞–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è, –µ—Å–ª–∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Å—É–º–º–∞ –Ω–µ –Ω–∏–∂–µ —Å—É–º–º—ã —Ç–∞—Ä–∏—Ñ–∞.</p>
        </details>
        <details>
          <summary>–ü—Ä–æ–¥–ª–µ–Ω–∏–µ —Å–æ–∂–∂—ë—Ç –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –¥–Ω–∏?</summary>
          <p>–ù–µ—Ç. –ù–æ–≤—ã–µ –¥–Ω–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Å–≤–µ—Ä—Ö—É –∫ —Ç–µ–∫—É—â–µ–π –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ.</p>
        </details>
        <details>
          <summary>–ö–ª—é—á –æ–±–Ω–æ–≤–∏–ª—Å—è, –∞ —Å—Å—ã–ª–∫–∞ —Ç–∞–∫–∞—è –∂–µ?</summary>
          <p>–ü–æ—Å–ª–µ –ø–µ—Ä–µ–≤—ã–ø—É—Å–∫–∞ —Å—Å—ã–ª–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–æ–≤–æ–π, —Å—Ç–∞—Ä–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.</p>
        </details>
      </div>
      <div id="profile" class="small" style="margin-top:8px;">–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ...</div>
      <div id="activePromo" class="small" style="margin-top:8px;">–ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥: –Ω–µ—Ç</div>
      <strong style="display:block; margin-top:12px;">–ë—ã—Å—Ç—Ä–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ</strong>
      <div class="order-row">
        <button id="quickRenew7Btn" class="ghost">üí≥ 7 –¥–Ω–µ–π</button>
        <button id="quickRenew30Btn" class="ghost">üí≥ 30 –¥–Ω–µ–π</button>
      </div>
      <div class="order-row">
        <button id="quickRenew90Btn" class="ghost">üí≥ 90 –¥–Ω–µ–π</button>
        <button id="quickRenew365Btn" class="ghost">üí≥ 365 –¥–Ω–µ–π</button>
      </div>
      <div class="order-row">
        <button id="quickRenewLastBtn" class="ghost">üîÅ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ—à–ª—ã–π —Ç–∞—Ä–∏—Ñ</button>
      </div>
      <div class="field">
        <label for="promoCodeInput">–ü—Ä–æ–º–æ–∫–æ–¥</label>
        <input id="promoCodeInput" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: BOXVOLT100">
      </div>
      <div class="order-row">
        <button id="promoActivateBtn" class="ghost">üéü –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
      </div>
    </section>

    <section id="plansCard" class="card tab-panel tab-hidden">
      <strong>–¢–∞—Ä–∏—Ñ—ã</strong>
      <div id="plans" class="plans" style="margin-top:10px;"></div>
    </section>

    <section id="adminCard" class="card tab-panel hidden tab-hidden">
      <strong>üõ† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</strong>
      <p class="small" style="margin-top:8px;">
        –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω –∏ –∞–∫—Ü–∏–π –ø—Ä—è–º–æ –≤ Mini App.
      </p>

      <div class="field">
        <label for="adminGlobalDiscount">–ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ (%)</label>
        <input id="adminGlobalDiscount" type="number" min="0" max="90" value="0">
      </div>

      <div class="field">
        <label for="adminSaleTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∞–∫—Ü–∏–∏</label>
        <input id="adminSaleTitle" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Weekend Sale">
      </div>

      <div class="field">
        <label for="adminSaleMessage">–¢–µ–∫—Å—Ç –∞–∫—Ü–∏–∏</label>
        <textarea id="adminSaleMessage" placeholder="–¢–æ–ª—å–∫–æ –¥–æ –∫–æ–Ω—Ü–∞ –Ω–µ–¥–µ–ª–∏..."></textarea>
      </div>

      <strong style="display:block; margin-top:12px;">–ü–ª–∞–Ω—ã</strong>
      <div id="adminPlans" class="admin-plans"></div>

      <strong style="display:block; margin-top:14px;">–ü—Ä–æ–º–æ–∫–æ–¥—ã</strong>
      <div class="field">
        <label for="adminPromoCode">–ö–æ–¥</label>
        <input id="adminPromoCode" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: START50">
      </div>
      <div class="admin-plan-grid">
        <div class="field">
          <label for="adminPromoDiscount">–°–∫–∏–¥–∫–∞ (‚ÇΩ)</label>
          <input id="adminPromoDiscount" type="number" min="1" max="100000" value="50">
        </div>
        <div class="field">
          <label for="adminPromoExpires">–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ</label>
          <input id="adminPromoExpires" type="text" placeholder="2026-03-01 23:59">
        </div>
        <div class="field">
          <label for="adminPromoMaxActivations">–õ–∏–º–∏—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–π (0 = –±–µ–∑ –ª–∏–º–∏—Ç–∞)</label>
          <input id="adminPromoMaxActivations" type="number" min="0" max="1000000" value="0">
        </div>
      </div>
      <div class="order-row">
        <button id="adminPromoSaveBtn" class="ghost">üéü –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
        <button id="adminPromoReloadBtn" class="ghost">üìã –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
      </div>
      <div id="adminPromoList" class="small" style="margin-top:8px; white-space:pre-wrap;"></div>

      <strong style="display:block; margin-top:14px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</strong>
      <div class="field">
        <label for="adminUserQuery">–ü–æ–∏—Å–∫ –ø–æ @username –∏–ª–∏ Telegram ID</label>
        <input id="adminUserQuery" type="text" placeholder="@username –∏–ª–∏ 123456789">
      </div>
      <div class="order-row">
        <button id="adminUserSearchBtn" class="ghost">üîé –ù–∞–π—Ç–∏</button>
      </div>
      <div id="adminUserResults" class="small" style="margin-top:8px; white-space:pre-wrap;"></div>
      <div id="adminSelectedUser" class="small" style="margin-top:8px;">–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –Ω–µ—Ç</div>
      <div class="admin-plan-grid">
        <div class="field">
          <label for="adminGrantDays">–í—ã–¥–∞—Ç—å –¥–Ω–µ–π</label>
          <input id="adminGrantDays" type="number" min="1" max="3650" value="30">
        </div>
      </div>
      <div class="order-row">
        <button id="adminGrantBtn" class="ghost">‚ûï –í—ã–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
        <button id="adminRemoveSubBtn" class="ghost">üóë –£–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
      </div>

      <div class="order-row">
        <button id="adminSaveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–Ω—ã</button>
        <button id="adminReloadBtn" class="ghost">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
    </section>

    <section id="broadcastCard" class="card tab-panel hidden tab-hidden">
      <strong>üì£ –†–∞—Å—Å—ã–ª–∫–∞</strong>
      <p class="small" style="margin-top:8px;">
        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–Ω—ã–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏, —Ä–µ–∂–∏–º–∞–º–∏ —Ä–∞–±–æ—Ç—ã –∏ –º–∞—Å—Å–æ–≤—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.
      </p>

      <div class="mini-block">
        <strong style="display:block;">–†–µ–∂–∏–º update-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</strong>
        <div class="state-line">
          <span id="adminUpdateModeBadge" class="state-pill info">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <div class="order-row">
          <button id="adminToggleUpdateModeBtn" class="ghost">üîÅ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ/—Ä—É—á–Ω–æ–π</button>
          <button id="adminSendUpdateNoticeBtn" class="ghost">üÜï –†–∞–∑–æ—Å–ª–∞—Ç—å update-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
        </div>
      </div>

      <div class="mini-block">
        <strong style="display:block;">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã</strong>
        <div class="state-line">
          <span id="adminMaintenanceBadge" class="state-pill info">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <div class="order-row">
          <button id="adminToggleMaintenanceBtn" class="ghost">üöß –í–∫–ª/–≤—ã–∫–ª —Ç–µ—Ö—Ä–∞–±–æ—Ç—ã</button>
        </div>
      </div>

      <div class="field">
        <label for="adminBroadcastText">–¢–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <textarea id="adminBroadcastText" placeholder="–ï—Å–ª–∏ –ø—É—Å—Ç–æ, –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç –∞–∫—Ü–∏–∏."></textarea>
      </div>
      <div class="order-row">
        <button id="adminSendBroadcastBtn">üì£ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</button>
        <button id="adminRuntimeReloadBtn" class="ghost">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã</button>
      </div>

      <div class="mini-block">
        <strong style="display:block;">–ê–Ω—Ç–∏—Ñ—Ä–æ–¥-—Ñ–ª–∞–≥–∏</strong>
        <p class="small" style="margin:8px 0 0;">
          –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–ª–∏–º–∏—Ç—ã/–∞–±—É–∑/underpay). –ê–≤—Ç–æ–±–∞–Ω–∞ –Ω–µ—Ç, —Ç–æ–ª—å–∫–æ —Ä—É—á–Ω–∞—è –º–æ–¥–µ—Ä–∞—Ü–∏—è.
        </p>
        <div class="order-row">
          <button id="adminFlagsReloadBtn" class="ghost">üö© –û–±–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥–∏</button>
        </div>
        <div class="field">
          <label for="adminResolveFlagId">ID —Ñ–ª–∞–≥–∞ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è</label>
          <input id="adminResolveFlagId" type="number" min="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 42">
        </div>
        <div class="order-row">
          <button id="adminResolveFlagBtn" class="ghost">‚úÖ –ü–æ–º–µ—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º</button>
        </div>
        <div id="adminFlagsList" class="small" style="margin-top:8px; white-space:pre-wrap;"></div>
      </div>
    </section>

    <section id="orderCard" class="card tab-panel hidden tab-hidden">
      <strong>–¢–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑</strong>
      <div id="orderInfo" class="small" style="margin-top:8px;"></div>
      <div id="orderCode" class="mono"></div>
      <div class="order-row">
        <button id="payBtn">üí∏ –û–ø–ª–∞—Ç–∏—Ç—å</button>
        <button id="cryptoPayBtn" class="ghost hidden">‚Çø CryptoBot</button>
        <button id="lztPayBtn" class="ghost hidden">‚ö° LZT Market</button>
        <button id="secondaryPayBtn" class="ghost hidden">ü™ô –†–µ–∑–µ—Ä–≤–Ω–∞—è –æ–ø–ª–∞—Ç–∞</button>
        <button id="checkBtn" class="ghost">‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É</button>
        <button id="cancelBtn" class="ghost">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
        <button id="repeatBtn" class="ghost hidden">üîÅ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑</button>
        <button id="copyBtn" class="ghost">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
      </div>
      <p class="small" style="margin-top:10px;">
        –£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –∫–∞–∫ –≤ –∑–∞–∫–∞–∑–µ. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–∫–æ–¥ –∑–∞–∫–∞–∑–∞) –∂–µ–ª–∞—Ç–µ–ª–µ–Ω, –Ω–æ –µ—Å–ª–∏ –ø–æ–ª—è –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –æ–ø–ª–∞—Ç–∏—Ç–µ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É¬ª.
      </p>
    </section>
  </main>

  <script>
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
      tg.ready();
      tg.expand();
    }

    const initData = tg ? tg.initData : "";
    const urlParams = new URLSearchParams(window.location.search || "");
    const requestedTab = String(urlParams.get("tab") || "").trim().toLowerCase();
    const orderIdFromQuery = String(urlParams.get("order_id") || "").trim().toUpperCase();
    const orderIdFromQueryValid = /^BV-[A-Z0-9_-]{6,80}$/.test(orderIdFromQuery);
    let currentOrderId = "";
    let currentPaymentUrl = "";
    let currentDonatePayUrl = "";
    let currentCryptobotPaymentUrl = "";
    let currentCryptobotPaymentLabel = "CryptoBot";
    let currentLztPaymentUrl = "";
    let currentLztPaymentLabel = "LZT Market";
    let currentSecondaryPaymentUrl = "";
    let currentSecondaryPaymentLabel = "–†–µ–∑–µ—Ä–≤–Ω–∞—è –æ–ø–ª–∞—Ç–∞";
    let currentOrderProviderLabel = "DonatePay";
    let currentOrderStatus = "pending";
    let autoStatusTimer = null;
    let isAdmin = false;
    let adminLoaded = false;
    let adminUpdateMode = "auto";
    let adminMaintenanceEnabled = false;
    let selectedAdminUserId = 0;
    let adminFoundUsers = [];
    let paymentProvider = "donatepay";
    let paymentProviderLabel = "DonatePay";
    let plansCache = [];
    let lastPaidPlanCode = "";

    const statusEl = document.getElementById("status");
    const profileEl = document.getElementById("profile");
    const activePromoEl = document.getElementById("activePromo");
    const promoCodeInputEl = document.getElementById("promoCodeInput");
    const promoActivateBtn = document.getElementById("promoActivateBtn");
    const quickRenew7Btn = document.getElementById("quickRenew7Btn");
    const quickRenew30Btn = document.getElementById("quickRenew30Btn");
    const quickRenew90Btn = document.getElementById("quickRenew90Btn");
    const quickRenew365Btn = document.getElementById("quickRenew365Btn");
    const quickRenewLastBtn = document.getElementById("quickRenewLastBtn");
    const plansEl = document.getElementById("plans");
    const accountCardEl = document.getElementById("accountCard");
    const plansCardEl = document.getElementById("plansCard");
    const tabButtons = Array.from(document.querySelectorAll(".tab-btn[data-tab-target]"));
    const adminTabBtnEl = document.getElementById("adminTabBtn");
    const broadcastTabBtnEl = document.getElementById("broadcastTabBtn");
    const orderTabBtnEl = document.getElementById("orderTabBtn");
    const adminCardEl = document.getElementById("adminCard");
    const broadcastCardEl = document.getElementById("broadcastCard");
    const adminGlobalDiscountEl = document.getElementById("adminGlobalDiscount");
    const adminSaleTitleEl = document.getElementById("adminSaleTitle");
    const adminSaleMessageEl = document.getElementById("adminSaleMessage");
    const adminPlansEl = document.getElementById("adminPlans");
    const adminPromoCodeEl = document.getElementById("adminPromoCode");
    const adminPromoDiscountEl = document.getElementById("adminPromoDiscount");
    const adminPromoExpiresEl = document.getElementById("adminPromoExpires");
    const adminPromoMaxActivationsEl = document.getElementById("adminPromoMaxActivations");
    const adminPromoSaveBtn = document.getElementById("adminPromoSaveBtn");
    const adminPromoReloadBtn = document.getElementById("adminPromoReloadBtn");
    const adminPromoListEl = document.getElementById("adminPromoList");
    const adminUserQueryEl = document.getElementById("adminUserQuery");
    const adminUserSearchBtn = document.getElementById("adminUserSearchBtn");
    const adminUserResultsEl = document.getElementById("adminUserResults");
    const adminSelectedUserEl = document.getElementById("adminSelectedUser");
    const adminGrantDaysEl = document.getElementById("adminGrantDays");
    const adminGrantBtn = document.getElementById("adminGrantBtn");
    const adminRemoveSubBtn = document.getElementById("adminRemoveSubBtn");
    const adminSaveBtn = document.getElementById("adminSaveBtn");
    const adminReloadBtn = document.getElementById("adminReloadBtn");
    const adminBroadcastTextEl = document.getElementById("adminBroadcastText");
    const adminSendBroadcastBtn = document.getElementById("adminSendBroadcastBtn");
    const adminRuntimeReloadBtn = document.getElementById("adminRuntimeReloadBtn");
    const adminUpdateModeBadgeEl = document.getElementById("adminUpdateModeBadge");
    const adminMaintenanceBadgeEl = document.getElementById("adminMaintenanceBadge");
    const adminToggleUpdateModeBtn = document.getElementById("adminToggleUpdateModeBtn");
    const adminSendUpdateNoticeBtn = document.getElementById("adminSendUpdateNoticeBtn");
    const adminToggleMaintenanceBtn = document.getElementById("adminToggleMaintenanceBtn");
    const adminFlagsReloadBtn = document.getElementById("adminFlagsReloadBtn");
    const adminResolveFlagIdEl = document.getElementById("adminResolveFlagId");
    const adminResolveFlagBtn = document.getElementById("adminResolveFlagBtn");
    const adminFlagsListEl = document.getElementById("adminFlagsList");
    const orderCardEl = document.getElementById("orderCard");
    const orderInfoEl = document.getElementById("orderInfo");
    const orderCodeEl = document.getElementById("orderCode");
    const payBtn = document.getElementById("payBtn");
    const cryptoPayBtn = document.getElementById("cryptoPayBtn");
    const lztPayBtn = document.getElementById("lztPayBtn");
    const secondaryPayBtn = document.getElementById("secondaryPayBtn");
    const checkBtn = document.getElementById("checkBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const repeatBtn = document.getElementById("repeatBtn");
    const copyBtn = document.getElementById("copyBtn");

    const tabPanels = [
      accountCardEl,
      plansCardEl,
      orderCardEl,
      adminCardEl,
      broadcastCardEl,
    ].filter(Boolean);

    function setStatus(text, kind) {
      statusEl.textContent = text;
      statusEl.className = "status";
      if (kind === "ok") statusEl.classList.add("ok");
      if (kind === "err") statusEl.classList.add("err");
    }

    async function requestJson(url, method, payload) {
      const options = { method, headers: { "Content-Type": "application/json" } };
      if (payload) options.body = JSON.stringify(payload);
      const res = await fetch(url, options);
      let data = {};
      try {
        data = await res.json();
      } catch (_) {
        throw new Error("bad_json_response");
      }
      if (!res.ok || data.ok === false) {
        throw new Error(data.error || ("http_" + res.status));
      }
      return data;
    }

    function resolveTabFromQuery() {
      const map = {
        account: "accountCard",
        plans: "plansCard",
        order: "orderCard",
        admin: "adminCard",
        broadcast: "broadcastCard",
      };
      return map[requestedTab] || "";
    }

    function getCurrentActiveTabTarget() {
      const activeBtn = tabButtons.find((item) => item.classList.contains("is-active"));
      return activeBtn ? String(activeBtn.dataset.tabTarget || "") : "";
    }

    function switchTab(targetId) {
      const wanted = String(targetId || "").trim();
      if (!wanted) return;
      const panel = document.getElementById(wanted);
      if (!panel || panel.classList.contains("hidden")) return;

      tabButtons.forEach((btn) => {
        const isActive = btn.dataset.tabTarget === wanted;
        btn.classList.toggle("is-active", isActive);
      });
      tabPanels.forEach((item) => {
        if (item.id === wanted) item.classList.remove("tab-hidden");
        else item.classList.add("tab-hidden");
      });
    }

    function ensureValidTab(preferredId = "accountCard") {
      const activeId = getCurrentActiveTabTarget();
      const candidates = [
        activeId,
        preferredId,
        "accountCard",
        "plansCard",
        "orderCard",
        "adminCard",
        "broadcastCard",
      ];
      for (const targetId of candidates) {
        if (!targetId) continue;
        const panel = document.getElementById(targetId);
        const btn = tabButtons.find((item) => item.dataset.tabTarget === targetId);
        if (!panel || !btn) continue;
        if (panel.classList.contains("hidden") || btn.classList.contains("hidden")) continue;
        switchTab(targetId);
        return;
      }
    }

    function syncOrderTabVisibility() {
      if (!orderTabBtnEl || !orderCardEl) return;
      const hasOrder = !orderCardEl.classList.contains("hidden");
      orderTabBtnEl.classList.toggle("hidden", !hasOrder);
      if (!hasOrder) {
        orderCardEl.classList.add("tab-hidden");
      }
    }

    function setAdminVisible(visible) {
      const allowed = !!visible;
      adminCardEl.classList.toggle("hidden", !allowed);
      adminTabBtnEl.classList.toggle("hidden", !allowed);
      broadcastCardEl.classList.toggle("hidden", !allowed);
      broadcastTabBtnEl.classList.toggle("hidden", !allowed);
      if (!allowed) {
        adminCardEl.classList.add("tab-hidden");
        broadcastCardEl.classList.add("tab-hidden");
      }
      ensureValidTab("accountCard");
    }

    function toInt(value, fallback = 0) {
      const parsed = Number.parseInt(String(value), 10);
      return Number.isFinite(parsed) ? parsed : fallback;
    }

    function promoErrorText(code) {
      const map = {
        bad_code_format: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø—Ä–æ–º–æ–∫–æ–¥–∞.",
        promo_not_found: "–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω.",
        promo_inactive: "–ü—Ä–æ–º–æ–∫–æ–¥ –æ—Ç–∫–ª—é—á–µ–Ω.",
        promo_expired: "–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—Ç–µ–∫.",
        promo_limit_reached: "–õ–∏–º–∏—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–π –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—á–µ—Ä–ø–∞–Ω.",
        promo_already_activated: "–í—ã —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥."
      };
      return map[code] || ("–û—à–∏–±–∫–∞: " + code);
    }

    function toBool(value) {
      if (typeof value === "boolean") return value;
      const normalized = String(value || "").trim().toLowerCase();
      return normalized === "1" || normalized === "true" || normalized === "yes" || normalized === "on";
    }

    function updateModeTitle(mode) {
      return mode === "manual"
        ? "–†—É—á–Ω–æ–π —Ä–µ–∂–∏–º: –∞–≤—Ç–æ-—Ä–∞—Å—Å—ã–ª–∫–∞ update –æ—Ç–∫–ª—é—á–µ–Ω–∞"
        : "–ê–≤—Ç–æ —Ä–µ–∂–∏–º: update-—Ä–∞—Å—Å—ã–ª–∫–∞ –ø—Ä–∏ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö –≤–∫–ª—é—á–µ–Ω–∞";
    }

    function maintenanceTitle(enabled) {
      return enabled
        ? "–¢–µ—Ö—Ä–∞–±–æ—Ç—ã: –≤–∫–ª—é—á–µ–Ω—ã (–≤—ã–¥–∞—á–∞/–ø–µ—Ä–µ–≤—ã–ø—É—Å–∫ –∫–ª—é—á–µ–π –≤ –±–æ—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã)"
        : "–¢–µ—Ö—Ä–∞–±–æ—Ç—ã: –≤—ã–∫–ª—é—á–µ–Ω—ã (–≤—ã–¥–∞—á–∞/–ø–µ—Ä–µ–≤—ã–ø—É—Å–∫ –∫–ª—é—á–µ–π –¥–æ—Å—Ç—É–ø–Ω—ã)";
    }

    function renderAdminRuntimeState(state) {
      adminUpdateMode = String(state.update_notify_mode || "auto").trim().toLowerCase() === "manual"
        ? "manual"
        : "auto";
      adminMaintenanceEnabled = toBool(state.maintenance_mode);

      if (adminUpdateModeBadgeEl) {
        adminUpdateModeBadgeEl.textContent = updateModeTitle(adminUpdateMode);
        adminUpdateModeBadgeEl.className = "state-pill";
        adminUpdateModeBadgeEl.classList.add(adminUpdateMode === "manual" ? "warn" : "ok");
      }

      if (adminMaintenanceBadgeEl) {
        adminMaintenanceBadgeEl.textContent = maintenanceTitle(adminMaintenanceEnabled);
        adminMaintenanceBadgeEl.className = "state-pill";
        adminMaintenanceBadgeEl.classList.add(adminMaintenanceEnabled ? "warn" : "ok");
      }
    }

    function renderAdminPromocodes(promocodes) {
      if (!adminPromoListEl) return;
      const items = (promocodes || []).map((promo) => {
        const limit = Number(promo.max_activations || 0) > 0
          ? `${promo.total_activations || 0}/${promo.max_activations}`
          : `${promo.total_activations || 0}/‚àû`;
        const used = Number(promo.used_activations || 0);
        const state = promo.is_expired ? "–∏—Å—Ç–µ–∫" : (promo.is_active ? "–∞–∫—Ç–∏–≤–µ–Ω" : "–≤—ã–∫–ª");
        return `‚Ä¢ ${promo.code}: -${promo.discount_rub} ‚ÇΩ, –¥–æ ${promo.expires_at}, –∞–∫—Ç–∏–≤–∞—Ü–∏–π ${limit}, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ ${used}, —Å—Ç–∞—Ç—É—Å ${state}`;
      });
      adminPromoListEl.textContent = items.length ? items.join("\n") : "–ü—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.";
    }

    function renderAdminFlags(flags) {
      if (!adminFlagsListEl) return;
      const rows = (flags || []).map((flag) => {
        const details = String(flag.details || "").trim();
        const detailsTail = details ? ` | ${details}` : "";
        return `#${flag.id} tg:${flag.telegram_id} ${flag.flag_type} x${flag.seen_count} | ${flag.last_seen_at}${detailsTail}`;
      });
      adminFlagsListEl.textContent = rows.length ? rows.join("\n") : "–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤ –Ω–µ—Ç.";
    }

    function findPlanCodeByDays(days) {
      const targetDays = Number(days);
      if (!Number.isFinite(targetDays) || targetDays <= 0) return "";
      for (const plan of plansCache || []) {
        if (Number(plan.days || 0) === targetDays) {
          return String(plan.code || "");
        }
      }
      return "";
    }

    function refreshQuickRenewButtons() {
      const code7 = findPlanCodeByDays(7);
      const code30 = findPlanCodeByDays(30);
      const code90 = findPlanCodeByDays(90);
      const code365 = findPlanCodeByDays(365);

      if (quickRenew7Btn) quickRenew7Btn.disabled = !code7;
      if (quickRenew30Btn) quickRenew30Btn.disabled = !code30;
      if (quickRenew90Btn) quickRenew90Btn.disabled = !code90;
      if (quickRenew365Btn) quickRenew365Btn.disabled = !code365;
      if (quickRenewLastBtn) {
        quickRenewLastBtn.disabled = !lastPaidPlanCode;
        quickRenewLastBtn.textContent = lastPaidPlanCode
          ? "üîÅ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ—à–ª—ã–π —Ç–∞—Ä–∏—Ñ"
          : "üîÅ –ü—Ä–æ—à–ª—ã–π —Ç–∞—Ä–∏—Ñ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω";
      }
    }

    function updateSelectedUserView() {
      if (!adminSelectedUserEl) return;
      if (!selectedAdminUserId) {
        adminSelectedUserEl.textContent = "–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –Ω–µ—Ç";
        return;
      }
      const user = adminFoundUsers.find((item) => Number(item.telegram_id) === Number(selectedAdminUserId));
      if (!user) {
        adminSelectedUserEl.textContent = `–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ID ${selectedAdminUserId}`;
        return;
      }
      const username = user.username ? "@" + user.username : "-";
      const sub = user.subscription_active
        ? `–∞–∫—Ç–∏–≤–Ω–∞ –¥–æ ${user.subscription_end || "-"}`
        : "–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞";
      adminSelectedUserEl.textContent = `–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.telegram_id} (${username}), –ø–æ–¥–ø–∏—Å–∫–∞ ${sub}`;
    }

    function renderAdminUsers(users) {
      adminFoundUsers = Array.isArray(users) ? users : [];
      if (!adminUserResultsEl) return;
      if (!adminFoundUsers.length) {
        adminUserResultsEl.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.";
        selectedAdminUserId = 0;
        updateSelectedUserView();
        return;
      }

      adminUserResultsEl.innerHTML = "";
      adminFoundUsers.forEach((user) => {
        const username = user.username ? "@" + user.username : "-";
        const sub = user.subscription_active
          ? `–∞–∫—Ç–∏–≤–Ω–∞ –¥–æ ${user.subscription_end || "-"}`
          : "–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞";
        const line = document.createElement("div");
        line.className = "order-row";
        const btn = document.createElement("button");
        btn.className = "ghost";
        btn.textContent = `ID ${user.telegram_id} | ${username} | ${sub}`;
        btn.onclick = () => {
          selectedAdminUserId = Number(user.telegram_id);
          updateSelectedUserView();
          setStatus(`–í—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${selectedAdminUserId}.`, "ok");
        };
        line.appendChild(btn);
        adminUserResultsEl.appendChild(line);
      });
      if (!selectedAdminUserId && adminFoundUsers.length) {
        selectedAdminUserId = Number(adminFoundUsers[0].telegram_id || 0);
      }
      updateSelectedUserView();
    }

    function renderAdminPlans(plans) {
      adminPlansEl.innerHTML = "";
      (plans || []).forEach((plan) => {
        const row = document.createElement("div");
        row.className = "admin-plan";
        row.dataset.code = plan.code || "";
        row.innerHTML = `
          <div class="admin-plan-head">–ö–æ–¥: ${plan.code || "-"}</div>
          <div class="admin-plan-grid">
            <div class="field">
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input class="admin-title" type="text" value="${plan.title || ""}">
            </div>
            <div class="field">
              <label>–î–Ω–µ–π</label>
              <input class="admin-days" type="number" min="1" max="3650" value="${plan.days || 1}">
            </div>
            <div class="field">
              <label>–¶–µ–Ω–∞ (‚ÇΩ)</label>
              <input class="admin-amount" type="number" min="1" max="100000" value="${plan.amount_rub || 1}">
            </div>
            <div class="field">
              <label>–°–∫–∏–¥–∫–∞ –ø–ª–∞–Ω–∞ (%)</label>
              <input class="admin-discount" type="number" min="0" max="90" value="${plan.discount_percent || 0}">
            </div>
          </div>
        `;
        adminPlansEl.appendChild(row);
      });
    }

    function collectAdminPricing() {
      const rows = Array.from(adminPlansEl.querySelectorAll(".admin-plan"));
      const plans = rows.map((row) => ({
        code: String(row.dataset.code || "").trim().toLowerCase(),
        title: String(row.querySelector(".admin-title")?.value || "").trim(),
        days: toInt(row.querySelector(".admin-days")?.value, 1),
        amount_rub: toInt(row.querySelector(".admin-amount")?.value, 1),
        discount_percent: toInt(row.querySelector(".admin-discount")?.value, 0)
      }));

      return {
        global_discount_percent: toInt(adminGlobalDiscountEl.value, 0),
        sale_title: String(adminSaleTitleEl.value || "").trim(),
        sale_message: String(adminSaleMessageEl.value || "").trim(),
        plans
      };
    }

    function applyAdminPricing(pricing) {
      adminGlobalDiscountEl.value = pricing.global_discount_percent ?? 0;
      adminSaleTitleEl.value = pricing.sale_title || "";
      adminSaleMessageEl.value = pricing.sale_message || "";
      renderAdminPlans(pricing.plans || []);
    }

    async function loadAdminPanel() {
      if (!isAdmin) return;
      const data = await requestJson("/webapp/api/admin/pricing", "POST", { init_data: initData });
      applyAdminPricing(data.pricing || {});
      await Promise.all([
        loadAdminPromocodes(),
        loadAdminRuntimeState(),
        loadAdminFlags(),
      ]);
      adminLoaded = true;
    }

    async function saveAdminPricing() {
      if (!isAdmin) return;
      const pricing = collectAdminPricing();
      const data = await requestJson("/webapp/api/admin/save-pricing", "POST", {
        init_data: initData,
        pricing
      });
      applyAdminPricing(data.pricing || {});
      await loadPlans();
      setStatus("–¶–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.", "ok");
    }

    async function adminNotify() {
      if (!isAdmin) return;
      const text = String(adminBroadcastTextEl.value || "").trim();
      const data = await requestJson("/webapp/api/admin/notify", "POST", {
        init_data: initData,
        text
      });
      setStatus(`–†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: ${data.sent}, –æ—à–∏–±–æ–∫: ${data.failed}.`, "ok");
      adminBroadcastTextEl.value = "";
    }

    async function loadAdminRuntimeState() {
      if (!isAdmin) return;
      const data = await requestJson("/webapp/api/admin/runtime-state", "POST", {
        init_data: initData
      });
      renderAdminRuntimeState(data);
    }

    async function adminToggleUpdateMode() {
      if (!isAdmin) return;
      const nextMode = adminUpdateMode === "manual" ? "auto" : "manual";
      const data = await requestJson("/webapp/api/admin/set-update-mode", "POST", {
        init_data: initData,
        mode: nextMode
      });
      renderAdminRuntimeState(data);
      const modeLabel = adminUpdateMode === "manual" ? "—Ä—É—á–Ω–æ–π" : "–∞–≤—Ç–æ";
      setStatus(`–†–µ–∂–∏–º update-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: ${modeLabel}.`, "ok");
    }

    async function adminSendUpdateNotice() {
      if (!isAdmin) return;
      const data = await requestJson("/webapp/api/admin/send-update-notice", "POST", {
        init_data: initData
      });
      setStatus(
        `Update-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${data.sent}, –æ—à–∏–±–æ–∫: ${data.failed}.`,
        "ok"
      );
    }

    async function adminToggleMaintenance() {
      if (!isAdmin) return;
      const data = await requestJson("/webapp/api/admin/set-maintenance", "POST", {
        init_data: initData,
        enabled: !adminMaintenanceEnabled
      });
      renderAdminRuntimeState(data);
      const prefix = adminMaintenanceEnabled
        ? "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã –≤–∫–ª—é—á–µ–Ω—ã."
        : "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã –≤—ã–∫–ª—é—á–µ–Ω—ã.";
      setStatus(`${prefix} –£–≤–µ–¥–æ–º–ª–µ–Ω–æ: ${data.sent}, –æ—à–∏–±–æ–∫: ${data.failed}.`, "ok");
    }

    async function loadAdminPromocodes() {
      if (!isAdmin) return;
      const data = await requestJson("/webapp/api/admin/promocodes", "POST", { init_data: initData });
      renderAdminPromocodes(data.promocodes || []);
    }

    async function loadAdminFlags() {
      if (!isAdmin) return;
      const data = await requestJson("/webapp/api/admin/flags", "POST", {
        init_data: initData,
        unresolved_only: true,
        limit: 50,
      });
      renderAdminFlags(data.flags || []);
    }

    async function resolveAdminFlag() {
      if (!isAdmin) return;
      const flagId = Number.parseInt(String(adminResolveFlagIdEl?.value || ""), 10);
      if (!Number.isFinite(flagId) || flagId <= 0) {
        setStatus("–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID —Ñ–ª–∞–≥–∞.", "err");
        return;
      }
      const data = await requestJson("/webapp/api/admin/resolve-flag", "POST", {
        init_data: initData,
        flag_id: flagId,
      });
      renderAdminFlags(data.flags || []);
      if (adminResolveFlagIdEl) adminResolveFlagIdEl.value = "";
      setStatus(`–§–ª–∞–≥ #${flagId} –ø–æ–º–µ—á–µ–Ω –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º.`, "ok");
    }

    async function saveAdminPromocode() {
      if (!isAdmin) return;
      const payload = {
        init_data: initData,
        code: String(adminPromoCodeEl.value || "").trim(),
        discount_rub: toInt(adminPromoDiscountEl.value, 0),
        expires_at: String(adminPromoExpiresEl.value || "").trim(),
        max_activations: toInt(adminPromoMaxActivationsEl.value, 0)
      };
      const data = await requestJson("/webapp/api/admin/create-promocode", "POST", payload);
      renderAdminPromocodes(data.promocodes || []);
      setStatus("–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω.", "ok");
    }

    async function adminFindUsers() {
      if (!isAdmin) return;
      const query = String(adminUserQueryEl.value || "").trim();
      if (!query) {
        setStatus("–í–≤–µ–¥–∏—Ç–µ username –∏–ª–∏ Telegram ID.", "err");
        return;
      }
      const data = await requestJson("/webapp/api/admin/find-user", "POST", {
        init_data: initData,
        query
      });
      renderAdminUsers(data.users || []);
      setStatus(`–ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${(data.users || []).length}.`, "ok");
    }

    async function adminGrantSubscription() {
      if (!isAdmin) return;
      const telegramId = Number(selectedAdminUserId || 0);
      if (!telegramId) {
        setStatus("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.", "err");
        return;
      }
      const days = toInt(adminGrantDaysEl.value, 0);
      if (days <= 0) {
        setStatus("–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π.", "err");
        return;
      }
      const data = await requestJson("/webapp/api/admin/grant-subscription", "POST", {
        init_data: initData,
        telegram_id: telegramId,
        days
      });
      setStatus(`–ü–æ–¥–ø–∏—Å–∫–∞ –≤—ã–¥–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${telegramId}.`, "ok");
      if (data.user) {
        renderAdminUsers([data.user]);
      }
    }

    async function adminRemoveSubscription() {
      if (!isAdmin) return;
      const telegramId = Number(selectedAdminUserId || 0);
      if (!telegramId) {
        setStatus("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.", "err");
        return;
      }
      const data = await requestJson("/webapp/api/admin/remove-subscription", "POST", {
        init_data: initData,
        telegram_id: telegramId
      });
      setStatus(`–ü–æ–¥–ø–∏—Å–∫–∞ —É–¥–∞–ª–µ–Ω–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${telegramId}.`, "ok");
      if (data.user) {
        renderAdminUsers([data.user]);
      }
    }

    async function activatePromocode() {
      if (!initData) {
        setStatus("–û—Ç–∫—Ä–æ–π—Ç–µ Mini App —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞.", "err");
        return;
      }
      const promoCode = String(promoCodeInputEl.value || "").trim();
      if (!promoCode) {
        setStatus("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥.", "err");
        return;
      }
      try {
        await requestJson("/webapp/api/activate-promocode", "POST", {
          init_data: initData,
          promo_code: promoCode
        });
        promoCodeInputEl.value = "";
        await loadProfile();
        setStatus("–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.", "ok");
      } catch (err) {
        setStatus(promoErrorText(err.message), "err");
      }
    }

    function renderPlans(plans, paymentEnabled, providerLabel) {
      plansCache = Array.isArray(plans) ? plans.slice() : [];
      refreshQuickRenewButtons();
      plansEl.innerHTML = "";
      if (!paymentEnabled) {
        const muted = document.createElement("div");
        muted.className = "small";
        muted.textContent = "–û–ø–ª–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞: –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.";
        plansEl.appendChild(muted);
        return;
      }

      plans.forEach((plan) => {
        const item = document.createElement("div");
        item.className = "plan";
        const discountLine = (plan.discount_percent > 0 && plan.base_amount_rub > plan.amount_rub)
          ? `<p>–°–∫–∏–¥–∫–∞: -${plan.discount_percent}% (–±—ã–ª–æ ${plan.base_amount_rub} ‚ÇΩ)</p>`
          : "";
        item.innerHTML = `
          <div>
            <h3>${plan.title} ‚Ä¢ ${plan.amount_rub} ‚ÇΩ</h3>
            <p>${plan.days} –¥–Ω–µ–π –¥–æ—Å—Ç—É–ø–∞</p>
            ${discountLine}
          </div>
        `;
        const btn = document.createElement("button");
        btn.textContent = "–û–ø–ª–∞—Ç–∏—Ç—å";
        btn.onclick = () => createOrder(plan.code);
        item.appendChild(btn);
        plansEl.appendChild(item);
      });

      if (providerLabel) {
        const note = document.createElement("div");
        note.className = "small";
        note.style.marginTop = "8px";
        note.textContent = `–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑: ${providerLabel}`;
        plansEl.appendChild(note);
      }
    }

    function clearOrder() {
      currentOrderId = "";
      currentPaymentUrl = "";
      currentDonatePayUrl = "";
      currentCryptobotPaymentUrl = "";
      currentCryptobotPaymentLabel = "CryptoBot";
      currentLztPaymentUrl = "";
      currentLztPaymentLabel = "LZT Market";
      currentSecondaryPaymentUrl = "";
      currentSecondaryPaymentLabel = "–†–µ–∑–µ—Ä–≤–Ω–∞—è –æ–ø–ª–∞—Ç–∞";
      currentOrderStatus = "pending";
      orderCardEl.classList.add("hidden");
      orderCardEl.classList.add("tab-hidden");
      syncOrderTabVisibility();
      orderInfoEl.textContent = "";
      orderCodeEl.textContent = "";
      ensureValidTab(resolveTabFromQuery() || "plansCard");
    }

    function updateOrderActionButtons() {
      const isCancelled = String(currentOrderStatus || "").toLowerCase() === "cancelled";
      if (repeatBtn) repeatBtn.classList.toggle("hidden", !isCancelled);
      if (payBtn) {
        const hasDonatePay = !!String(currentDonatePayUrl || "").trim();
        payBtn.classList.toggle("hidden", !hasDonatePay);
        payBtn.disabled = isCancelled || !hasDonatePay;
        if (hasDonatePay) {
          payBtn.textContent = "üí∏ DonatePay";
        }
      }
      if (cryptoPayBtn) {
        const hasCrypto = !!String(currentCryptobotPaymentUrl || "").trim();
        cryptoPayBtn.classList.toggle("hidden", !hasCrypto);
        cryptoPayBtn.disabled = isCancelled || !hasCrypto;
        if (hasCrypto) {
          cryptoPayBtn.textContent = `‚Çø ${currentCryptobotPaymentLabel}`;
        }
      }
      if (lztPayBtn) {
        const hasLzt = !!String(currentLztPaymentUrl || "").trim();
        lztPayBtn.classList.toggle("hidden", !hasLzt);
        lztPayBtn.disabled = isCancelled || !hasLzt;
        if (hasLzt) {
          lztPayBtn.textContent = `‚ö° ${currentLztPaymentLabel}`;
        }
      }
      if (secondaryPayBtn) {
        const hasSecondary = !!String(currentSecondaryPaymentUrl || "").trim();
        secondaryPayBtn.classList.toggle("hidden", !hasSecondary);
        secondaryPayBtn.disabled = isCancelled || !hasSecondary;
        if (hasSecondary) {
          secondaryPayBtn.textContent = `ü™ô ${currentSecondaryPaymentLabel}`;
        }
      }
      if (cancelBtn) cancelBtn.disabled = isCancelled;
    }

    function showOrder(orderId, paymentUrl, plan, expiresAt) {
      currentOrderId = orderId;
      currentPaymentUrl = paymentUrl || "";
      currentDonatePayUrl = String(plan.donatepay_payment_url || "").trim();
      if (!currentDonatePayUrl && String(plan.provider || "").trim().toLowerCase() === "donatepay") {
        currentDonatePayUrl = String(paymentUrl || "").trim();
      }
      currentCryptobotPaymentUrl = String(plan.cryptobot_payment_url || "").trim();
      currentCryptobotPaymentLabel = String(plan.cryptobot_payment_label || "CryptoBot").trim();
      currentLztPaymentUrl = String(plan.lzt_payment_url || "").trim();
      currentLztPaymentLabel = String(plan.lzt_payment_label || "LZT Market").trim();
      currentSecondaryPaymentUrl = String(plan.secondary_payment_url || "").trim();
      currentSecondaryPaymentLabel = String(plan.secondary_payment_label || "–†–µ–∑–µ—Ä–≤–Ω–∞—è –æ–ø–ª–∞—Ç–∞").trim();
      currentOrderStatus = "pending";
      currentOrderProviderLabel = String(plan.provider_label || paymentProviderLabel || "–ø–ª–∞—Ç–µ–∂–Ω—ã–π —Å–µ—Ä–≤–∏—Å");
      orderCardEl.classList.remove("hidden");
      syncOrderTabVisibility();
      switchTab("orderCard");
      const baseAmount = Number(plan.base_amount_rub || plan.amount_rub || 0);
      const amount = Number(plan.amount_rub || 0);
      const tariffDiscountTail = (plan.discount_percent > 0 && baseAmount > amount)
        ? `, —Å–∫–∏–¥–∫–∞ —Ç–∞—Ä–∏—Ñ–∞: -${plan.discount_percent}% (–±—ã–ª–æ ${baseAmount} ‚ÇΩ)`
        : "";
      const promoCode = String((plan.promo && plan.promo.code) || plan.promo_code || "").trim();
      const promoDiscount = Number((plan.promo && plan.promo.discount_rub) || plan.promo_discount_rub || 0);
      const promoTail = promoCode && promoDiscount > 0
        ? `, –ø—Ä–æ–º–æ–∫–æ–¥ ${promoCode}: -${promoDiscount} ‚ÇΩ`
        : "";
      const expiresTail = expiresAt ? `, –∏—Å—Ç–µ–∫–∞–µ—Ç: ${expiresAt}` : "";
      const providerTail = currentOrderProviderLabel ? `, —Å–µ—Ä–≤–∏—Å: ${currentOrderProviderLabel}` : "";
      orderInfoEl.textContent = `–¢–∞—Ä–∏—Ñ: ${plan.title}, —Å—É–º–º–∞: ${amount} ‚ÇΩ${tariffDiscountTail}${promoTail}${providerTail}${expiresTail}`;
      orderCodeEl.textContent = orderId;
      updateOrderActionButtons();
      const hasDonatePay = !!String(currentDonatePayUrl || "").trim();
      const hasCrypto = !!String(currentCryptobotPaymentUrl || "").trim();
      const hasLzt = !!String(currentLztPaymentUrl || "").trim();
      const hasSecondary = !!String(currentSecondaryPaymentUrl || "").trim();
      if (hasDonatePay && hasCrypto && hasLzt) {
        setStatus("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: DonatePay, CryptoBot –∏–ª–∏ LZT Market.", "ok");
      } else if (hasDonatePay && hasCrypto) {
        setStatus("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: DonatePay –∏–ª–∏ CryptoBot.", "ok");
      } else if (hasDonatePay && hasLzt) {
        setStatus("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: DonatePay –∏–ª–∏ LZT Market.", "ok");
      } else if (hasCrypto && hasLzt) {
        setStatus("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: CryptoBot –∏–ª–∏ LZT Market.", "ok");
      } else if (hasDonatePay) {
        setStatus("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –î–æ—Å—Ç—É–ø–Ω–∞ –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ DonatePay.", "ok");
      } else if (hasCrypto) {
        setStatus("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –î–æ—Å—Ç—É–ø–Ω–∞ –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ CryptoBot.", "ok");
      } else if (hasLzt) {
        setStatus("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –î–æ—Å—Ç—É–ø–Ω–∞ –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ LZT Market.", "ok");
      } else if (hasSecondary) {
        setStatus(`–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –î–æ—Å—Ç—É–ø–Ω–∞ –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ ${currentSecondaryPaymentLabel}.`, "ok");
      } else {
        setStatus("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω, –Ω–æ —Å—Å—ã–ª–∫–∞ –æ–ø–ª–∞—Ç—ã —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑.", "err");
      }
      maybeAutoOpenPayment();
    }

    function stopAutoStatusPolling() {
      if (autoStatusTimer) {
        clearInterval(autoStatusTimer);
        autoStatusTimer = null;
      }
    }

    function startAutoStatusPolling() {
      stopAutoStatusPolling();
      if (!currentOrderId) return;
      autoStatusTimer = setInterval(() => {
        checkOrderStatus(true);
      }, 10000);
    }

    async function loadPlans() {
      const data = await requestJson("/webapp/api/plans", "GET");
      paymentProvider = String(data.payment_provider || "donatepay");
      paymentProviderLabel = String(data.payment_provider_label || "DonatePay");
      renderPlans(data.plans || [], data.payment_enabled, paymentProviderLabel);
    }

    async function loadProfile() {
      if (!initData) {
        if (orderIdFromQueryValid) {
          const successUrl = `/pay/success?order_id=${encodeURIComponent(orderIdFromQuery)}&src=webapp`;
          profileEl.textContent = "–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ Telegram –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã...";
          setStatus("–í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ Telegram...", "ok");
          setTimeout(() => {
            window.location.href = successUrl;
          }, 250);
          return;
        }
        profileEl.textContent = "–û—Ç–∫—Ä–æ–π—Ç–µ Mini App –∫–Ω–æ–ø–∫–æ–π ¬´üß© Mini App¬ª –≤ Telegram-—á–∞—Ç–µ —Å –±–æ—Ç–æ–º.";
        setStatus("initData –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ¬´üß© Mini App¬ª –≤ Telegram.", "err");
        return;
      }

      const me = await requestJson("/webapp/api/me", "POST", { init_data: initData });
      const sub = me.subscription || {};
      const subText = sub.active ? ("–∞–∫—Ç–∏–≤–Ω–∞ –¥–æ " + (sub.subscription_end || "-")) : "–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞";
      const adminText = me.user && me.user.is_admin ? " | –†–æ–ª—å: –∞–¥–º–∏–Ω" : "";
      profileEl.textContent = `ID: ${me.user.id} | –ü–æ–¥–ø–∏—Å–∫–∞: ${subText}${adminText}`;
      if (me.active_promo && me.active_promo.code) {
        activePromoEl.textContent = `–ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥: ${me.active_promo.code} (-${me.active_promo.discount_rub} ‚ÇΩ, –¥–æ ${me.active_promo.expires_at})`;
      } else {
        activePromoEl.textContent = "–ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥: –Ω–µ—Ç";
      }
      lastPaidPlanCode = me.last_paid_plan && me.last_paid_plan.code
        ? String(me.last_paid_plan.code)
        : "";
      refreshQuickRenewButtons();

      isAdmin = !!(me.user && me.user.is_admin);
      setAdminVisible(isAdmin);
      if (isAdmin && !adminLoaded) {
        await loadAdminPanel();
      }

      if (me.pending_order) {
        showOrder(
          me.pending_order.order_id,
          me.pending_order.payment_url || "",
          {
            title: me.pending_order.days + " –¥–Ω–µ–π",
            amount_rub: me.pending_order.amount_rub,
            base_amount_rub: me.pending_order.base_amount_rub,
            donatepay_payment_url: me.pending_order.donatepay_payment_url || "",
            provider: me.pending_order.provider || "",
            provider_label: me.pending_order.provider_label || paymentProviderLabel,
            promo_code: me.pending_order.promo_code,
            promo_discount_rub: me.pending_order.promo_discount_rub,
            cryptobot_payment_url: me.pending_order.cryptobot_payment_url || "",
            cryptobot_payment_label: me.pending_order.cryptobot_payment_label || "CryptoBot",
            lzt_payment_url: me.pending_order.lzt_payment_url || "",
            lzt_payment_label: me.pending_order.lzt_payment_label || "LZT Market",
            secondary_payment_url: me.pending_order.secondary_payment_url || "",
            secondary_payment_label: me.pending_order.secondary_payment_label || "–†–µ–∑–µ—Ä–≤–Ω–∞—è –æ–ø–ª–∞—Ç–∞",
          },
          me.pending_order.expires_at || ""
        );
        startAutoStatusPolling();
        setStatus("–ù–∞–π–¥–µ–Ω –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–ª–∞—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.", "ok");
      } else {
        stopAutoStatusPolling();
        clearOrder();
        setStatus("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑.", "ok");
      }
    }

    async function createOrderByDays(days) {
      const code = findPlanCodeByDays(days);
      if (!code) {
        setStatus(`–¢–∞—Ä–∏—Ñ –Ω–∞ ${days} –¥–Ω–µ–π —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.`, "err");
        return;
      }
      await createOrder(code);
    }

    async function createLastPaidOrder() {
      if (!lastPaidPlanCode) {
        setStatus("–ù–µ—Ç –ø—Ä–æ—à–ª–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞.", "err");
        return;
      }
      await createOrder(lastPaidPlanCode);
    }

    async function createOrder(planCode) {
      if (!initData) {
        setStatus("–û—Ç–∫—Ä–æ–π—Ç–µ Mini App —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞.", "err");
        return;
      }
      try {
        const data = await requestJson("/webapp/api/create-order", "POST", {
          init_data: initData,
          plan_code: planCode
        });
        const orderPlan = Object.assign({}, data.plan || {}, {
          donatepay_payment_url: data.donatepay_payment_url || "",
          provider: data.payment_provider || "",
          provider_label: data.payment_provider_label || paymentProviderLabel,
          cryptobot_payment_url: data.cryptobot_payment_url || "",
          cryptobot_payment_label: data.cryptobot_payment_label || "CryptoBot",
          lzt_payment_url: data.lzt_payment_url || "",
          lzt_payment_label: data.lzt_payment_label || "LZT Market",
          secondary_payment_url: data.secondary_payment_url || "",
          secondary_payment_label: data.secondary_payment_label || "–†–µ–∑–µ—Ä–≤–Ω–∞—è –æ–ø–ª–∞—Ç–∞",
        });
        showOrder(data.order_id, data.payment_url, orderPlan, data.expires_at || "");
        startAutoStatusPolling();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞: " + err.message, "err");
      }
    }

    async function checkOrderStatus(silent = false) {
      if (!currentOrderId) {
        if (!silent) setStatus("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑.", "err");
        return;
      }
      try {
        const data = await requestJson("/webapp/api/order-status", "POST", {
          init_data: initData,
          order_id: currentOrderId
        });
        currentDonatePayUrl = String((data.order && data.order.donatepay_payment_url) || "").trim();
        if (!currentDonatePayUrl && String((data.order && data.order.provider) || "").toLowerCase() === "donatepay") {
          currentDonatePayUrl = String((data.order && data.order.payment_url) || currentPaymentUrl || "").trim();
        }
        currentPaymentUrl = String((data.order && data.order.payment_url) || currentPaymentUrl || "").trim();
        currentCryptobotPaymentUrl = String((data.order && data.order.cryptobot_payment_url) || "").trim();
        currentCryptobotPaymentLabel = String(
          (data.order && data.order.cryptobot_payment_label) || "CryptoBot"
        ).trim();
        currentLztPaymentUrl = String((data.order && data.order.lzt_payment_url) || "").trim();
        currentLztPaymentLabel = String(
          (data.order && data.order.lzt_payment_label) || "LZT Market"
        ).trim();
        currentSecondaryPaymentUrl = String((data.order && data.order.secondary_payment_url) || "").trim();
        currentSecondaryPaymentLabel = String(
          (data.order && data.order.secondary_payment_label) || "–†–µ–∑–µ—Ä–≤–Ω–∞—è –æ–ø–ª–∞—Ç–∞"
        ).trim();
        if (data.order.status === "paid") {
          stopAutoStatusPolling();
          currentOrderStatus = "paid";
          updateOrderActionButtons();
          setStatus("–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ ‚úÖ", "ok");
          await loadProfile();
          return;
        }
        if (data.order.status === "cancelled") {
          stopAutoStatusPolling();
          currentOrderStatus = "cancelled";
          updateOrderActionButtons();
          if (!silent) {
            setStatus("–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω –∏–ª–∏ –∏—Å—Ç–µ–∫. –ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑¬ª.", "err");
          }
          return;
        }
        currentOrderStatus = "pending";
        updateOrderActionButtons();
        if (!silent) {
          const expiresAt = data.order.expires_at || "";
          const tail = expiresAt ? ` –ó–∞–∫–∞–∑ –∏—Å—Ç–µ–∫–∞–µ—Ç: ${expiresAt}.` : "";
          setStatus("–ü–ª–∞—Ç–µ–∂ –ø–æ–∫–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω." + tail, "err");
        } else {
          setStatus("–ü–ª–∞—Ç–µ–∂ –ø–æ–∫–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω. –ò–¥–µ—Ç –∞–≤—Ç–æ-–ø—Ä–æ–≤–µ—Ä–∫–∞...", "ok");
        }
      } catch (err) {
        if (!silent) setStatus("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã: " + err.message, "err");
      }
    }

    async function cancelOrder() {
      if (!currentOrderId) {
        setStatus("–ù–µ—Ç –∑–∞–∫–∞–∑–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã.", "err");
        return;
      }
      try {
        await requestJson("/webapp/api/cancel-order", "POST", {
          init_data: initData,
          order_id: currentOrderId
        });
        stopAutoStatusPolling();
        currentOrderStatus = "cancelled";
        updateOrderActionButtons();
        setStatus("–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω. –ú–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å ¬´–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑¬ª.", "ok");
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞: " + err.message, "err");
      }
    }

    async function repeatOrder() {
      if (!currentOrderId) {
        setStatus("–ù–µ—Ç –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞.", "err");
        return;
      }
      try {
        const data = await requestJson("/webapp/api/repeat-order", "POST", {
          init_data: initData,
          source_order_id: currentOrderId,
        });
        const orderPlan = Object.assign({}, data.plan || {}, {
          donatepay_payment_url: data.donatepay_payment_url || "",
          provider: data.payment_provider || "",
          provider_label: data.payment_provider_label || paymentProviderLabel,
          cryptobot_payment_url: data.cryptobot_payment_url || "",
          cryptobot_payment_label: data.cryptobot_payment_label || "CryptoBot",
          lzt_payment_url: data.lzt_payment_url || "",
          lzt_payment_label: data.lzt_payment_label || "LZT Market",
          secondary_payment_url: data.secondary_payment_url || "",
          secondary_payment_label: data.secondary_payment_label || "–†–µ–∑–µ—Ä–≤–Ω–∞—è –æ–ø–ª–∞—Ç–∞",
        });
        showOrder(data.order_id, data.payment_url || "", orderPlan, data.expires_at || "");
        startAutoStatusPolling();
        if (data.plan_replaced) {
          setStatus("–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–∞—Ä–∏—Ñ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –≤—ã–±—Ä–∞–Ω –±–ª–∏–∂–∞–π—à–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞—Ä–∏—Ñ.", "ok");
        }
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–∞ –∑–∞–∫–∞–∑–∞: " + err.message, "err");
      }
    }

    function openPaymentLink() {
      const donatepayUrl = String(currentDonatePayUrl || "").trim();
      if (!donatepayUrl) {
        if (currentCryptobotPaymentUrl) {
          openCryptoPaymentLink();
          return;
        }
        if (currentLztPaymentUrl) {
          openLztPaymentLink();
          return;
        }
        if (currentSecondaryPaymentUrl) {
          openSecondaryPaymentLink();
          return;
        }
        setStatus("–°—Å—ã–ª–∫–∞ –æ–ø–ª–∞—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑.", "err");
        return;
      }
      if (currentOrderId && navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(currentOrderId).catch(() => {});
      }
      if (tg && tg.openLink) {
        tg.openLink(donatepayUrl, { try_instant_view: false });
      } else {
        window.location.href = donatepayUrl;
      }
    }

    function openCryptoPaymentLink() {
      if (!currentCryptobotPaymentUrl) {
        setStatus("–°—Å—ã–ª–∫–∞ CryptoBot –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.", "err");
        return;
      }
      if (currentOrderId && navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(currentOrderId).catch(() => {});
      }
      if (tg && tg.openLink) {
        tg.openLink(currentCryptobotPaymentUrl, { try_instant_view: false });
      } else {
        window.location.href = currentCryptobotPaymentUrl;
      }
    }

    function openLztPaymentLink() {
      if (!currentLztPaymentUrl) {
        setStatus("–°—Å—ã–ª–∫–∞ LZT Market –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.", "err");
        return;
      }
      if (currentOrderId && navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(currentOrderId).catch(() => {});
      }
      if (tg && tg.openLink) {
        tg.openLink(currentLztPaymentUrl, { try_instant_view: false });
      } else {
        window.location.href = currentLztPaymentUrl;
      }
    }

    function openSecondaryPaymentLink() {
      if (!currentSecondaryPaymentUrl) {
        setStatus("–†–µ–∑–µ—Ä–≤–Ω–∞—è —Å—Å—ã–ª–∫–∞ –æ–ø–ª–∞—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.", "err");
        return;
      }
      if (currentOrderId && navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(currentOrderId).catch(() => {});
      }
      if (tg && tg.openLink) {
        tg.openLink(currentSecondaryPaymentUrl, { try_instant_view: false });
      } else {
        window.location.href = currentSecondaryPaymentUrl;
      }
    }

    function maybeAutoOpenPayment() {
      return;
    }

    tabButtons.forEach((btn) => {
      btn.onclick = () => {
        switchTab(btn.dataset.tabTarget || "");
      };
    });

    syncOrderTabVisibility();
    ensureValidTab(resolveTabFromQuery() || "accountCard");

    payBtn.onclick = () => {
      openPaymentLink();
    };
    cryptoPayBtn.onclick = () => {
      openCryptoPaymentLink();
    };
    lztPayBtn.onclick = () => {
      openLztPaymentLink();
    };
    secondaryPayBtn.onclick = () => {
      openSecondaryPaymentLink();
    };

    checkBtn.onclick = () => checkOrderStatus(false);
    cancelBtn.onclick = cancelOrder;
    promoActivateBtn.onclick = async () => {
      await activatePromocode();
    };
    quickRenew7Btn.onclick = async () => {
      await createOrderByDays(7);
    };
    quickRenew30Btn.onclick = async () => {
      await createOrderByDays(30);
    };
    quickRenew90Btn.onclick = async () => {
      await createOrderByDays(90);
    };
    quickRenew365Btn.onclick = async () => {
      await createOrderByDays(365);
    };
    quickRenewLastBtn.onclick = async () => {
      await createLastPaidOrder();
    };
    repeatBtn.onclick = repeatOrder;
    adminSaveBtn.onclick = async () => {
      try {
        await saveAdminPricing();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–µ–Ω: " + err.message, "err");
      }
    };
    adminReloadBtn.onclick = async () => {
      try {
        await loadAdminPanel();
        setStatus("–ö–æ–Ω—Ñ–∏–≥ –æ–±–Ω–æ–≤–ª–µ–Ω.", "ok");
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞: " + err.message, "err");
      }
    };
    adminSendBroadcastBtn.onclick = async () => {
      try {
        await adminNotify();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏: " + err.message, "err");
      }
    };
    adminRuntimeReloadBtn.onclick = async () => {
      try {
        await loadAdminRuntimeState();
        setStatus("–°—Ç–∞—Ç—É—Å—ã —Ä–µ–∂–∏–º–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.", "ok");
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤: " + err.message, "err");
      }
    };
    adminToggleUpdateModeBtn.onclick = async () => {
      try {
        await adminToggleUpdateMode();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ update: " + err.message, "err");
      }
    };
    adminSendUpdateNoticeBtn.onclick = async () => {
      try {
        await adminSendUpdateNotice();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ update-—Ä–∞—Å—Å—ã–ª–∫–∏: " + err.message, "err");
      }
    };
    adminToggleMaintenanceBtn.onclick = async () => {
      try {
        await adminToggleMaintenance();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ—Ö—Ä–∞–±–æ—Ç: " + err.message, "err");
      }
    };
    adminFlagsReloadBtn.onclick = async () => {
      try {
        await loadAdminFlags();
        setStatus("–ê–Ω—Ç–∏—Ñ—Ä–æ–¥-—Ñ–ª–∞–≥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.", "ok");
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–ª–∞–≥–æ–≤: " + err.message, "err");
      }
    };
    adminResolveFlagBtn.onclick = async () => {
      try {
        await resolveAdminFlag();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Ñ–ª–∞–≥–∞: " + err.message, "err");
      }
    };
    adminPromoSaveBtn.onclick = async () => {
      try {
        await saveAdminPromocode();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞: " + promoErrorText(err.message), "err");
      }
    };
    adminPromoReloadBtn.onclick = async () => {
      try {
        await loadAdminPromocodes();
        setStatus("–°–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω.", "ok");
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤: " + err.message, "err");
      }
    };
    adminUserSearchBtn.onclick = async () => {
      try {
        await adminFindUsers();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: " + err.message, "err");
      }
    };
    adminGrantBtn.onclick = async () => {
      try {
        await adminGrantSubscription();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏ –ø–æ–¥–ø–∏—Å–∫–∏: " + err.message, "err");
      }
    };
    adminRemoveSubBtn.onclick = async () => {
      try {
        await adminRemoveSubscription();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏: " + err.message, "err");
      }
    };

    copyBtn.onclick = async () => {
      if (!currentOrderId) {
        setStatus("–ù–µ—Ç –∫–æ–¥–∞ –∑–∞–∫–∞–∑–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.", "err");
        return;
      }
      try {
        await navigator.clipboard.writeText(currentOrderId);
        setStatus("–ö–æ–¥ –∑–∞–∫–∞–∑–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω.", "ok");
      } catch (_) {
        setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.", "err");
      }
    };

    (async () => {
      try {
        await loadPlans();
        await loadProfile();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + err.message, "err");
      }
    })();
  </script>
</body>
</html>
