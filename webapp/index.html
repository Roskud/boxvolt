<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BoxVolt Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --card: #172240;
      --text: #f8fafc;
      --muted: #9aa8bd;
      --accent: #2dd4bf;
      --accent-2: #38bdf8;
      --danger: #f87171;
      --ok: #34d399;
      --border: #2a3a63;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(circle at top, #1a2950 0%, var(--bg) 45%);
      color: var(--text);
      min-height: 100vh;
    }
    .wrap {
      max-width: 720px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }
    .title {
      font-size: 24px;
      font-weight: 700;
      margin: 4px 0 6px;
    }
    .subtitle {
      margin: 0 0 14px;
      color: var(--muted);
      font-size: 14px;
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      margin-bottom: 12px;
    }
    .status {
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 12px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,0.03);
    }
    .status.ok { border-color: rgba(52,211,153,.35); color: var(--ok); }
    .status.err { border-color: rgba(248,113,113,.35); color: var(--danger); }
    .plans {
      display: grid;
      gap: 10px;
    }
    .plan {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: rgba(8, 14, 30, 0.35);
    }
    .plan h3 {
      margin: 0 0 4px;
      font-size: 16px;
    }
    .plan p {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
    }
    button {
      border: 0;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      color: #031826;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      padding: 10px 12px;
      min-width: 118px;
    }
    button.ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    .order-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      word-break: break-all;
      color: #c5d6ea;
      background: rgba(0,0,0,.25);
      border-radius: 8px;
      padding: 8px;
      margin-top: 8px;
      border: 1px solid rgba(255,255,255,.07);
    }
    .hidden { display: none; }
    .small { font-size: 12px; color: var(--muted); }
  </style>
</head>
<body>
  <main class="wrap">
    <h1 class="title">‚ö° BoxVolt Mini App</h1>
    <p class="subtitle">–ü–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã –≤ –æ–¥–Ω–æ–º –æ–∫–Ω–µ Telegram</p>

    <div id="status" class="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <section class="card">
      <strong>–ê–∫–∫–∞—É–Ω—Ç</strong>
      <div id="profile" class="small" style="margin-top:8px;">–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ...</div>
    </section>

    <section class="card">
      <strong>–¢–∞—Ä–∏—Ñ—ã</strong>
      <div id="plans" class="plans" style="margin-top:10px;"></div>
    </section>

    <section id="orderCard" class="card hidden">
      <strong>–¢–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑</strong>
      <div id="orderInfo" class="small" style="margin-top:8px;"></div>
      <div id="orderCode" class="mono"></div>
      <div class="order-row">
        <button id="payBtn">üí∏ –û–ø–ª–∞—Ç–∏—Ç—å</button>
        <button id="checkBtn" class="ghost">‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É</button>
        <button id="copyBtn" class="ghost">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
      </div>
      <p class="small" style="margin-top:10px;">–î–æ–±–∞–≤—å—Ç–µ –∫–æ–¥ –∑–∞–∫–∞–∑–∞ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –¥–æ–Ω–∞—Ç—É.</p>
    </section>
  </main>

  <script>
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
      tg.ready();
      tg.expand();
    }

    const initData = tg ? tg.initData : "";
    let currentOrderId = "";
    let currentPaymentUrl = "";

    const statusEl = document.getElementById("status");
    const profileEl = document.getElementById("profile");
    const plansEl = document.getElementById("plans");
    const orderCardEl = document.getElementById("orderCard");
    const orderInfoEl = document.getElementById("orderInfo");
    const orderCodeEl = document.getElementById("orderCode");
    const payBtn = document.getElementById("payBtn");
    const checkBtn = document.getElementById("checkBtn");
    const copyBtn = document.getElementById("copyBtn");

    function setStatus(text, kind) {
      statusEl.textContent = text;
      statusEl.className = "status";
      if (kind === "ok") statusEl.classList.add("ok");
      if (kind === "err") statusEl.classList.add("err");
    }

    async function requestJson(url, method, payload) {
      const options = { method, headers: { "Content-Type": "application/json" } };
      if (payload) options.body = JSON.stringify(payload);
      const res = await fetch(url, options);
      let data = {};
      try {
        data = await res.json();
      } catch (_) {
        throw new Error("bad_json_response");
      }
      if (!res.ok || data.ok === false) {
        throw new Error(data.error || ("http_" + res.status));
      }
      return data;
    }

    function renderPlans(plans, paymentEnabled) {
      plansEl.innerHTML = "";
      if (!paymentEnabled) {
        const muted = document.createElement("div");
        muted.className = "small";
        muted.textContent = "–û–ø–ª–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞: –∞–¥–º–∏–Ω –Ω–µ –∑–∞–ø–æ–ª–Ω–∏–ª DonationAlerts.";
        plansEl.appendChild(muted);
        return;
      }

      plans.forEach((plan) => {
        const item = document.createElement("div");
        item.className = "plan";
        item.innerHTML = `
          <div>
            <h3>${plan.title} ‚Ä¢ ${plan.amount_rub} ‚ÇΩ</h3>
            <p>${plan.days} –¥–Ω–µ–π –¥–æ—Å—Ç—É–ø–∞</p>
          </div>
        `;
        const btn = document.createElement("button");
        btn.textContent = "–ö—É–ø–∏—Ç—å";
        btn.onclick = () => createOrder(plan.code);
        item.appendChild(btn);
        plansEl.appendChild(item);
      });
    }

    function showOrder(orderId, paymentUrl, plan) {
      currentOrderId = orderId;
      currentPaymentUrl = paymentUrl;
      orderCardEl.classList.remove("hidden");
      orderInfoEl.textContent = `–¢–∞—Ä–∏—Ñ: ${plan.title}, —Å—É–º–º–∞: ${plan.amount_rub} ‚ÇΩ`;
      orderCodeEl.textContent = orderId;
      setStatus("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –ù–∞–∂–º–∏—Ç–µ ¬´–û–ø–ª–∞—Ç–∏—Ç—å¬ª.", "ok");
    }

    async function loadPlans() {
      const data = await requestJson("/webapp/api/plans", "GET");
      renderPlans(data.plans || [], data.payment_enabled);
    }

    async function loadProfile() {
      if (!initData) {
        profileEl.textContent = "–û—Ç–∫—Ä–æ–π—Ç–µ Mini App –∏–∑ Telegram-–±–æ—Ç–∞.";
        setStatus("initData –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.", "err");
        return;
      }

      const me = await requestJson("/webapp/api/me", "POST", { init_data: initData });
      const sub = me.subscription || {};
      const subText = sub.active ? ("–∞–∫—Ç–∏–≤–Ω–∞ –¥–æ " + (sub.subscription_end || "-")) : "–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞";
      profileEl.textContent = `ID: ${me.user.id} | –ü–æ–¥–ø–∏—Å–∫–∞: ${subText}`;

      if (me.pending_order) {
        showOrder(
          me.pending_order.order_id,
          "",
          { title: me.pending_order.days + " –¥–Ω–µ–π", amount_rub: me.pending_order.amount_rub }
        );
        setStatus("–ù–∞–π–¥–µ–Ω –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑. –ú–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–≥–æ –æ–ø–ª–∞—Ç—É.", "ok");
      } else {
        setStatus("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑.", "ok");
      }
    }

    async function createOrder(planCode) {
      if (!initData) {
        setStatus("–û—Ç–∫—Ä–æ–π—Ç–µ Mini App —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞.", "err");
        return;
      }
      try {
        const data = await requestJson("/webapp/api/create-order", "POST", {
          init_data: initData,
          plan_code: planCode
        });
        showOrder(data.order_id, data.payment_url, data.plan);
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞: " + err.message, "err");
      }
    }

    async function checkOrderStatus() {
      if (!currentOrderId) {
        setStatus("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑.", "err");
        return;
      }
      try {
        const data = await requestJson("/webapp/api/order-status", "POST", {
          init_data: initData,
          order_id: currentOrderId
        });
        if (data.order.status === "paid") {
          setStatus("–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ ‚úÖ", "ok");
          await loadProfile();
        } else {
          setStatus("–ü–ª–∞—Ç–µ–∂ –ø–æ–∫–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —á–µ—Ä–µ–∑ 10-30 —Å–µ–∫—É–Ω–¥.", "err");
        }
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã: " + err.message, "err");
      }
    }

    payBtn.onclick = () => {
      if (!currentPaymentUrl) {
        setStatus("–°—Å—ã–ª–∫–∞ –æ–ø–ª–∞—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑.", "err");
        return;
      }
      if (tg && tg.openLink) {
        tg.openLink(currentPaymentUrl);
      } else {
        window.open(currentPaymentUrl, "_blank");
      }
    };

    checkBtn.onclick = checkOrderStatus;

    copyBtn.onclick = async () => {
      if (!currentOrderId) {
        setStatus("–ù–µ—Ç –∫–æ–¥–∞ –∑–∞–∫–∞–∑–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.", "err");
        return;
      }
      try {
        await navigator.clipboard.writeText(currentOrderId);
        setStatus("–ö–æ–¥ –∑–∞–∫–∞–∑–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω.", "ok");
      } catch (_) {
        setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.", "err");
      }
    };

    (async () => {
      try {
        await loadPlans();
        await loadProfile();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + err.message, "err");
      }
    })();
  </script>
</body>
</html>
