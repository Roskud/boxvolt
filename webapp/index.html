<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BoxVolt Mini App</title>
  <link rel="icon" type="image/png" sizes="32x32" href="/icon.png?v=2">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon.png?v=2">
  <link rel="shortcut icon" type="image/png" href="/icon.png?v=2">
  <link rel="apple-touch-icon" href="/icon.png?v=2">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Manrope:wght@500;700;800&family=Sora:wght@600;700;800&display=swap");

    :root {
      --bg-top: #121521;
      --bg-mid: #0d1119;
      --bg-bottom: #050608;
      --panel-top: #1a202c;
      --panel-bottom: #121722;
      --text: #f3f5f8;
      --title: #ffffff;
      --ink: #f3f5f8;
      --muted: #aeb6c5;
      --accent: #ff9e1b;
      --accent-2: #ff7f11;
      --danger: #ff7e79;
      --ok: #45d39c;
      --border: rgba(255, 255, 255, 0.14);
      --glass: rgba(255, 255, 255, 0.06);
      --glass-strong: rgba(255, 255, 255, 0.1);
      --shadow: 0 26px 48px rgba(0, 0, 0, 0.42);
      --btn-shadow: 0 10px 20px rgba(0, 0, 0, 0.34);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Manrope", "Segoe UI", sans-serif;
      background:
        radial-gradient(70% 78% at 14% -16%, rgba(255, 158, 27, 0.24), transparent 100%),
        radial-gradient(80% 85% at 100% 0%, rgba(255, 127, 17, 0.2), transparent 100%),
        linear-gradient(180deg, var(--bg-top) 0%, var(--bg-mid) 50%, var(--bg-bottom) 100%);
      color: var(--ink);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    body::before,
    body::after {
      content: "";
      position: fixed;
      z-index: 0;
      pointer-events: none;
      border-radius: 999px;
      filter: blur(2px);
    }

    body::before {
      width: 340px;
      height: 340px;
      top: -140px;
      left: -110px;
      background: radial-gradient(circle, rgba(255, 158, 27, 0.2), transparent 68%);
    }

    body::after {
      width: 380px;
      height: 380px;
      right: -160px;
      bottom: -120px;
      background: radial-gradient(circle, rgba(255, 127, 17, 0.2), transparent 68%);
    }

    .wrap {
      max-width: 720px;
      margin: 0 auto;
      padding: 18px 14px 44px;
      position: relative;
      z-index: 1;
    }

    .hero {
      border-radius: 24px;
      background:
        linear-gradient(135deg, rgba(0, 79, 88, 0.93), rgba(2, 56, 64, 0.93)),
        radial-gradient(130% 130% at 0% 0%, rgba(120, 255, 239, 0.18), transparent 55%);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 12px;
    }

    .hero-head {
      display: block;
      margin-bottom: 6px;
    }

    .title {
      font-family: "Exo 2", "Space Grotesk", sans-serif;
      color: var(--title);
      font-size: clamp(24px, 6vw, 34px);
      font-weight: 700;
      letter-spacing: 0.02em;
      margin: 0;
      text-shadow: 0 3px 16px rgba(0, 0, 0, 0.24);
    }

    .subtitle {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 14px;
      max-width: 520px;
    }

    .tabbar {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 12px;
    }

    button.tab-btn {
      min-width: 0;
      width: 100%;
      padding: 9px 8px;
      border-radius: 12px;
      font-size: 12px;
      line-height: 1.1;
      letter-spacing: 0.03em;
      border: 1px solid rgba(151, 243, 231, 0.68);
      color: #f1feff;
      background: linear-gradient(180deg, rgba(2, 82, 92, 0.9), rgba(1, 58, 66, 0.88));
      text-shadow: 0 1px 4px rgba(0, 0, 0, 0.32);
      box-shadow: 0 9px 18px rgba(2, 27, 32, 0.28);
    }

    button.tab-btn.is-active {
      border-color: rgba(194, 255, 247, 0.96);
      background: linear-gradient(180deg, rgba(28, 171, 164, 0.96), rgba(8, 113, 116, 0.92));
      color: #ffffff;
      box-shadow: 0 12px 22px rgba(2, 33, 38, 0.34);
    }

    .tab-panel.tab-hidden {
      display: none;
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 14px;
      background:
        linear-gradient(165deg, rgba(2, 97, 106, 0.92), rgba(1, 64, 74, 0.92)),
        radial-gradient(100% 130% at 100% 0%, rgba(152, 255, 242, 0.2), transparent 60%);
      color: var(--text);
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .card::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: 1px solid rgba(255, 255, 255, 0.06);
      pointer-events: none;
    }

    .card strong {
      font-family: "Exo 2", "Space Grotesk", sans-serif;
      letter-spacing: 0.03em;
      font-size: 15px;
    }

    .status {
      padding: 12px 14px;
      border-radius: 15px;
      font-size: 14px;
      margin-top: 12px;
      margin-bottom: 0;
      border: 1px solid rgba(178, 255, 245, 0.3);
      color: #defeff;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    .status.ok {
      border-color: rgba(166, 255, 226, 0.55);
      color: var(--ok);
      background: rgba(0, 104, 74, 0.3);
    }

    .status.err {
      border-color: rgba(255, 206, 215, 0.6);
      color: var(--danger);
      background: rgba(123, 24, 43, 0.26);
    }

    .status.busy {
      border-color: rgba(169, 241, 255, 0.55);
      color: #dffbff;
      background: rgba(8, 80, 96, 0.28);
    }

    .plans {
      display: grid;
      gap: 12px;
    }

    .plan-skeleton {
      border-radius: 18px;
      border: 1px solid rgba(170, 255, 243, 0.16);
      height: 72px;
      background: linear-gradient(
        100deg,
        rgba(255, 255, 255, 0.06) 0%,
        rgba(255, 255, 255, 0.16) 45%,
        rgba(255, 255, 255, 0.06) 100%
      );
      background-size: 220% 100%;
      animation: skeletonPulse 1.2s ease infinite;
    }

    @keyframes skeletonPulse {
      0% { background-position: 0% 50%; }
      100% { background-position: 120% 50%; }
    }

    .plan {
      border: 1px solid rgba(170, 255, 243, 0.26);
      border-radius: 18px;
      padding: 13px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
    }

    .plan h3 {
      margin: 0 0 4px;
      font-size: 16px;
      color: #f4ffff;
    }

    .plan p {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
    }

    button {
      border: 1px solid rgba(172, 255, 243, 0.55);
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      color: #ecffff;
      background:
        linear-gradient(180deg, rgba(110, 255, 236, 0.22), rgba(110, 255, 236, 0.08)),
        rgba(255, 255, 255, 0.05);
      padding: 10px 12px;
      min-width: 118px;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      box-shadow: var(--btn-shadow);
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 24px rgba(3, 33, 40, 0.28);
      border-color: rgba(195, 255, 247, 0.75);
    }

    button:active {
      transform: translateY(1px);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    button.is-loading {
      position: relative;
      overflow: hidden;
    }

    button.is-loading::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(
        100deg,
        rgba(255, 255, 255, 0) 0%,
        rgba(255, 255, 255, 0.24) 35%,
        rgba(255, 255, 255, 0) 70%
      );
      animation: btnShimmer 1.1s linear infinite;
      pointer-events: none;
    }

    @keyframes btnShimmer {
      from { transform: translateX(-120%); }
      to { transform: translateX(120%); }
    }

    button.ghost {
      background: rgba(255, 255, 255, 0.03);
      border-color: rgba(183, 255, 246, 0.32);
      color: #dcfbff;
    }

    .order-row {
      display: flex;
      gap: 9px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .order-row button {
      flex: 1 1 150px;
    }

    .mono {
      font-family: "Space Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      word-break: break-all;
      color: #d9fcff;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 10px;
      margin-top: 8px;
      border: 1px solid rgba(172, 255, 245, 0.22);
    }

    .hidden { display: none; }

    .small {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }

    .pitch {
      margin-top: 10px;
      border: 1px solid rgba(178, 255, 244, 0.3);
      border-radius: 14px;
      padding: 11px;
      background: linear-gradient(165deg, rgba(255, 255, 255, 0.11), rgba(255, 255, 255, 0.04));
    }

    .pitch ul {
      margin: 8px 0 0;
      padding-left: 16px;
      color: #d9fbff;
      font-size: 13px;
      line-height: 1.5;
    }

    .faq {
      margin-top: 10px;
      border: 1px solid rgba(178, 255, 244, 0.24);
      border-radius: 14px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.04);
    }

    .faq details {
      border-top: 1px solid rgba(177, 255, 244, 0.17);
      padding: 8px 0;
    }

    .faq details:first-of-type {
      border-top: 0;
      padding-top: 0;
    }

    .faq summary {
      cursor: pointer;
      color: #e9fdff;
      font-weight: 600;
      font-size: 13px;
      list-style: none;
    }

    .faq summary::-webkit-details-marker {
      display: none;
    }

    .faq p {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 12px;
    }

    .field label {
      font-size: 12px;
      color: #c6e9ed;
      letter-spacing: 0.03em;
    }

    .field input, .field textarea, .field select {
      width: 100%;
      border: 1px solid rgba(181, 255, 246, 0.28);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.06);
      color: #ebfeff;
      padding: 10px 11px;
      font-size: 13px;
      font-family: inherit;
      outline: none;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .field input::placeholder,
    .field textarea::placeholder {
      color: rgba(200, 237, 241, 0.72);
    }

    .field input:focus,
    .field textarea:focus,
    .field select:focus {
      border-color: rgba(183, 255, 247, 0.74);
      box-shadow: 0 0 0 2px rgba(138, 255, 239, 0.2);
    }

    .field textarea { min-height: 88px; resize: vertical; }

    .admin-plans {
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }

    .admin-plan {
      border: 1px solid rgba(184, 255, 246, 0.24);
      border-radius: 13px;
      padding: 11px;
      background: rgba(255, 255, 255, 0.05);
    }

    .admin-plan-head {
      font-size: 12px;
      color: #bce1e6;
      margin-bottom: 8px;
      letter-spacing: 0.04em;
    }

    .admin-plan-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .mini-block {
      margin-top: 12px;
      border: 1px solid rgba(184, 255, 246, 0.24);
      border-radius: 14px;
      padding: 11px;
      background: rgba(255, 255, 255, 0.05);
    }

    .state-line {
      margin-top: 8px;
    }

    .state-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 5px 11px;
      border: 1px solid rgba(190, 255, 248, 0.45);
      background: rgba(255, 255, 255, 0.08);
      color: #e9fdff;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .state-pill.ok {
      color: var(--ok);
      border-color: rgba(166, 255, 226, 0.58);
      background: rgba(0, 104, 74, 0.3);
    }

    .state-pill.warn {
      color: #ffd4b8;
      border-color: rgba(255, 202, 151, 0.55);
      background: rgba(120, 58, 12, 0.26);
    }

    .state-pill.info {
      color: #d6fbff;
      border-color: rgba(169, 241, 255, 0.52);
      background: rgba(8, 80, 96, 0.28);
    }

    .hero {
      background:
        linear-gradient(155deg, rgba(22, 27, 36, 0.95), rgba(12, 14, 19, 0.94)),
        radial-gradient(130% 130% at 0% 0%, rgba(255, 158, 27, 0.18), transparent 55%);
      border-color: var(--border);
    }

    .title {
      font-family: "Sora", "Manrope", sans-serif;
      color: var(--title);
    }

    .subtitle {
      color: var(--muted);
    }

    button.tab-btn {
      border: 1px solid rgba(255, 255, 255, 0.16);
      color: var(--text);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
      box-shadow: 0 9px 18px rgba(0, 0, 0, 0.32);
      text-shadow: none;
    }

    button.tab-btn.is-active {
      border-color: rgba(255, 158, 27, 0.52);
      background: linear-gradient(180deg, var(--accent), var(--accent-2));
      color: #1c1205;
      box-shadow: 0 10px 22px rgba(255, 127, 17, 0.34);
    }

    .card {
      background:
        linear-gradient(165deg, rgba(23, 29, 40, 0.94), rgba(14, 18, 26, 0.94)),
        radial-gradient(100% 130% at 100% 0%, rgba(255, 158, 27, 0.16), transparent 64%);
      color: var(--text);
      border-color: var(--border);
    }

    .card strong {
      font-family: "Sora", "Manrope", sans-serif;
      color: var(--title);
    }

    .status {
      border: 1px solid rgba(255, 255, 255, 0.16);
      color: #d9dfeb;
      background: rgba(255, 255, 255, 0.05);
    }

    .status.busy {
      border-color: rgba(255, 158, 27, 0.5);
      color: #ffd49a;
      background: rgba(108, 63, 9, 0.26);
    }

    .plan {
      border-color: rgba(255, 255, 255, 0.16);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04);
    }

    .plan h3 {
      color: var(--text);
    }

    .plan p {
      color: var(--muted);
    }

    button {
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--text);
      background:
        linear-gradient(180deg, rgba(255, 255, 255, 0.09), rgba(255, 255, 255, 0.03)),
        rgba(255, 255, 255, 0.02);
      box-shadow: var(--btn-shadow);
    }

    button:hover {
      box-shadow: 0 14px 24px rgba(0, 0, 0, 0.36);
      border-color: rgba(255, 158, 27, 0.52);
    }

    button.ghost {
      background: rgba(255, 255, 255, 0.02);
      border-color: rgba(255, 255, 255, 0.16);
      color: #e8edf5;
    }

    .mono {
      color: #e8edf5;
      background: #0f141c;
      border-color: rgba(255, 255, 255, 0.16);
    }

    .small {
      color: var(--muted);
    }

    .pitch,
    .faq,
    .admin-plan,
    .mini-block {
      border-color: rgba(255, 255, 255, 0.16);
      background: rgba(255, 255, 255, 0.04);
    }

    .pitch ul,
    .faq summary {
      color: var(--text);
    }

    .faq details {
      border-top: 1px solid rgba(255, 255, 255, 0.12);
    }

    .faq p {
      color: var(--muted);
    }

    .field label {
      color: #d0d7e5;
    }

    .field input, .field textarea, .field select {
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(11, 14, 20, 0.78);
      color: var(--text);
    }

    .field input::placeholder,
    .field textarea::placeholder {
      color: rgba(174, 182, 197, 0.76);
    }

    .field input:focus,
    .field textarea:focus,
    .field select:focus {
      border-color: rgba(255, 158, 27, 0.68);
      box-shadow: 0 0 0 2px rgba(255, 158, 27, 0.22);
    }

    .admin-plan-head {
      color: #d3dae7;
    }

    .state-pill {
      border: 1px solid rgba(255, 255, 255, 0.24);
      background: rgba(255, 255, 255, 0.08);
      color: var(--text);
    }

    .state-pill.warn {
      color: #ffd8b0;
      border-color: rgba(255, 200, 87, 0.55);
      background: rgba(120, 58, 12, 0.26);
    }

    .state-pill.info {
      color: #ffd9a1;
      border-color: rgba(255, 158, 27, 0.52);
      background: rgba(106, 62, 9, 0.26);
    }

    #adminUserResults .order-row { margin-top: 8px; }

    /* Liquid-glass pass (visual only) */
    .wrap {
      isolation: isolate;
      overflow: visible;
    }

    .wrap::before,
    .wrap::after {
      content: "";
      position: absolute;
      border-radius: 999px;
      pointer-events: none;
      z-index: -1;
      filter: blur(1px);
    }

    .wrap::before {
      width: 280px;
      height: 280px;
      right: -110px;
      top: 68px;
      background: radial-gradient(circle, rgba(255, 158, 27, 0.18), transparent 70%);
    }

    .wrap::after {
      width: 250px;
      height: 250px;
      left: -96px;
      top: 320px;
      background: radial-gradient(circle, rgba(84, 154, 255, 0.14), transparent 70%);
    }

    .hero,
    .card,
    .plan,
    .pitch,
    .faq,
    .admin-plan,
    .mini-block,
    .status,
    .field input,
    .field textarea,
    .field select,
    .state-pill,
    button.tab-btn,
    button {
      backdrop-filter: blur(14px) saturate(128%);
      -webkit-backdrop-filter: blur(14px) saturate(128%);
    }

    .hero,
    .card {
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    .hero::before,
    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      pointer-events: none;
      border: 1px solid rgba(255, 255, 255, 0.08);
      z-index: 1;
    }

    .hero::after {
      content: "";
      position: absolute;
      width: 280px;
      height: 280px;
      top: -130px;
      right: -90px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255, 158, 27, 0.16), transparent 68%);
      pointer-events: none;
      z-index: 0;
    }

    .card::after {
      border-color: rgba(255, 255, 255, 0.1);
    }

    .tabbar {
      padding: 6px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.03);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
    }

    button.tab-btn {
      border-color: rgba(255, 255, 255, 0.18);
      background:
        linear-gradient(180deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.05)),
        rgba(255, 255, 255, 0.02);
    }

    button.tab-btn.is-active {
      border-color: rgba(255, 158, 27, 0.58);
      box-shadow: 0 10px 20px rgba(255, 127, 17, 0.34);
    }

    .plan,
    .pitch,
    .faq,
    .admin-plan,
    .mini-block {
      border-color: rgba(255, 255, 255, 0.18);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.07);
    }

    .plan {
      background:
        linear-gradient(180deg, rgba(255, 255, 255, 0.13), rgba(255, 255, 255, 0.04)),
        rgba(255, 255, 255, 0.03);
    }

    button {
      border-color: rgba(255, 255, 255, 0.24);
      background:
        linear-gradient(180deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.04)),
        rgba(255, 255, 255, 0.03);
    }

    button:hover {
      border-color: rgba(255, 158, 27, 0.58);
      box-shadow: 0 14px 26px rgba(0, 0, 0, 0.38);
    }

    .status.busy {
      border-color: rgba(255, 198, 122, 0.64);
      background: rgba(108, 63, 9, 0.3);
    }

    @keyframes blob {
      0% { transform: translate(0px, 0px) scale(1); }
      33% { transform: translate(30px, -50px) scale(1.1); }
      66% { transform: translate(-20px, 20px) scale(0.9); }
      100% { transform: translate(0px, 0px) scale(1); }
    }

    @keyframes float-up {
      0% { transform: translateY(0) scale(1); opacity: 0; }
      20% { opacity: 1; }
      80% { opacity: 1; }
      100% { transform: translateY(-100vh) scale(0); opacity: 0; }
    }

    .fx-bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
      background: #050505;
    }

    .fx-grid {
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(to right, #ffffff0a 1px, transparent 1px),
        linear-gradient(to bottom, #ffffff0a 1px, transparent 1px);
      background-size: 4rem 4rem;
      -webkit-mask-image: radial-gradient(ellipse 80% 50% at 50% 0%, #000 70%, transparent 100%);
      mask-image: radial-gradient(ellipse 80% 50% at 50% 0%, #000 70%, transparent 100%);
    }

    .fx-sparks {
      position: absolute;
      inset: 0;
    }

    .fx-spark {
      position: absolute;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.95);
      animation: float-up linear infinite;
    }

    .fx-spotlight {
      position: absolute;
      inset: 0;
      z-index: 10;
      transition: opacity 0.3s ease;
      background: radial-gradient(600px circle at 50% 20%, rgba(249, 115, 22, 0.06), transparent 40%);
    }

    .fx-blob {
      position: absolute;
      border-radius: 999px;
      filter: blur(120px);
    }

    .fx-blob-1 {
      top: -10%;
      left: -10%;
      width: 40vw;
      height: 40vw;
      background: rgba(234, 88, 12, 0.14);
      animation: blob 15s infinite alternate ease-in-out;
    }

    .fx-blob-2 {
      bottom: -20%;
      right: -10%;
      width: 50vw;
      height: 50vw;
      background: rgba(79, 70, 229, 0.12);
      animation: blob 15s infinite alternate ease-in-out;
      animation-delay: 2s;
    }

    .fx-blob-3 {
      top: 40%;
      left: 60%;
      width: 30vw;
      height: 30vw;
      background: rgba(16, 185, 129, 0.08);
      animation: blob 15s infinite alternate ease-in-out;
      animation-delay: 4s;
      filter: blur(100px);
    }

    .fx-noise {
      position: absolute;
      inset: 0;
      background: url('https://grainy-gradients.vercel.app/noise.svg');
      opacity: 0.2;
      mix-blend-mode: overlay;
      z-index: 20;
    }

    .wrap {
      position: relative;
      z-index: 20;
      max-width: 860px;
      padding-top: 26px;
    }

    .hero,
    .card {
      background: rgba(0, 0, 0, 0.4);
      border-color: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(18px) saturate(128%);
      -webkit-backdrop-filter: blur(18px) saturate(128%);
    }

    .tabbar {
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.12);
      padding: 6px;
    }

    button.tab-btn {
      border-radius: 999px;
      border-color: rgba(255, 255, 255, 0.18);
      color: #d4d7df;
    }

    button.tab-btn:hover {
      color: #ffffff;
      background: rgba(255, 255, 255, 0.08);
    }

    button.tab-btn.is-active {
      color: #ffffff;
      background: linear-gradient(to right, #f97316, #f59e0b);
      border-color: rgba(249, 115, 22, 0.58);
      box-shadow: 0 0 15px rgba(249, 115, 22, 0.3);
    }

    button.tab-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 40px;
      text-align: center;
      line-height: 1.2;
      padding-left: 10px;
      padding-right: 10px;
    }

    @media (max-width: 520px) {
      .tabbar {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .plan {
        flex-direction: column;
        align-items: stretch;
      }
      .plan button {
        width: 100%;
      }
      .order-row button {
        flex-basis: 100%;
      }
      .admin-plan-grid { grid-template-columns: 1fr; }
    }
  </style>
  <style>
    :root {
      --bg-page: #050505;
      --card: rgba(10, 10, 13, 0.62);
      --card-2: rgba(8, 9, 12, 0.8);
      --line-new: rgba(255, 255, 255, 0.11);
      --line-new-soft: rgba(255, 255, 255, 0.08);
      --text-main: #e7e7ea;
      --text-soft: #a3a3ac;
      --orange-main: #f97316;
      --orange-soft: #f59e0b;
      --ok-main: #34d399;
      --err-main: #fb7185;
    }

    body {
      background:
        radial-gradient(80% 90% at 10% -20%, rgba(249, 115, 22, 0.2), transparent 70%),
        radial-gradient(80% 90% at 100% 0%, rgba(59, 130, 246, 0.12), transparent 70%),
        #050505 !important;
      color: var(--text-main);
    }

    .wrap {
      max-width: 980px;
      padding: 18px 14px 44px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .hero {
      border-radius: 28px;
      padding: 22px;
      background: linear-gradient(165deg, var(--card), var(--card-2));
      border: 1px solid var(--line-new);
      box-shadow: 0 26px 50px rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(18px) saturate(130%);
      -webkit-backdrop-filter: blur(18px) saturate(130%);
    }

    .hero-head {
      margin-bottom: 8px;
    }

    .title {
      margin: 0;
      font-family: "Sora", "Manrope", sans-serif;
      font-size: clamp(32px, 5vw, 52px);
      line-height: 1.05;
      letter-spacing: 0.01em;
      background: linear-gradient(160deg, #fff 15%, #d4d4d8 55%, #737373 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: none;
    }

    .subtitle {
      margin: 0 0 14px;
      color: var(--text-soft);
      font-size: 15px;
      max-width: 620px;
      line-height: 1.5;
    }

    .status {
      margin-top: 0;
      border-radius: 13px;
      border: 1px solid var(--line-new-soft);
      background: rgba(255, 255, 255, 0.05);
      color: #d4d4da;
      font-size: 14px;
    }

    .status.ok {
      border-color: rgba(16, 185, 129, 0.3);
      background: rgba(5, 56, 44, 0.45);
      color: #6ee7b7;
    }

    .status.err {
      border-color: rgba(244, 63, 94, 0.3);
      background: rgba(66, 18, 32, 0.45);
      color: #fda4af;
    }

    .status.busy {
      border-color: rgba(59, 130, 246, 0.3);
      background: rgba(20, 39, 66, 0.45);
      color: #bfdbfe;
    }

    .tabbar {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      -ms-overflow-style: none;
      scrollbar-width: none;
      padding: 8px;
      border-radius: 18px;
      border: 1px solid var(--line-new);
      background: rgba(7, 8, 11, 0.6);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .tabbar::-webkit-scrollbar {
      display: none;
    }

    button.tab-btn {
      flex: 0 0 auto;
      width: auto;
      min-width: 120px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: transparent;
      color: #9ca3af;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 700;
      box-shadow: none;
      letter-spacing: 0.01em;
      text-shadow: none;
      white-space: nowrap;
    }

    button.tab-btn:hover {
      color: #f3f4f6;
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.16);
    }

    button.tab-btn.is-active {
      color: #fff;
      border-color: rgba(249, 115, 22, 0.45);
      background: linear-gradient(90deg, var(--orange-main), var(--orange-soft));
      box-shadow: 0 0 16px rgba(249, 115, 22, 0.28);
    }

    .card {
      border-radius: 24px;
      border: 1px solid var(--line-new);
      background: linear-gradient(165deg, var(--card), var(--card-2));
      color: var(--text-main);
      box-shadow: 0 20px 42px rgba(0, 0, 0, 0.42);
      padding: 18px;
      margin-bottom: 0;
      backdrop-filter: blur(18px) saturate(125%);
      -webkit-backdrop-filter: blur(18px) saturate(125%);
    }

    .card strong {
      font-family: "Sora", "Manrope", sans-serif;
      font-size: 22px;
      letter-spacing: 0.01em;
      color: #fff;
      display: block;
      margin-bottom: 10px;
    }

    .tab-panel:not(.tab-hidden) {
      animation: fadeInPanel 0.35s ease both;
    }

    .card.is-locked {
      border-color: rgba(251, 113, 133, 0.25);
      box-shadow: 0 16px 36px rgba(0, 0, 0, 0.36);
    }

    .access-note {
      font-size: 12px;
      color: var(--text-soft);
      line-height: 1.45;
    }

    .access-note.warn {
      color: #fda4af;
    }

    .pitch,
    .faq,
    .mini-block,
    .admin-plan {
      border-radius: 16px;
      border: 1px solid var(--line-new-soft);
      background: rgba(255, 255, 255, 0.03);
      padding: 12px;
      color: var(--text-main);
    }

    .pitch strong,
    .faq strong {
      font-size: 16px;
      margin-bottom: 8px;
    }

    .pitch ul {
      margin: 8px 0 0 0;
      padding-left: 18px;
      color: #d4d4da;
      line-height: 1.5;
      font-size: 13px;
    }

    .small {
      color: var(--text-soft);
      font-size: 13px;
      line-height: 1.45;
    }

    .faq details {
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      padding: 8px 0;
    }

    .faq details:first-of-type {
      border-top: 0;
      padding-top: 4px;
    }

    .faq summary {
      color: #e5e7eb;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      list-style: none;
    }

    .faq summary::-webkit-details-marker {
      display: none;
    }

    .faq p {
      color: #a3a3ac;
      margin: 7px 0 0;
      line-height: 1.5;
      font-size: 13px;
    }

    .field label {
      color: #a3a3ac;
      font-size: 12px;
      margin-bottom: 6px;
    }

    .field input,
    .field textarea,
    .field select {
      border-radius: 11px;
      border: 1px solid var(--line-new-soft);
      background: rgba(0, 0, 0, 0.35);
      color: #fff;
      padding: 10px 12px;
      font-size: 13px;
    }

    .field input:focus,
    .field textarea:focus,
    .field select:focus {
      border-color: rgba(249, 115, 22, 0.5);
      box-shadow: 0 0 0 1px rgba(249, 115, 22, 0.25);
    }

    button {
      border-radius: 11px;
      border: 1px solid rgba(249, 115, 22, 0.35);
      background: linear-gradient(90deg, var(--orange-main), var(--orange-soft));
      color: #fff;
      font-size: 13px;
      font-weight: 700;
      padding: 10px 12px;
      box-shadow: 0 10px 20px rgba(249, 115, 22, 0.2);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 24px rgba(249, 115, 22, 0.28);
    }

    button.ghost {
      border-color: var(--line-new-soft);
      background: rgba(255, 255, 255, 0.06);
      color: #e5e7eb;
      box-shadow: none;
    }

    button.ghost:hover {
      border-color: rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.1);
      box-shadow: none;
      transform: translateY(-1px);
    }

    .order-row {
      gap: 8px;
    }

    .mono {
      border-radius: 10px;
      border: 1px solid var(--line-new-soft);
      background: rgba(0, 0, 0, 0.35);
      color: #fcd34d;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 10px;
      margin-top: 8px;
    }

    .plans {
      gap: 10px;
    }

    .plan {
      border-radius: 16px;
      border: 1px solid var(--line-new-soft);
      background: rgba(255, 255, 255, 0.03);
      padding: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .plan h3 {
      margin: 0 0 4px;
      color: #fff;
      font-size: 17px;
      font-family: "Sora", "Manrope", sans-serif;
    }

    .plan p {
      margin: 0;
      color: var(--text-soft);
      font-size: 12px;
      line-height: 1.45;
    }

    .plan button {
      width: auto;
      min-width: 120px;
    }

    .plan.plan-popular {
      border-color: rgba(249, 115, 22, 0.34);
      box-shadow: 0 0 0 1px rgba(249, 115, 22, 0.12) inset;
    }

    .plan.plan-best {
      border-color: rgba(16, 185, 129, 0.34);
      box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.12) inset;
    }

    .plan-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 0 0 8px;
    }

    .plan-badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      border: 1px solid var(--line-new-soft);
      padding: 3px 8px;
      font-size: 10px;
      font-weight: 800;
      letter-spacing: 0.02em;
      white-space: nowrap;
      text-transform: uppercase;
    }

    .plan-badge.popular {
      color: #fdba74;
      border-color: rgba(249, 115, 22, 0.42);
      background: rgba(249, 115, 22, 0.12);
    }

    .plan-badge.best {
      color: #6ee7b7;
      border-color: rgba(16, 185, 129, 0.42);
      background: rgba(16, 185, 129, 0.12);
    }

    .plan-skeleton {
      border-radius: 16px;
      border: 1px solid var(--line-new-soft);
      height: 74px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.03));
      background-size: 220% 100%;
      animation: skeletonPulse 1.1s linear infinite;
    }

    .state-pill {
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 800;
      border: 1px solid;
    }

    .state-pill.ok {
      color: #6ee7b7;
      border-color: rgba(16, 185, 129, 0.35);
      background: rgba(16, 185, 129, 0.14);
    }

    .state-pill.warn {
      color: #fde68a;
      border-color: rgba(245, 158, 11, 0.35);
      background: rgba(245, 158, 11, 0.14);
    }

    .state-pill.info {
      color: #c4b5fd;
      border-color: rgba(139, 92, 246, 0.35);
      background: rgba(139, 92, 246, 0.14);
    }

    @keyframes fadeInPanel {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes skeletonPulse {
      0% { background-position: 0 50%; }
      100% { background-position: 100% 50%; }
    }

    @media (max-width: 860px) {
      .wrap { max-width: 760px; }
      .hero { padding: 18px; }
      .card { padding: 14px; }
      .title { font-size: clamp(26px, 8vw, 42px); }
      .plan { flex-direction: column; align-items: flex-start; }
      .plan button { width: 100%; min-width: 0; }
    }
  </style>
</head>
<body>
  <div class="fx-bg" aria-hidden="true">
    <div class="fx-grid"></div>
    <div id="fxSparks" class="fx-sparks"></div>
    <div id="fxSpotlight" class="fx-spotlight"></div>
    <div class="fx-blob fx-blob-1"></div>
    <div class="fx-blob fx-blob-2"></div>
    <div class="fx-blob fx-blob-3"></div>
    <div class="fx-noise"></div>
  </div>
  <main class="wrap">
    <section class="hero">
      <div class="hero-head">
        <h1 class="title">BoxVolt Mini App</h1>
      </div>
      <p class="subtitle">–ü–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã –≤ –æ–¥–Ω–æ–º –æ–∫–Ω–µ Telegram</p>
      <div id="status" class="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </section>

    <nav class="tabbar" aria-label="–†–∞–∑–¥–µ–ª—ã Mini App">
      <button type="button" id="accountTabBtn" class="tab-btn is-active" data-tab-target="accountCard">–ê–∫–∫–∞—É–Ω—Ç</button>
      <button type="button" id="plansTabBtn" class="tab-btn" data-tab-target="plansCard">–¢–∞—Ä–∏—Ñ—ã</button>
      <button type="button" id="referralsTabBtn" class="tab-btn" data-tab-target="referralsCard">–ë–æ–Ω—É—Å—ã</button>
      <button type="button" id="orderTabBtn" class="tab-btn hidden" data-tab-target="orderCard">–ó–∞–∫–∞–∑</button>
      <button type="button" id="adminTabBtn" class="tab-btn" data-tab-target="adminCard">–ê–¥–º–∏–Ω</button>
      <button type="button" id="broadcastTabBtn" class="tab-btn" data-tab-target="broadcastCard">–†–∞—Å—Å—ã–ª–∫–∞</button>
    </nav>

    <section id="accountCard" class="card tab-panel">
      <strong>–ê–∫–∫–∞—É–Ω—Ç</strong>
      <div class="pitch">
        <strong>‚ö° BoxVolt Elite Access</strong>
        <ul>
          <li>–°—Ç–∞–±–∏–ª—å–Ω—ã–π VLESS Reality —Å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª—è–µ–º–æ–π –ø–æ–¥–ø–∏—Å–∫–æ–π.</li>
          <li>–ë—ã—Å—Ç—Ä–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –¥–Ω–µ–π.</li>
          <li>–ú–æ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –≤—ã–¥–∞—á–∞ –∫–ª—é—á–∞ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤ Telegram.</li>
        </ul>
      </div>
      <div class="faq">
        <strong>FAQ</strong>
        <details>
          <summary>–û–ø–ª–∞—Ç–∏–ª –±–æ–ª—å—à–µ –∏–∑-–∑–∞ –∫–æ–º–∏—Å—Å–∏–∏. –ó–∞–∫–∞–∑ –∑–∞—á—Ç—ë—Ç—Å—è?</summary>
          <p>–î–∞. –ó–∞–∫–∞–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è, –µ—Å–ª–∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Å—É–º–º–∞ –Ω–µ –Ω–∏–∂–µ —Å—É–º–º—ã —Ç–∞—Ä–∏—Ñ–∞.</p>
        </details>
        <details>
          <summary>–ü—Ä–æ–¥–ª–µ–Ω–∏–µ —Å–æ–∂–∂—ë—Ç –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –¥–Ω–∏?</summary>
          <p>–ù–µ—Ç. –ù–æ–≤—ã–µ –¥–Ω–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Å–≤–µ—Ä—Ö—É –∫ —Ç–µ–∫—É—â–µ–π –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ.</p>
        </details>
        <details>
          <summary>–ö–ª—é—á –æ–±–Ω–æ–≤–∏–ª—Å—è, –∞ —Å—Å—ã–ª–∫–∞ —Ç–∞–∫–∞—è –∂–µ?</summary>
          <p>–ü–æ—Å–ª–µ –ø–µ—Ä–µ–≤—ã–ø—É—Å–∫–∞ —Å—Å—ã–ª–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–æ–≤–æ–π, —Å—Ç–∞—Ä–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.</p>
        </details>
      </div>
      <div id="profile" class="small" style="margin-top:8px;">–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ...</div>
      <div id="activePromo" class="small" style="margin-top:8px;">–ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥: –Ω–µ—Ç</div>
      <strong style="display:block; margin-top:12px;">–ë—ã—Å—Ç—Ä–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ</strong>
      <div class="order-row">
        <button id="quickRenew7Btn" class="ghost">üí≥ 7 –¥–Ω–µ–π</button>
        <button id="quickRenew30Btn" class="ghost">üí≥ 30 –¥–Ω–µ–π</button>
      </div>
      <div class="order-row">
        <button id="quickRenew90Btn" class="ghost">üí≥ 90 –¥–Ω–µ–π</button>
        <button id="quickRenew365Btn" class="ghost">üí≥ 365 –¥–Ω–µ–π</button>
      </div>
      <div class="order-row">
        <button id="quickRenewLastBtn" class="ghost">üîÅ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ—à–ª—ã–π —Ç–∞—Ä–∏—Ñ</button>
      </div>
      <div class="field">
        <label for="promoCodeInput">–ü—Ä–æ–º–æ–∫–æ–¥</label>
        <input id="promoCodeInput" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: BOXVOLT100">
      </div>
      <div class="order-row">
        <button id="promoActivateBtn" class="ghost">üéü –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
      </div>
    </section>

    <section id="plansCard" class="card tab-panel tab-hidden">
      <strong>–¢–∞—Ä–∏—Ñ—ã</strong>
      <div id="plans" class="plans" style="margin-top:10px;"></div>
    </section>

    <section id="referralsCard" class="card tab-panel tab-hidden">
      <strong>–ë–æ–Ω—É—Å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</strong>
      <p class="small" style="margin-top:8px;">
        –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã –∑–∞ –∏—Ö –æ–ø–ª–∞—Ç—ã.
      </p>
      <div class="pitch">
        <strong>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</strong>
        <p id="referralHint" class="small" style="margin:6px 0 0;">–°—Å—ã–ª–∫–∞ —Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è.</p>
        <div id="referralLink" class="mono" style="margin-top:10px;">-</div>
        <div class="order-row">
          <button id="referralCopyBtn" class="ghost">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
          <button id="referralShareBtn" class="ghost">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
        </div>
      </div>
    </section>

    <section id="adminCard" class="card tab-panel tab-hidden">
      <strong>üõ† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</strong>
      <p class="small" style="margin-top:8px;">
        –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω –∏ –∞–∫—Ü–∏–π –ø—Ä—è–º–æ –≤ Mini App.
      </p>
      <div id="adminAccessHint" class="access-note" style="margin-top:8px;"></div>

      <div class="field">
        <label for="adminGlobalDiscount">–ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ (%)</label>
        <input id="adminGlobalDiscount" type="number" min="0" max="90" value="0">
      </div>

      <div class="field">
        <label for="adminSaleTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∞–∫—Ü–∏–∏</label>
        <input id="adminSaleTitle" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Weekend Sale">
      </div>

      <div class="field">
        <label for="adminSaleMessage">–¢–µ–∫—Å—Ç –∞–∫—Ü–∏–∏</label>
        <textarea id="adminSaleMessage" placeholder="–¢–æ–ª—å–∫–æ –¥–æ –∫–æ–Ω—Ü–∞ –Ω–µ–¥–µ–ª–∏..."></textarea>
      </div>

      <strong style="display:block; margin-top:12px;">–ü–ª–∞–Ω—ã</strong>
      <div id="adminPlans" class="admin-plans"></div>

      <strong style="display:block; margin-top:14px;">–ü—Ä–æ–º–æ–∫–æ–¥—ã</strong>
      <div class="field">
        <label for="adminPromoCode">–ö–æ–¥</label>
        <input id="adminPromoCode" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: START50">
      </div>
      <div class="admin-plan-grid">
        <div class="field">
          <label for="adminPromoDiscount">–°–∫–∏–¥–∫–∞ (‚ÇΩ)</label>
          <input id="adminPromoDiscount" type="number" min="1" max="100000" value="50">
        </div>
        <div class="field">
          <label for="adminPromoExpires">–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ</label>
          <input id="adminPromoExpires" type="text" placeholder="2026-03-01 23:59">
        </div>
        <div class="field">
          <label for="adminPromoMaxActivations">–õ–∏–º–∏—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–π (0 = –±–µ–∑ –ª–∏–º–∏—Ç–∞)</label>
          <input id="adminPromoMaxActivations" type="number" min="0" max="1000000" value="0">
        </div>
      </div>
      <div class="order-row">
        <button id="adminPromoSaveBtn" class="ghost">üéü –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
        <button id="adminPromoReloadBtn" class="ghost">üìã –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
      </div>
      <div class="admin-plan-grid">
        <div class="field">
          <label for="adminPromoManageCode">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–¥–æ–º</label>
          <input id="adminPromoManageCode" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: START50">
        </div>
        <div class="field">
          <label for="adminPromoExtendDays">–ü—Ä–æ–¥–ª–∏—Ç—å –Ω–∞ –¥–Ω–µ–π</label>
          <input id="adminPromoExtendDays" type="number" min="1" max="3650" value="7">
        </div>
        <div class="field">
          <label for="adminPromoSetExpiry">–ù–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
          <input id="adminPromoSetExpiry" type="text" placeholder="2026-03-01 23:59">
        </div>
      </div>
      <div class="order-row">
        <button id="adminPromoExtendBtn" class="ghost">‚è© –ü—Ä–æ–¥–ª–∏—Ç—å</button>
        <button id="adminPromoSetExpiryBtn" class="ghost">üìÖ –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É</button>
        <button id="adminPromoDeleteBtn" class="ghost">üóë –£–¥–∞–ª–∏—Ç—å</button>
      </div>
      <div class="field">
        <label for="adminPromoShowArchived">–°–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</label>
        <select id="adminPromoShowArchived">
          <option value="0" selected>–¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ</option>
          <option value="1">–í—Å–µ (–≤–∫–ª—é—á–∞—è –∞—Ä—Ö–∏–≤)</option>
        </select>
      </div>
      <div id="adminPromoList" class="small" style="margin-top:8px; white-space:pre-wrap;"></div>

      <strong style="display:block; margin-top:14px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</strong>
      <div class="field">
        <label for="adminUserQuery">–ü–æ–∏—Å–∫ –ø–æ @username –∏–ª–∏ Telegram ID</label>
        <input id="adminUserQuery" type="text" placeholder="@username –∏–ª–∏ 123456789">
      </div>
      <div class="order-row">
        <button id="adminUserSearchBtn" class="ghost">üîé –ù–∞–π—Ç–∏</button>
      </div>
      <div id="adminUserResults" class="small" style="margin-top:8px; white-space:pre-wrap;"></div>
      <div id="adminSelectedUser" class="small" style="margin-top:8px;">–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –Ω–µ—Ç</div>
      <div class="admin-plan-grid">
        <div class="field">
          <label for="adminGrantDays">–í—ã–¥–∞—Ç—å –¥–Ω–µ–π</label>
          <input id="adminGrantDays" type="number" min="1" max="3650" value="30">
        </div>
      </div>
      <div class="order-row">
        <button id="adminGrantBtn" class="ghost">‚ûï –í—ã–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
        <button id="adminRemoveSubBtn" class="ghost">üóë –£–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
      </div>

      <div class="order-row">
        <button id="adminSaveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–Ω—ã</button>
        <button id="adminReloadBtn" class="ghost">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
    </section>

    <section id="broadcastCard" class="card tab-panel tab-hidden">
      <strong>üì£ –†–∞—Å—Å—ã–ª–∫–∞</strong>
      <p class="small" style="margin-top:8px;">
        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–Ω—ã–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏, —Ä–µ–∂–∏–º–∞–º–∏ —Ä–∞–±–æ—Ç—ã –∏ –º–∞—Å—Å–æ–≤—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.
      </p>
      <div id="broadcastAccessHint" class="access-note" style="margin-top:8px;"></div>

      <div class="mini-block">
        <strong style="display:block;">–†–µ–∂–∏–º update-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</strong>
        <div class="state-line">
          <span id="adminUpdateModeBadge" class="state-pill info">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <div class="order-row">
          <button id="adminToggleUpdateModeBtn" class="ghost">üîÅ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ/—Ä—É—á–Ω–æ–π</button>
          <button id="adminSendUpdateNoticeBtn" class="ghost">üÜï –†–∞–∑–æ—Å–ª–∞—Ç—å update-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
        </div>
      </div>

      <div class="mini-block">
        <strong style="display:block;">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã</strong>
        <div class="state-line">
          <span id="adminMaintenanceBadge" class="state-pill info">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <div class="order-row">
          <button id="adminToggleMaintenanceBtn" class="ghost">üöß –í–∫–ª/–≤—ã–∫–ª —Ç–µ—Ö—Ä–∞–±–æ—Ç—ã</button>
        </div>
      </div>

      <div class="mini-block">
        <strong style="display:block;">üõ° –ê–Ω—Ç–∏–∞–±—É–∑ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –º–µ–Ω—é)</strong>
        <p class="small" style="margin:8px 0 0;">
          –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ø–∞–º–∞ –∑–∞–∫–∞–∑–æ–≤ –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö trial. –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Å—Ä–∞–∑—É, –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞.
        </p>
        <p class="small" style="margin:6px 0 0;">
          –ù–∏–∂–µ –æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã. –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω—ã, –æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
        </p>
        <div class="state-line">
          <span id="adminAntiabuseBadge" class="state-pill info">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <div class="admin-plan-grid">
          <div class="field">
            <label for="adminAbSoftEnabled">–†–µ–∂–∏–º –∑–∞—â–∏—Ç—ã</label>
            <select id="adminAbSoftEnabled">
              <option value="1">–í–∫–ª—é—á–µ–Ω (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</option>
              <option value="0">–í—ã–∫–ª—é—á–µ–Ω</option>
            </select>
            <div class="small">–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω, –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è.</div>
          </div>
          <div class="field">
            <label for="adminAbThreshold">–ü–æ—Ä–æ–≥ –Ω–∞—Ä—É—à–µ–Ω–∏–π (strikes)</label>
            <input id="adminAbThreshold" type="number" min="2" max="50" value="4">
            <div class="small">–°–∫–æ–ª—å–∫–æ –Ω–∞—Ä—É—à–µ–Ω–∏–π –Ω—É–∂–Ω–æ –Ω–∞–±—Ä–∞—Ç—å –¥–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.</div>
          </div>
          <div class="field">
            <label for="adminAbStrikeWindow">–û–∫–Ω–æ –Ω–∞—Ä—É—à–µ–Ω–∏–π (—Å–µ–∫.)</label>
            <input id="adminAbStrikeWindow" type="number" min="300" max="604800" value="86400">
            <div class="small">–ó–∞ –∫–∞–∫–æ–π –ø–µ—Ä–∏–æ–¥ —Å—É–º–º–∏—Ä—É—é—Ç—Å—è –Ω–∞—Ä—É—à–µ–Ω–∏—è.</div>
          </div>
          <div class="field">
            <label for="adminAbSoftBlockSeconds">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (—Å–µ–∫.)</label>
            <input id="adminAbSoftBlockSeconds" type="number" min="60" max="86400" value="1800">
            <div class="small">–ù–∞ —Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞/trial.</div>
          </div>
          <div class="field">
            <label for="adminAbFpMaxUsers">–õ–∏–º–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –æ–¥–∏–Ω fingerprint</label>
            <input id="adminAbFpMaxUsers" type="number" min="1" max="10" value="2">
            <div class="small">–ï—Å–ª–∏ –æ–¥–∏–Ω –æ—Ç–ø–µ—á–∞—Ç–æ–∫ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —É –±–æ–ª—å—à–µ–≥–æ —á–∏—Å–ª–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤, trial –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è.</div>
          </div>
          <div class="field">
            <label for="adminAbFpDays">–ü–µ—Ä–∏–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ fingerprint (–¥–Ω–µ–π)</label>
            <input id="adminAbFpDays" type="number" min="1" max="365" value="30">
            <div class="small">–ó–∞ —Å–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è fingerprint.</div>
          </div>
        </div>
        <div class="order-row">
          <button id="adminAntiabuseSaveBtn" class="ghost">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞—â–∏—Ç—ã</button>
          <button id="adminAntiabuseResetBtn" class="ghost">‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ .env</button>
        </div>
      </div>

      <div class="field">
        <label for="adminBroadcastText">–¢–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <textarea id="adminBroadcastText" placeholder="–ï—Å–ª–∏ –ø—É—Å—Ç–æ, –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç –∞–∫—Ü–∏–∏."></textarea>
      </div>
      <div class="order-row">
        <button id="adminSendBroadcastBtn">üì£ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</button>
        <button id="adminRuntimeReloadBtn" class="ghost">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã</button>
      </div>

      <div class="mini-block">
        <strong style="display:block;">üö© –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (—Ñ–ª–∞–≥–∏)</strong>
        <p class="small" style="margin:8px 0 0;">
          –ó–¥–µ—Å—å –≤–∏–¥–Ω—ã –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ê–≤—Ç–æ–±–∞–Ω–∞ –Ω–µ—Ç, —Ç–æ–ª—å–∫–æ —Ä—É—á–Ω–∞—è –º–æ–¥–µ—Ä–∞—Ü–∏—è.
        </p>
        <p class="small" style="margin:6px 0 0;">
          –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã: –æ–±–Ω–æ–≤–∏—Ç–µ —Å–ø–∏—Å–æ–∫ -> –≤–æ–∑—å–º–∏—Ç–µ –Ω–æ–º–µ—Ä <code>#ID</code> -> –∑–∞–∫—Ä–æ–π—Ç–µ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏.
        </p>
        <div class="order-row">
          <button id="adminFlagsReloadBtn" class="ghost">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–ª–∞–≥–æ–≤</button>
        </div>
        <div class="field">
          <label for="adminResolveFlagId">–ù–æ–º–µ—Ä —Ñ–ª–∞–≥–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ (#ID)</label>
          <input id="adminResolveFlagId" type="number" min="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 42">
        </div>
        <div class="order-row">
          <button id="adminResolveFlagBtn" class="ghost">‚úÖ –ó–∞–∫—Ä—ã—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–ª–∞–≥</button>
        </div>
        <div id="adminFlagsList" class="small" style="margin-top:8px; white-space:pre-wrap;"></div>
      </div>
    </section>

    <section id="orderCard" class="card tab-panel tab-hidden">
      <strong>–¢–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑</strong>
      <div id="orderInfo" class="small" style="margin-top:8px;"></div>
      <div id="orderCode" class="mono"></div>
      <div class="order-row">
        <button id="payBtn">üí∏ –û–ø–ª–∞—Ç–∏—Ç—å</button>
        <button id="cryptoPayBtn" class="ghost hidden">‚Çø CryptoBot</button>
        <button id="lztPayBtn" class="ghost hidden">‚ö° LZT Market</button>
        <button id="secondaryPayBtn" class="ghost hidden">ü™ô –†–µ–∑–µ—Ä–≤–Ω–∞—è –æ–ø–ª–∞—Ç–∞</button>
        <button id="checkBtn" class="ghost">‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É</button>
        <button id="cancelBtn" class="ghost">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
        <button id="repeatBtn" class="ghost hidden">üîÅ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑</button>
        <button id="copyBtn" class="ghost">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
      </div>
      <p class="small" style="margin-top:10px;">
        –£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –∫–∞–∫ –≤ –∑–∞–∫–∞–∑–µ. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–∫–æ–¥ –∑–∞–∫–∞–∑–∞) –∂–µ–ª–∞—Ç–µ–ª–µ–Ω, –Ω–æ –µ—Å–ª–∏ –ø–æ–ª—è –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –æ–ø–ª–∞—Ç–∏—Ç–µ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É¬ª.
      </p>
    </section>
  </main>

  <script>
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
      tg.ready();
      tg.expand();
    }

    const initData = tg ? tg.initData : "";
    const urlParams = new URLSearchParams(window.location.search || "");
    const requestedTab = String(urlParams.get("tab") || "").trim().toLowerCase();
    const orderIdFromQuery = String(urlParams.get("order_id") || "").trim().toUpperCase();
    const orderIdFromQueryValid = /^BV-[A-Z0-9_-]{6,80}$/.test(orderIdFromQuery);
    let currentOrderId = "";
    let currentPaymentUrl = "";
    let currentCryptobotPaymentUrl = "";
    let currentCryptobotPaymentLabel = "CryptoBot";
    let currentLztPaymentUrl = "";
    let currentLztPaymentLabel = "LZT Market";
    let currentSecondaryPaymentUrl = "";
    let currentSecondaryPaymentLabel = "–†–µ–∑–µ—Ä–≤–Ω–∞—è –æ–ø–ª–∞—Ç–∞";
    let currentOrderProvider = "cryptobot";
    let currentOrderProviderLabel = "CryptoBot";
    let currentOrderStatus = "pending";
    let autoStatusTimer = null;
    let isAdmin = false;
    let adminLoaded = false;
    let adminUpdateMode = "auto";
    let adminMaintenanceEnabled = false;
    let adminAntiabuseConfig = null;
    let selectedAdminUserId = 0;
    let adminFoundUsers = [];
    let paymentProvider = "cryptobot";
    let paymentProviderLabel = "CryptoBot";
    let plansCache = [];
    let lastPaidPlanCode = "";
    let currentReferralUrl = "";

    const statusEl = document.getElementById("status");
    const profileEl = document.getElementById("profile");
    const activePromoEl = document.getElementById("activePromo");
    const promoCodeInputEl = document.getElementById("promoCodeInput");
    const promoActivateBtn = document.getElementById("promoActivateBtn");
    const quickRenew7Btn = document.getElementById("quickRenew7Btn");
    const quickRenew30Btn = document.getElementById("quickRenew30Btn");
    const quickRenew90Btn = document.getElementById("quickRenew90Btn");
    const quickRenew365Btn = document.getElementById("quickRenew365Btn");
    const quickRenewLastBtn = document.getElementById("quickRenewLastBtn");
    const plansEl = document.getElementById("plans");
    const referralsCardEl = document.getElementById("referralsCard");
    const accountTabBtnEl = document.getElementById("accountTabBtn");
    const plansTabBtnEl = document.getElementById("plansTabBtn");
    const referralLinkEl = document.getElementById("referralLink");
    const referralHintEl = document.getElementById("referralHint");
    const referralCopyBtn = document.getElementById("referralCopyBtn");
    const referralShareBtn = document.getElementById("referralShareBtn");
    const accountCardEl = document.getElementById("accountCard");
    const plansCardEl = document.getElementById("plansCard");
    const tabButtons = Array.from(document.querySelectorAll(".tab-btn[data-tab-target]"));
    const referralsTabBtnEl = document.getElementById("referralsTabBtn");
    const adminTabBtnEl = document.getElementById("adminTabBtn");
    const broadcastTabBtnEl = document.getElementById("broadcastTabBtn");
    const orderTabBtnEl = document.getElementById("orderTabBtn");
    const adminCardEl = document.getElementById("adminCard");
    const broadcastCardEl = document.getElementById("broadcastCard");
    const adminAccessHintEl = document.getElementById("adminAccessHint");
    const broadcastAccessHintEl = document.getElementById("broadcastAccessHint");
    const adminGlobalDiscountEl = document.getElementById("adminGlobalDiscount");
    const adminSaleTitleEl = document.getElementById("adminSaleTitle");
    const adminSaleMessageEl = document.getElementById("adminSaleMessage");
    const adminPlansEl = document.getElementById("adminPlans");
    const adminPromoCodeEl = document.getElementById("adminPromoCode");
    const adminPromoDiscountEl = document.getElementById("adminPromoDiscount");
    const adminPromoExpiresEl = document.getElementById("adminPromoExpires");
    const adminPromoMaxActivationsEl = document.getElementById("adminPromoMaxActivations");
    const adminPromoSaveBtn = document.getElementById("adminPromoSaveBtn");
    const adminPromoReloadBtn = document.getElementById("adminPromoReloadBtn");
    const adminPromoManageCodeEl = document.getElementById("adminPromoManageCode");
    const adminPromoExtendDaysEl = document.getElementById("adminPromoExtendDays");
    const adminPromoSetExpiryEl = document.getElementById("adminPromoSetExpiry");
    const adminPromoExtendBtn = document.getElementById("adminPromoExtendBtn");
    const adminPromoSetExpiryBtn = document.getElementById("adminPromoSetExpiryBtn");
    const adminPromoDeleteBtn = document.getElementById("adminPromoDeleteBtn");
    const adminPromoShowArchivedEl = document.getElementById("adminPromoShowArchived");
    const adminPromoListEl = document.getElementById("adminPromoList");
    const adminUserQueryEl = document.getElementById("adminUserQuery");
    const adminUserSearchBtn = document.getElementById("adminUserSearchBtn");
    const adminUserResultsEl = document.getElementById("adminUserResults");
    const adminSelectedUserEl = document.getElementById("adminSelectedUser");
    const adminGrantDaysEl = document.getElementById("adminGrantDays");
    const adminGrantBtn = document.getElementById("adminGrantBtn");
    const adminRemoveSubBtn = document.getElementById("adminRemoveSubBtn");
    const adminSaveBtn = document.getElementById("adminSaveBtn");
    const adminReloadBtn = document.getElementById("adminReloadBtn");
    const adminBroadcastTextEl = document.getElementById("adminBroadcastText");
    const adminSendBroadcastBtn = document.getElementById("adminSendBroadcastBtn");
    const adminRuntimeReloadBtn = document.getElementById("adminRuntimeReloadBtn");
    const adminUpdateModeBadgeEl = document.getElementById("adminUpdateModeBadge");
    const adminMaintenanceBadgeEl = document.getElementById("adminMaintenanceBadge");
    const adminToggleUpdateModeBtn = document.getElementById("adminToggleUpdateModeBtn");
    const adminSendUpdateNoticeBtn = document.getElementById("adminSendUpdateNoticeBtn");
    const adminToggleMaintenanceBtn = document.getElementById("adminToggleMaintenanceBtn");
    const adminAntiabuseBadgeEl = document.getElementById("adminAntiabuseBadge");
    const adminAbSoftEnabledEl = document.getElementById("adminAbSoftEnabled");
    const adminAbSoftBlockSecondsEl = document.getElementById("adminAbSoftBlockSeconds");
    const adminAbThresholdEl = document.getElementById("adminAbThreshold");
    const adminAbStrikeWindowEl = document.getElementById("adminAbStrikeWindow");
    const adminAbWeightOrderEl = document.getElementById("adminAbWeightOrder");
    const adminAbWeightTrialEl = document.getElementById("adminAbWeightTrial");
    const adminAbWeightUsernameEl = document.getElementById("adminAbWeightUsername");
    const adminAbFpDaysEl = document.getElementById("adminAbFpDays");
    const adminAbFpMaxUsersEl = document.getElementById("adminAbFpMaxUsers");
    const adminAntiabuseSaveBtn = document.getElementById("adminAntiabuseSaveBtn");
    const adminAntiabuseResetBtn = document.getElementById("adminAntiabuseResetBtn");
    const adminFlagsReloadBtn = document.getElementById("adminFlagsReloadBtn");
    const adminResolveFlagIdEl = document.getElementById("adminResolveFlagId");
    const adminResolveFlagBtn = document.getElementById("adminResolveFlagBtn");
    const adminFlagsListEl = document.getElementById("adminFlagsList");
    const orderCardEl = document.getElementById("orderCard");
    const orderInfoEl = document.getElementById("orderInfo");
    const orderCodeEl = document.getElementById("orderCode");
    const payBtn = document.getElementById("payBtn");
    const cryptoPayBtn = document.getElementById("cryptoPayBtn");
    const lztPayBtn = document.getElementById("lztPayBtn");
    const secondaryPayBtn = document.getElementById("secondaryPayBtn");
    const checkBtn = document.getElementById("checkBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const repeatBtn = document.getElementById("repeatBtn");
    const copyBtn = document.getElementById("copyBtn");

    const tabPanels = [
      accountCardEl,
      plansCardEl,
      referralsCardEl,
      orderCardEl,
      adminCardEl,
      broadcastCardEl,
    ].filter(Boolean);

    function setStatus(text, kind) {
      statusEl.textContent = text;
      statusEl.className = "status";
      if (kind === "ok") statusEl.classList.add("ok");
      if (kind === "err") statusEl.classList.add("err");
      if (kind === "busy") statusEl.classList.add("busy");
    }

    const REQUEST_TIMEOUT_MS = 15000;
    const ACTIVE_TAB_STORAGE_KEY = "boxvolt_webapp_tab";
    const actionLocks = new Set();

    function readableErrorText(code) {
      const key = String(code || "").trim();
      if (!key) return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
      if (key === "request_timeout") return "–ü—Ä–µ–≤—ã—à–µ–Ω —Ç–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É.";
      if (key === "network_error") return "–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ.";
      if (key === "bad_json_response") return "–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç.";
      if (key === "init_data_required") return "–û—Ç–∫—Ä–æ–π—Ç–µ Mini App —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞.";
      if (key === "unauthorized") return "–°–µ—Å—Å–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞. –ó–∞–∫—Ä–æ–π—Ç–µ –∏ –∑–∞–Ω–æ–≤–æ –æ—Ç–∫—Ä–æ–π—Ç–µ Mini App.";
      if (key.startsWith("http_")) return `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${key.replace("http_", "")}).`;
      return key;
    }

    function errorMessageFromAny(err) {
      if (!err) return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
      if (err instanceof Error && err.message) return String(err.message);
      return readableErrorText(String(err));
    }

    async function requestJson(url, method, payload) {
      const options = { method, headers: { "Content-Type": "application/json" } };
      if (payload) options.body = JSON.stringify(payload);
      const controller = new AbortController();
      options.signal = controller.signal;
      const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT_MS);
      let res;
      try {
        res = await fetch(url, options);
      } catch (fetchErr) {
        const code = fetchErr && fetchErr.name === "AbortError" ? "request_timeout" : "network_error";
        const err = new Error(readableErrorText(code));
        err.code = code;
        throw err;
      } finally {
        clearTimeout(timeoutId);
      }
      let data = {};
      try {
        data = await res.json();
      } catch (_) {
        const code = "bad_json_response";
        const err = new Error(readableErrorText(code));
        err.code = code;
        throw err;
      }
      if (!res.ok || data.ok === false) {
        const code = String(data.error || ("http_" + res.status));
        const err = new Error(readableErrorText(code));
        err.code = code;
        err.details = data;
        throw err;
      }
      return data;
    }

    function rememberActiveTab(targetId) {
      try {
        if (targetId) window.localStorage.setItem(ACTIVE_TAB_STORAGE_KEY, String(targetId));
      } catch (_) {}
    }

    function readRememberedTab() {
      try {
        return String(window.localStorage.getItem(ACTIVE_TAB_STORAGE_KEY) || "").trim();
      } catch (_) {
        return "";
      }
    }

    async function runButtonAction(button, lockKey, busyText, action) {
      if (!button) return;
      const key = String(lockKey || button.id || "action");
      if (actionLocks.has(key)) return;
      actionLocks.add(key);
      const wasDisabled = !!button.disabled;
      button.disabled = true;
      button.classList.add("is-loading");
      if (busyText) setStatus(busyText, "busy");
      try {
        await action();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞: " + errorMessageFromAny(err), "err");
      } finally {
        actionLocks.delete(key);
        button.classList.remove("is-loading");
        if (!wasDisabled) {
          button.disabled = false;
        }
        updateOrderActionButtons();
        refreshQuickRenewButtons();
      }
    }

    function resolveTabFromQuery() {
      const map = {
        account: "accountCard",
        plans: "plansCard",
        tariffs: "plansCard",
        referrals: "referralsCard",
        referral: "referralsCard",
        bonuses: "referralsCard",
        order: "orderCard",
        admin: "adminCard",
        broadcast: "broadcastCard",
        mailing: "broadcastCard",
      };
      return map[requestedTab] || "";
    }

    function getCurrentActiveTabTarget() {
      const activeBtn = tabButtons.find((item) => item.classList.contains("is-active"));
      return activeBtn ? String(activeBtn.dataset.tabTarget || "") : "";
    }

    function switchTab(targetId) {
      const wanted = String(targetId || "").trim();
      if (!wanted) return;
      const panel = document.getElementById(wanted);
      if (!panel || panel.classList.contains("hidden")) return;

      tabButtons.forEach((btn) => {
        const isActive = btn.dataset.tabTarget === wanted;
        btn.classList.toggle("is-active", isActive);
      });
      tabPanels.forEach((item) => {
        if (item.id === wanted) item.classList.remove("tab-hidden");
        else item.classList.add("tab-hidden");
      });
      rememberActiveTab(wanted);
    }

    function ensureValidTab(preferredId = "accountCard") {
      const activeId = getCurrentActiveTabTarget();
      const candidates = [
        activeId,
        preferredId,
        "accountCard",
        "plansCard",
        "referralsCard",
        "adminCard",
        "broadcastCard",
        "orderCard",
      ];
      for (const targetId of candidates) {
        if (!targetId) continue;
        const panel = document.getElementById(targetId);
        const btn = tabButtons.find((item) => item.dataset.tabTarget === targetId);
        if (!panel || !btn) continue;
        if (panel.classList.contains("hidden") || btn.classList.contains("hidden")) continue;
        switchTab(targetId);
        return;
      }
    }

    function syncOrderTabVisibility() {
      if (!orderTabBtnEl) return;
      const hasOrder = !!String(currentOrderId || "").trim();
      orderTabBtnEl.classList.toggle("hidden", !hasOrder);
      if (!hasOrder && getCurrentActiveTabTarget() === "orderCard") {
        ensureValidTab("plansCard");
      }
    }

    function setCoreTabsVisible() {
      [accountTabBtnEl, plansTabBtnEl, referralsTabBtnEl].forEach((btn) => {
        if (btn) btn.classList.remove("hidden");
      });
      [accountCardEl, plansCardEl, referralsCardEl].forEach((panel) => {
        if (panel) panel.classList.remove("hidden");
      });
    }

    function setPanelLocked(panel, locked) {
      if (!panel) return;
      const isLocked = !!locked;
      panel.classList.toggle("is-locked", isLocked);
      const controls = panel.querySelectorAll("input, textarea, select, button");
      controls.forEach((control) => {
        control.disabled = isLocked;
      });
    }

    function setAccessHint(el, text, warning) {
      if (!el) return;
      el.textContent = text;
      el.classList.toggle("warn", !!warning);
    }

    function setAdminVisible(visible) {
      const allowed = !!visible;
      adminCardEl.classList.toggle("hidden", !allowed);
      adminTabBtnEl.classList.toggle("hidden", !allowed);
      broadcastCardEl.classList.toggle("hidden", !allowed);
      broadcastTabBtnEl.classList.toggle("hidden", !allowed);
      if (!allowed) {
        adminCardEl.classList.add("tab-hidden");
        broadcastCardEl.classList.add("tab-hidden");
      }
      setPanelLocked(adminCardEl, !allowed);
      setPanelLocked(broadcastCardEl, !allowed);
      setAccessHint(
        adminAccessHintEl,
        allowed
          ? "–î–æ—Å—Ç—É–ø –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∞–∫—Ç–∏–≤–µ–Ω. –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –¥–æ—Å—Ç—É–ø–Ω—ã."
          : "–†–∞–∑–¥–µ–ª –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º. –í–æ–π–¥–∏—Ç–µ –ø–æ–¥ –∞–¥–º–∏–Ω-–∞–∫–∫–∞—É–Ω—Ç–æ–º –≤ –±–æ—Ç–µ.",
        !allowed
      );
      setAccessHint(
        broadcastAccessHintEl,
        allowed
          ? "–î–æ—Å—Ç—É–ø –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∞–∫—Ç–∏–≤–µ–Ω. –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞—Å—Å—ã–ª–∫–∏ –∏ –º–µ–Ω—è—Ç—å —Ä–µ–∂–∏–º—ã."
          : "–†–∞–∑–¥–µ–ª –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º. –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —ç—Ç–æ —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.",
        !allowed
      );
      if (!allowed) {
        ensureValidTab("accountCard");
      }
    }

    function toInt(value, fallback = 0) {
      const parsed = Number.parseInt(String(value), 10);
      return Number.isFinite(parsed) ? parsed : fallback;
    }

    function escapeHtml(value) {
      const text = String(value ?? "");
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function buildReferralUrl(telegramId) {
      const id = toInt(telegramId, 0);
      if (id <= 0) return "";
      return `https://t.me/BoxVoltVPN_bot?start=ref${id}`;
    }

    function renderReferralLink(telegramId) {
      if (!referralLinkEl) return;
      const url = buildReferralUrl(telegramId);
      currentReferralUrl = url;
      referralLinkEl.textContent = url || "–°—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Mini App.";
      if (referralHintEl) {
        referralHintEl.textContent = url
          ? "–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–∑—å—è–º."
          : "–û—Ç–∫—Ä–æ–π—Ç–µ Mini App —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ª–∏—á–Ω—É—é —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É.";
      }
    }

    function promoErrorText(code) {
      const map = {
        bad_code_format: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø—Ä–æ–º–æ–∫–æ–¥–∞.",
        promo_not_found: "–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω.",
        promo_inactive: "–ü—Ä–æ–º–æ–∫–æ–¥ –æ—Ç–∫–ª—é—á–µ–Ω.",
        promo_expired: "–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—Ç–µ–∫.",
        promo_limit_reached: "–õ–∏–º–∏—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–π –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—á–µ—Ä–ø–∞–Ω.",
        promo_already_activated: "–í—ã —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥."
      };
      return map[code] || ("–û—à–∏–±–∫–∞: " + code);
    }

    function adminPromoErrorText(code) {
      const map = {
        bad_code_format: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞.",
        promo_not_found: "–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω.",
        bad_expiry_format: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ YYYY-MM-DD HH:MM.",
        bad_extend_days: "–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π (>= 1).",
      };
      return map[code] || promoErrorText(code);
    }

    function adminPromoIncludeArchived() {
      return toBool(adminPromoShowArchivedEl ? adminPromoShowArchivedEl.value : "0");
    }

    function adminPromoTargetCode() {
      const manageCode = String(adminPromoManageCodeEl ? adminPromoManageCodeEl.value : "").trim();
      const createCode = String(adminPromoCodeEl ? adminPromoCodeEl.value : "").trim();
      return (manageCode || createCode).toUpperCase();
    }

    function toBool(value) {
      if (typeof value === "boolean") return value;
      const normalized = String(value || "").trim().toLowerCase();
      return normalized === "1" || normalized === "true" || normalized === "yes" || normalized === "on";
    }

    function updateModeTitle(mode) {
      return mode === "manual"
        ? "–†—É—á–Ω–æ–π —Ä–µ–∂–∏–º: –∞–≤—Ç–æ-—Ä–∞—Å—Å—ã–ª–∫–∞ update –æ—Ç–∫–ª—é—á–µ–Ω–∞"
        : "–ê–≤—Ç–æ —Ä–µ–∂–∏–º: update-—Ä–∞—Å—Å—ã–ª–∫–∞ –ø—Ä–∏ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö –≤–∫–ª—é—á–µ–Ω–∞";
    }

    function maintenanceTitle(enabled) {
      return enabled
        ? "–¢–µ—Ö—Ä–∞–±–æ—Ç—ã: –≤–∫–ª—é—á–µ–Ω—ã (–≤—ã–¥–∞—á–∞/–ø–µ—Ä–µ–≤—ã–ø—É—Å–∫ –∫–ª—é—á–µ–π –≤ –±–æ—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã)"
        : "–¢–µ—Ö—Ä–∞–±–æ—Ç—ã: –≤—ã–∫–ª—é—á–µ–Ω—ã (–≤—ã–¥–∞—á–∞/–ø–µ—Ä–µ–≤—ã–ø—É—Å–∫ –∫–ª—é—á–µ–π –¥–æ—Å—Ç—É–ø–Ω—ã)";
    }

    function antiabuseTitle(config) {
      if (!config || typeof config !== "object") {
        return "–ê–Ω—Ç–∏–∞–±—É–∑: –∫–æ–Ω—Ñ–∏–≥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω";
      }
      const enabled = toBool(config.soft_block_enabled);
      const threshold = toInt(config.soft_block_threshold, 0);
      const softSec = toInt(config.soft_block_seconds, 0);
      const strikeWindow = toInt(config.strike_window_seconds, 0);
      const fpDays = toInt(config.trial_fingerprint_window_days, 0);
      const fpUsers = toInt(config.trial_fingerprint_max_users, 0);
      if (!enabled) {
        return "–ê–Ω—Ç–∏–∞–±—É–∑ –≤—ã–∫–ª—é—á–µ–Ω";
      }
      return `–ê–Ω—Ç–∏–∞–±—É–∑ –≤–∫–ª—é—á–µ–Ω: –±–ª–æ–∫ –ø–æ—Å–ª–µ ${threshold} –Ω–∞—Ä—É—à–µ–Ω–∏–π –∑–∞ ${strikeWindow} —Å–µ–∫, –±–ª–æ–∫ ${softSec} —Å–µ–∫, fingerprint ${fpUsers} –ø–æ–ª—å–∑. –∑–∞ ${fpDays} –¥–Ω`;
    }

    function renderAdminAntiabuseConfig(config) {
      const safe = config && typeof config === "object" ? config : {};
      adminAntiabuseConfig = Object.assign({}, safe);
      if (adminAbSoftEnabledEl) {
        adminAbSoftEnabledEl.value = toBool(safe.soft_block_enabled) ? "1" : "0";
      }
      if (adminAbSoftBlockSecondsEl) {
        adminAbSoftBlockSecondsEl.value = String(toInt(safe.soft_block_seconds, 1800));
      }
      if (adminAbThresholdEl) {
        adminAbThresholdEl.value = String(toInt(safe.soft_block_threshold, 4));
      }
      if (adminAbStrikeWindowEl) {
        adminAbStrikeWindowEl.value = String(toInt(safe.strike_window_seconds, 86400));
      }
      if (adminAbWeightOrderEl) {
        adminAbWeightOrderEl.value = String(toInt(safe.strike_weight_order_spam, 1));
      }
      if (adminAbWeightTrialEl) {
        adminAbWeightTrialEl.value = String(toInt(safe.strike_weight_trial_reuse, 2));
      }
      if (adminAbWeightUsernameEl) {
        adminAbWeightUsernameEl.value = String(toInt(safe.strike_weight_username_pattern, 1));
      }
      if (adminAbFpDaysEl) {
        adminAbFpDaysEl.value = String(toInt(safe.trial_fingerprint_window_days, 30));
      }
      if (adminAbFpMaxUsersEl) {
        adminAbFpMaxUsersEl.value = String(toInt(safe.trial_fingerprint_max_users, 2));
      }
      if (adminAntiabuseBadgeEl) {
        adminAntiabuseBadgeEl.textContent = antiabuseTitle(safe);
        adminAntiabuseBadgeEl.className = "state-pill";
        adminAntiabuseBadgeEl.classList.add(toBool(safe.soft_block_enabled) ? "ok" : "warn");
      }
    }

    function renderAdminRuntimeState(state) {
      adminUpdateMode = String(state.update_notify_mode || "auto").trim().toLowerCase() === "manual"
        ? "manual"
        : "auto";
      adminMaintenanceEnabled = toBool(state.maintenance_mode);

      if (adminUpdateModeBadgeEl) {
        adminUpdateModeBadgeEl.textContent = updateModeTitle(adminUpdateMode);
        adminUpdateModeBadgeEl.className = "state-pill";
        adminUpdateModeBadgeEl.classList.add(adminUpdateMode === "manual" ? "warn" : "ok");
      }

      if (adminMaintenanceBadgeEl) {
        adminMaintenanceBadgeEl.textContent = maintenanceTitle(adminMaintenanceEnabled);
        adminMaintenanceBadgeEl.className = "state-pill";
        adminMaintenanceBadgeEl.classList.add(adminMaintenanceEnabled ? "warn" : "ok");
      }
      renderAdminAntiabuseConfig(state.antiabuse_config || {});
    }

    function renderAdminPromocodes(promocodes) {
      if (!adminPromoListEl) return;
      const items = (promocodes || []).map((promo) => {
        const limit = Number(promo.max_activations || 0) > 0
          ? `${promo.total_activations || 0}/${promo.max_activations}`
          : `${promo.total_activations || 0}/‚àû`;
        const used = Number(promo.used_activations || 0);
        const state = String(promo.status || "").trim() || (promo.is_expired ? "expired" : (promo.is_active ? "active" : "inactive"));
        const stateLabelMap = {
          active: "–∞–∫—Ç–∏–≤–µ–Ω",
          expired: "–∏—Å—Ç–µ–∫",
          limit_reached: "–ª–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω",
          inactive: "–≤—ã–∫–ª"
        };
        const stateLabel = stateLabelMap[state] || state;
        return `‚Ä¢ ${promo.code}: -${promo.discount_rub} ‚ÇΩ, –¥–æ ${promo.expires_at}, –∞–∫—Ç–∏–≤–∞—Ü–∏–π ${limit}, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ ${used}, —Å—Ç–∞—Ç—É—Å ${stateLabel}`;
      });
      adminPromoListEl.textContent = items.length ? items.join("\n") : "–ü—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.";
    }

    function renderAdminFlags(flags) {
      if (!adminFlagsListEl) return;
      const flagLabels = {
        order_rate_limited: "–ß–∞—Å—Ç—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑",
        order_spam_attempt: "–ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ –Ω–∞ —Å–ø–∞–º –∑–∞–∫–∞–∑–æ–≤",
        payment_underpaid_attempt: "–ü–æ–ø—ã—Ç–∫–∞ –Ω–µ–¥–æ–ø–ª–∞—Ç—ã",
        trial_rate_limited: "–°–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–π –∑–∞–ø—Ä–æ—Å trial",
        trial_soft_blocked: "–°—Ä–∞–±–æ—Ç–∞–ª–∞ soft-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ trial",
        trial_reuse_attempt: "–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –≤–∑—è—Ç—å trial",
        trial_username_pattern: "–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π username –¥–ª—è trial",
        trial_fingerprint_reuse: "Fingerprint –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è —É —Ä–∞–∑–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤",
        antiabuse_soft_block: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø–∞–ª –≤ soft-–±–ª–æ–∫",
        blacklist_access_attempt: "–ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –æ—Ç blacklist-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
      };
      const rows = (flags || []).map((flag) => {
        const flagType = String(flag.flag_type || "").trim();
        const flagTypeLabel = flagLabels[flagType] || flagType || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–ª–∞–≥";
        const seen = toInt(flag.seen_count, 1);
        const lastSeen = String(flag.last_seen_at || flag.created_at || "-").trim() || "-";
        const details = String(flag.details || "").trim();
        const lines = [
          `#${flag.id} | tg:${flag.telegram_id}`,
          `–¢–∏–ø: ${flagTypeLabel}${flagType ? ` (${flagType})` : ""}`,
          `–ü–æ–≤—Ç–æ—Ä–æ–≤: ${seen} | –ü–æ—Å–ª–µ–¥–Ω–∏–π: ${lastSeen}`,
        ];
        if (details) {
          lines.push(`–î–µ—Ç–∞–ª–∏: ${details}`);
        }
        return lines.join("\n");
      });
      adminFlagsListEl.textContent = rows.length ? rows.join("\n\n") : "–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤ –Ω–µ—Ç.";
    }

    function findPlanCodeByDays(days) {
      const targetDays = Number(days);
      if (!Number.isFinite(targetDays) || targetDays <= 0) return "";
      for (const plan of plansCache || []) {
        if (Number(plan.days || 0) === targetDays) {
          return String(plan.code || "");
        }
      }
      return "";
    }

    function refreshQuickRenewButtons() {
      const code7 = findPlanCodeByDays(7);
      const code30 = findPlanCodeByDays(30);
      const code90 = findPlanCodeByDays(90);
      const code365 = findPlanCodeByDays(365);

      if (quickRenew7Btn) quickRenew7Btn.disabled = !code7;
      if (quickRenew30Btn) quickRenew30Btn.disabled = !code30;
      if (quickRenew90Btn) quickRenew90Btn.disabled = !code90;
      if (quickRenew365Btn) quickRenew365Btn.disabled = !code365;
      if (quickRenewLastBtn) {
        quickRenewLastBtn.disabled = !lastPaidPlanCode;
        quickRenewLastBtn.textContent = lastPaidPlanCode
          ? "üîÅ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ—à–ª—ã–π —Ç–∞—Ä–∏—Ñ"
          : "üîÅ –ü—Ä–æ—à–ª—ã–π —Ç–∞—Ä–∏—Ñ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω";
      }
    }

    function updateSelectedUserView() {
      if (!adminSelectedUserEl) return;
      if (!selectedAdminUserId) {
        adminSelectedUserEl.textContent = "–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –Ω–µ—Ç";
        return;
      }
      const user = adminFoundUsers.find((item) => Number(item.telegram_id) === Number(selectedAdminUserId));
      if (!user) {
        adminSelectedUserEl.textContent = `–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ID ${selectedAdminUserId}`;
        return;
      }
      const username = user.username ? "@" + user.username : "-";
      const sub = user.subscription_active
        ? `–∞–∫—Ç–∏–≤–Ω–∞ –¥–æ ${user.subscription_end || "-"}`
        : "–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞";
      adminSelectedUserEl.textContent = `–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.telegram_id} (${username}), –ø–æ–¥–ø–∏—Å–∫–∞ ${sub}`;
    }

    function renderAdminUsers(users) {
      adminFoundUsers = Array.isArray(users) ? users : [];
      if (!adminUserResultsEl) return;
      if (!adminFoundUsers.length) {
        adminUserResultsEl.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.";
        selectedAdminUserId = 0;
        updateSelectedUserView();
        return;
      }

      adminUserResultsEl.innerHTML = "";
      adminFoundUsers.forEach((user) => {
        const username = user.username ? "@" + user.username : "-";
        const sub = user.subscription_active
          ? `–∞–∫—Ç–∏–≤–Ω–∞ –¥–æ ${user.subscription_end || "-"}`
          : "–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞";
        const line = document.createElement("div");
        line.className = "order-row";
        const btn = document.createElement("button");
        btn.className = "ghost";
        btn.textContent = `ID ${user.telegram_id} | ${username} | ${sub}`;
        btn.onclick = () => {
          selectedAdminUserId = Number(user.telegram_id);
          updateSelectedUserView();
          setStatus(`–í—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${selectedAdminUserId}.`, "ok");
        };
        line.appendChild(btn);
        adminUserResultsEl.appendChild(line);
      });
      if (!selectedAdminUserId && adminFoundUsers.length) {
        selectedAdminUserId = Number(adminFoundUsers[0].telegram_id || 0);
      }
      updateSelectedUserView();
    }

    function renderAdminPlans(plans) {
      adminPlansEl.innerHTML = "";
      (plans || []).forEach((plan) => {
        const row = document.createElement("div");
        row.className = "admin-plan";
        row.dataset.code = plan.code || "";
        const safeCode = escapeHtml(plan.code || "-");
        const safeTitle = escapeHtml(plan.title || "");
        const safeDays = toInt(plan.days, 1);
        const safeAmount = toInt(plan.amount_rub, 1);
        const safeDiscount = toInt(plan.discount_percent, 0);
        row.innerHTML = `
          <div class="admin-plan-head">–ö–æ–¥: ${safeCode}</div>
          <div class="admin-plan-grid">
            <div class="field">
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input class="admin-title" type="text" value="${safeTitle}">
            </div>
            <div class="field">
              <label>–î–Ω–µ–π</label>
              <input class="admin-days" type="number" min="1" max="3650" value="${safeDays}">
            </div>
            <div class="field">
              <label>–¶–µ–Ω–∞ (‚ÇΩ)</label>
              <input class="admin-amount" type="number" min="1" max="100000" value="${safeAmount}">
            </div>
            <div class="field">
              <label>–°–∫–∏–¥–∫–∞ –ø–ª–∞–Ω–∞ (%)</label>
              <input class="admin-discount" type="number" min="0" max="90" value="${safeDiscount}">
            </div>
          </div>
        `;
        adminPlansEl.appendChild(row);
      });
    }

    function collectAdminPricing() {
      const rows = Array.from(adminPlansEl.querySelectorAll(".admin-plan"));
      const plans = rows.map((row) => ({
        code: String(row.dataset.code || "").trim().toLowerCase(),
        title: String(row.querySelector(".admin-title")?.value || "").trim(),
        days: toInt(row.querySelector(".admin-days")?.value, 1),
        amount_rub: toInt(row.querySelector(".admin-amount")?.value, 1),
        discount_percent: toInt(row.querySelector(".admin-discount")?.value, 0)
      }));

      return {
        global_discount_percent: toInt(adminGlobalDiscountEl.value, 0),
        sale_title: String(adminSaleTitleEl.value || "").trim(),
        sale_message: String(adminSaleMessageEl.value || "").trim(),
        plans
      };
    }

    function applyAdminPricing(pricing) {
      adminGlobalDiscountEl.value = pricing.global_discount_percent ?? 0;
      adminSaleTitleEl.value = pricing.sale_title || "";
      adminSaleMessageEl.value = pricing.sale_message || "";
      renderAdminPlans(pricing.plans || []);
    }

    async function loadAdminPanel() {
      if (!isAdmin) return;
      const data = await requestJson("/webapp/api/admin/pricing", "POST", { init_data: initData });
      applyAdminPricing(data.pricing || {});
      await Promise.all([
        loadAdminPromocodes(),
        loadAdminRuntimeState(),
        loadAdminFlags(),
      ]);
      adminLoaded = true;
    }

    async function saveAdminPricing() {
      if (!isAdmin) return;
      const pricing = collectAdminPricing();
      const data = await requestJson("/webapp/api/admin/save-pricing", "POST", {
        init_data: initData,
        pricing
      });
      applyAdminPricing(data.pricing || {});
      await loadPlans();
      setStatus("–¶–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.", "ok");
    }

    async function adminNotify() {
      if (!isAdmin) return;
      const text = String(adminBroadcastTextEl.value || "").trim();
      const data = await requestJson("/webapp/api/admin/notify", "POST", {
        init_data: initData,
        text
      });
      setStatus(`–†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: ${data.sent}, –æ—à–∏–±–æ–∫: ${data.failed}.`, "ok");
      adminBroadcastTextEl.value = "";
    }

    async function loadAdminRuntimeState() {
      if (!isAdmin) return;
      const data = await requestJson("/webapp/api/admin/runtime-state", "POST", {
        init_data: initData
      });
      renderAdminRuntimeState(data);
    }

    async function adminToggleUpdateMode() {
      if (!isAdmin) return;
      const nextMode = adminUpdateMode === "manual" ? "auto" : "manual";
      const data = await requestJson("/webapp/api/admin/set-update-mode", "POST", {
        init_data: initData,
        mode: nextMode
      });
      renderAdminRuntimeState(data);
      const modeLabel = adminUpdateMode === "manual" ? "—Ä—É—á–Ω–æ–π" : "–∞–≤—Ç–æ";
      setStatus(`–†–µ–∂–∏–º update-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: ${modeLabel}.`, "ok");
    }

    async function adminSendUpdateNotice() {
      if (!isAdmin) return;
      const data = await requestJson("/webapp/api/admin/send-update-notice", "POST", {
        init_data: initData
      });
      setStatus(
        `Update-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${data.sent}, –æ—à–∏–±–æ–∫: ${data.failed}.`,
        "ok"
      );
    }

    async function adminToggleMaintenance() {
      if (!isAdmin) return;
      const data = await requestJson("/webapp/api/admin/set-maintenance", "POST", {
        init_data: initData,
        enabled: !adminMaintenanceEnabled
      });
      renderAdminRuntimeState(data);
      const prefix = adminMaintenanceEnabled
        ? "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã –≤–∫–ª—é—á–µ–Ω—ã."
        : "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã –≤—ã–∫–ª—é—á–µ–Ω—ã.";
      setStatus(`${prefix} –£–≤–µ–¥–æ–º–ª–µ–Ω–æ: ${data.sent}, –æ—à–∏–±–æ–∫: ${data.failed}.`, "ok");
    }

    function collectAdminAntiabuseConfig() {
      const current = adminAntiabuseConfig && typeof adminAntiabuseConfig === "object"
        ? adminAntiabuseConfig
        : {};
      const payload = {};
      if (adminAbSoftEnabledEl) {
        payload.soft_block_enabled = toBool(adminAbSoftEnabledEl.value);
      }
      if (adminAbSoftBlockSecondsEl) {
        payload.soft_block_seconds = toInt(
          adminAbSoftBlockSecondsEl.value,
          toInt(current.soft_block_seconds, 1800)
        );
      }
      if (adminAbThresholdEl) {
        payload.soft_block_threshold = toInt(
          adminAbThresholdEl.value,
          toInt(current.soft_block_threshold, 4)
        );
      }
      if (adminAbStrikeWindowEl) {
        payload.strike_window_seconds = toInt(
          adminAbStrikeWindowEl.value,
          toInt(current.strike_window_seconds, 86400)
        );
      }
      if (adminAbWeightOrderEl) {
        payload.strike_weight_order_spam = toInt(
          adminAbWeightOrderEl.value,
          toInt(current.strike_weight_order_spam, 1)
        );
      }
      if (adminAbWeightTrialEl) {
        payload.strike_weight_trial_reuse = toInt(
          adminAbWeightTrialEl.value,
          toInt(current.strike_weight_trial_reuse, 2)
        );
      }
      if (adminAbWeightUsernameEl) {
        payload.strike_weight_username_pattern = toInt(
          adminAbWeightUsernameEl.value,
          toInt(current.strike_weight_username_pattern, 1)
        );
      }
      if (adminAbFpDaysEl) {
        payload.trial_fingerprint_window_days = toInt(
          adminAbFpDaysEl.value,
          toInt(current.trial_fingerprint_window_days, 30)
        );
      }
      if (adminAbFpMaxUsersEl) {
        payload.trial_fingerprint_max_users = toInt(
          adminAbFpMaxUsersEl.value,
          toInt(current.trial_fingerprint_max_users, 2)
        );
      }
      return payload;
    }

    async function adminSaveAntiabuseConfig() {
      if (!isAdmin) return;
      const antiabuse = collectAdminAntiabuseConfig();
      const data = await requestJson("/webapp/api/admin/set-antiabuse", "POST", {
        init_data: initData,
        antiabuse,
      });
      renderAdminRuntimeState(data);
      setStatus("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω—Ç–∏–∞–±—É–∑–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.", "ok");
    }

    async function adminResetAntiabuseConfig() {
      if (!isAdmin) return;
      const data = await requestJson("/webapp/api/admin/reset-antiabuse", "POST", {
        init_data: initData,
      });
      renderAdminRuntimeState(data);
      setStatus("–ê–Ω—Ç–∏–∞–±—É–∑ —Å–±—Ä–æ—à–µ–Ω –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –∏–∑ .env.", "ok");
    }

    async function loadAdminPromocodes() {
      if (!isAdmin) return;
      const data = await requestJson("/webapp/api/admin/promocodes", "POST", {
        init_data: initData,
        include_archived: adminPromoIncludeArchived()
      });
      renderAdminPromocodes(data.promocodes || []);
    }

    async function loadAdminFlags() {
      if (!isAdmin) return;
      const data = await requestJson("/webapp/api/admin/flags", "POST", {
        init_data: initData,
        unresolved_only: true,
        limit: 30,
      });
      renderAdminFlags(data.flags || []);
    }

    async function resolveAdminFlag() {
      if (!isAdmin) return;
      const flagId = Number.parseInt(String(adminResolveFlagIdEl?.value || ""), 10);
      if (!Number.isFinite(flagId) || flagId <= 0) {
        setStatus("–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ñ–ª–∞–≥–∞ (#ID).", "err");
        return;
      }
      const data = await requestJson("/webapp/api/admin/resolve-flag", "POST", {
        init_data: initData,
        flag_id: flagId,
      });
      renderAdminFlags(data.flags || []);
      if (adminResolveFlagIdEl) adminResolveFlagIdEl.value = "";
      setStatus(`–§–ª–∞–≥ #${flagId} –ø–æ–º–µ—á–µ–Ω –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º.`, "ok");
    }

    async function saveAdminPromocode() {
      if (!isAdmin) return;
      const payload = {
        init_data: initData,
        code: String(adminPromoCodeEl.value || "").trim(),
        discount_rub: toInt(adminPromoDiscountEl.value, 0),
        expires_at: String(adminPromoExpiresEl.value || "").trim(),
        max_activations: toInt(adminPromoMaxActivationsEl.value, 0),
        include_archived: adminPromoIncludeArchived()
      };
      const data = await requestJson("/webapp/api/admin/create-promocode", "POST", payload);
      renderAdminPromocodes(data.promocodes || []);
      setStatus("–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω.", "ok");
    }

    async function adminDeletePromocode() {
      if (!isAdmin) return;
      const code = adminPromoTargetCode();
      if (!code) {
        setStatus("–£–∫–∞–∂–∏—Ç–µ –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.", "err");
        return;
      }
      const data = await requestJson("/webapp/api/admin/delete-promocode", "POST", {
        init_data: initData,
        code,
        include_archived: adminPromoIncludeArchived()
      });
      renderAdminPromocodes(data.promocodes || []);
      setStatus(`–ü—Ä–æ–º–æ–∫–æ–¥ ${code} —É–¥–∞–ª–µ–Ω.`, "ok");
    }

    async function adminExtendPromocode() {
      if (!isAdmin) return;
      const code = adminPromoTargetCode();
      if (!code) {
        setStatus("–£–∫–∞–∂–∏—Ç–µ –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è.", "err");
        return;
      }
      const days = toInt(adminPromoExtendDaysEl ? adminPromoExtendDaysEl.value : "0", 0);
      if (days <= 0) {
        setStatus("–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è.", "err");
        return;
      }
      const data = await requestJson("/webapp/api/admin/extend-promocode", "POST", {
        init_data: initData,
        code,
        days,
        include_archived: adminPromoIncludeArchived()
      });
      renderAdminPromocodes(data.promocodes || []);
      setStatus(`–ü—Ä–æ–º–æ–∫–æ–¥ ${code} –ø—Ä–æ–¥–ª–µ–Ω –Ω–∞ ${days} –¥–Ω.`, "ok");
    }

    async function adminSetPromocodeExpiry() {
      if (!isAdmin) return;
      const code = adminPromoTargetCode();
      if (!code) {
        setStatus("–£–∫–∞–∂–∏—Ç–µ –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—Ç—ã.", "err");
        return;
      }
      const expiresAt = String(adminPromoSetExpiryEl ? adminPromoSetExpiryEl.value : "").trim();
      if (!expiresAt) {
        setStatus("–£–∫–∞–∂–∏—Ç–µ –Ω–æ–≤—É—é –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è.", "err");
        return;
      }
      const data = await requestJson("/webapp/api/admin/set-promocode-expiry", "POST", {
        init_data: initData,
        code,
        expires_at: expiresAt,
        include_archived: adminPromoIncludeArchived()
      });
      renderAdminPromocodes(data.promocodes || []);
      setStatus(`–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ ${code} –æ–±–Ω–æ–≤–ª–µ–Ω–∞.`, "ok");
    }

    async function adminFindUsers() {
      if (!isAdmin) return;
      const query = String(adminUserQueryEl.value || "").trim();
      if (!query) {
        setStatus("–í–≤–µ–¥–∏—Ç–µ username –∏–ª–∏ Telegram ID.", "err");
        return;
      }
      const data = await requestJson("/webapp/api/admin/find-user", "POST", {
        init_data: initData,
        query
      });
      renderAdminUsers(data.users || []);
      setStatus(`–ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${(data.users || []).length}.`, "ok");
    }

    async function adminGrantSubscription() {
      if (!isAdmin) return;
      const telegramId = Number(selectedAdminUserId || 0);
      if (!telegramId) {
        setStatus("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.", "err");
        return;
      }
      const days = toInt(adminGrantDaysEl.value, 0);
      if (days <= 0) {
        setStatus("–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π.", "err");
        return;
      }
      const data = await requestJson("/webapp/api/admin/grant-subscription", "POST", {
        init_data: initData,
        telegram_id: telegramId,
        days
      });
      setStatus(`–ü–æ–¥–ø–∏—Å–∫–∞ –≤—ã–¥–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${telegramId}.`, "ok");
      if (data.user) {
        renderAdminUsers([data.user]);
      }
    }

    async function adminRemoveSubscription() {
      if (!isAdmin) return;
      const telegramId = Number(selectedAdminUserId || 0);
      if (!telegramId) {
        setStatus("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.", "err");
        return;
      }
      const data = await requestJson("/webapp/api/admin/remove-subscription", "POST", {
        init_data: initData,
        telegram_id: telegramId
      });
      setStatus(`–ü–æ–¥–ø–∏—Å–∫–∞ —É–¥–∞–ª–µ–Ω–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${telegramId}.`, "ok");
      if (data.user) {
        renderAdminUsers([data.user]);
      }
    }

    async function activatePromocode() {
      if (!initData) {
        setStatus("–û—Ç–∫—Ä–æ–π—Ç–µ Mini App —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞.", "err");
        return;
      }
      const promoCode = String(promoCodeInputEl.value || "").trim();
      if (!promoCode) {
        setStatus("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥.", "err");
        return;
      }
      try {
        await requestJson("/webapp/api/activate-promocode", "POST", {
          init_data: initData,
          promo_code: promoCode
        });
        promoCodeInputEl.value = "";
        await loadProfile();
        setStatus("–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.", "ok");
      } catch (err) {
        setStatus(promoErrorText(err.message), "err");
      }
    }

    function renderPlans(plans, paymentEnabled, providerLabel) {
      plansCache = Array.isArray(plans) ? plans.slice() : [];
      refreshQuickRenewButtons();
      plansEl.innerHTML = "";
      if (!paymentEnabled) {
        const muted = document.createElement("div");
        muted.className = "small";
        muted.textContent = "–û–ø–ª–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞: –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.";
        plansEl.appendChild(muted);
        return;
      }

      const validPlans = plans.filter((plan) => {
        const days = Number(plan.days || 0);
        const amount = Number(plan.amount_rub || 0);
        return days > 0 && amount > 0;
      });
      let bestValueCode = "";
      if (validPlans.length) {
        const sortedByValue = validPlans.slice().sort((a, b) => {
          const aDays = Number(a.days || 0) || 1;
          const bDays = Number(b.days || 0) || 1;
          const aAmount = Number(a.amount_rub || 0);
          const bAmount = Number(b.amount_rub || 0);
          const aPerDay = aAmount / aDays;
          const bPerDay = bAmount / bDays;
          if (aPerDay !== bPerDay) return aPerDay - bPerDay;
          return bDays - aDays;
        });
        bestValueCode = String(sortedByValue[0].code || "");
      }

      const popularPlan =
        validPlans.find((plan) => Number(plan.days || 0) === 90) ||
        validPlans.find((plan) => Number(plan.days || 0) === 30) ||
        validPlans[0] ||
        null;
      const popularCode = popularPlan ? String(popularPlan.code || "") : "";

      plans.forEach((plan) => {
        const item = document.createElement("div");
        item.className = "plan";
        const planCode = String(plan.code || "");
        const planTitle = String(plan.title || "");
        const planAmount = Number(plan.amount_rub || 0);
        const planDays = Number(plan.days || 0);
        const planBaseAmount = Number(plan.base_amount_rub || planAmount);
        const planDiscountPercent = toInt(plan.discount_percent, 0);
        const isBestValue = !!bestValueCode && planCode === bestValueCode;
        const isPopular = !!popularCode && planCode === popularCode;
        if (isBestValue) item.classList.add("plan-best");
        if (isPopular) item.classList.add("plan-popular");

        const badges = [];
        if (isPopular) badges.push('<span class="plan-badge popular">–°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π</span>');
        if (isBestValue) badges.push('<span class="plan-badge best">–°–∞–º—ã–π –≤—ã–≥–æ–¥–Ω—ã–π</span>');
        const badgesLine = badges.length
          ? `<div class="plan-badges">${badges.join("")}</div>`
          : "";

        const dayCost = planDays > 0 && planAmount > 0 ? planAmount / planDays : 0;
        let dayCostText = "";
        if (dayCost > 0) {
          const normalized = dayCost >= 10 ? dayCost.toFixed(0) : dayCost.toFixed(1);
          dayCostText = `<p>‚âà ${escapeHtml(normalized.replace(".", ","))} ‚ÇΩ / –¥–µ–Ω—å</p>`;
        }

        const discountLine = (planDiscountPercent > 0 && planBaseAmount > planAmount)
          ? `<p>–°–∫–∏–¥–∫–∞: -${escapeHtml(planDiscountPercent)}% (–±—ã–ª–æ ${escapeHtml(planBaseAmount)} ‚ÇΩ)</p>`
          : "";
        item.innerHTML = `
          <div>
            ${badgesLine}
            <h3>${escapeHtml(planTitle)} ‚Ä¢ ${escapeHtml(planAmount)} ‚ÇΩ</h3>
            <p>${escapeHtml(planDays)} –¥–Ω–µ–π –¥–æ—Å—Ç—É–ø–∞</p>
            ${dayCostText}
            ${discountLine}
          </div>
        `;
        const btn = document.createElement("button");
        btn.textContent = "–û–ø–ª–∞—Ç–∏—Ç—å";
        btn.onclick = () => createOrder(planCode);
        item.appendChild(btn);
        plansEl.appendChild(item);
      });

      if (providerLabel) {
        const note = document.createElement("div");
        note.className = "small";
        note.style.marginTop = "8px";
        note.textContent = `–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑: ${providerLabel}`;
        plansEl.appendChild(note);
      }
    }

    function renderPlansLoading() {
      plansEl.innerHTML = "";
      for (let i = 0; i < 3; i += 1) {
        const skeleton = document.createElement("div");
        skeleton.className = "plan-skeleton";
        plansEl.appendChild(skeleton);
      }
    }

    function clearOrder() {
      currentOrderId = "";
      currentPaymentUrl = "";
      currentCryptobotPaymentUrl = "";
      currentCryptobotPaymentLabel = "CryptoBot";
      currentLztPaymentUrl = "";
      currentLztPaymentLabel = "LZT Market";
      currentSecondaryPaymentUrl = "";
      currentSecondaryPaymentLabel = "–†–µ–∑–µ—Ä–≤–Ω–∞—è –æ–ø–ª–∞—Ç–∞";
      currentOrderProvider = "cryptobot";
      currentOrderStatus = "pending";
      orderCardEl.classList.remove("hidden");
      syncOrderTabVisibility();
      orderInfoEl.textContent = "–ê–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ —Å–µ–π—á–∞—Å –Ω–µ—Ç. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑.";
      orderCodeEl.textContent = "-";
      ensureValidTab(resolveTabFromQuery() || "plansCard");
    }

    function updateOrderActionButtons() {
      const isCancelled = String(currentOrderStatus || "").toLowerCase() === "cancelled";
      const primaryUrl = String(currentPaymentUrl || "").trim();
      const cryptoUrl = String(currentCryptobotPaymentUrl || "").trim();
      const lztUrl = String(currentLztPaymentUrl || "").trim();
      const secondaryUrl = String(currentSecondaryPaymentUrl || "").trim();
      const primaryProvider = String(currentOrderProvider || paymentProvider || "").trim().toLowerCase();
      const primaryProviderLabel = String(
        currentOrderProviderLabel || paymentProviderLabel || ""
      ).trim().toLowerCase();
      const primaryIsCrypto = primaryProvider.includes("crypto") || primaryProviderLabel.includes("crypto");
      const primaryIsLzt = primaryProvider.includes("lzt") || primaryProviderLabel.includes("lzt");

      const hasPrimary = !!primaryUrl;
      const hasCrypto = !!cryptoUrl && !primaryIsCrypto && cryptoUrl !== primaryUrl;
      const hasLzt = !!lztUrl && !primaryIsLzt && lztUrl !== primaryUrl && lztUrl !== cryptoUrl;
      const hasSecondary = (
        !!secondaryUrl
        && secondaryUrl !== primaryUrl
        && secondaryUrl !== cryptoUrl
        && secondaryUrl !== lztUrl
      );

      if (repeatBtn) repeatBtn.classList.toggle("hidden", !isCancelled);
      if (payBtn) {
        payBtn.classList.toggle("hidden", !hasPrimary);
        payBtn.disabled = isCancelled || !hasPrimary;
        if (hasPrimary) {
          payBtn.textContent = `üí≥ ${currentOrderProviderLabel || paymentProviderLabel || "–û–ø–ª–∞—Ç–∏—Ç—å"}`;
        }
      }
      if (cryptoPayBtn) {
        cryptoPayBtn.classList.toggle("hidden", !hasCrypto);
        cryptoPayBtn.disabled = isCancelled || !hasCrypto;
        if (hasCrypto) {
          cryptoPayBtn.textContent = `‚Çø ${currentCryptobotPaymentLabel}`;
        }
      }
      if (lztPayBtn) {
        lztPayBtn.classList.toggle("hidden", !hasLzt);
        lztPayBtn.disabled = isCancelled || !hasLzt;
        if (hasLzt) {
          lztPayBtn.textContent = `‚ö° ${currentLztPaymentLabel}`;
        }
      }
      if (secondaryPayBtn) {
        secondaryPayBtn.classList.toggle("hidden", !hasSecondary);
        secondaryPayBtn.disabled = isCancelled || !hasSecondary;
        if (hasSecondary) {
          secondaryPayBtn.textContent = `ü™ô ${currentSecondaryPaymentLabel}`;
        }
      }
      if (cancelBtn) cancelBtn.disabled = isCancelled;
    }

    function showOrder(orderId, paymentUrl, plan, expiresAt) {
      currentOrderId = orderId;
      currentPaymentUrl = paymentUrl || "";
      currentCryptobotPaymentUrl = String(plan.cryptobot_payment_url || "").trim();
      currentCryptobotPaymentLabel = String(plan.cryptobot_payment_label || "CryptoBot").trim();
      currentLztPaymentUrl = String(plan.lzt_payment_url || "").trim();
      currentLztPaymentLabel = String(plan.lzt_payment_label || "LZT Market").trim();
      currentSecondaryPaymentUrl = String(plan.secondary_payment_url || "").trim();
      currentSecondaryPaymentLabel = String(plan.secondary_payment_label || "–†–µ–∑–µ—Ä–≤–Ω–∞—è –æ–ø–ª–∞—Ç–∞").trim();
      currentOrderProvider = String(plan.provider || paymentProvider || "").trim().toLowerCase();
      currentOrderStatus = "pending";
      currentOrderProviderLabel = String(plan.provider_label || paymentProviderLabel || "–ø–ª–∞—Ç–µ–∂–Ω—ã–π —Å–µ—Ä–≤–∏—Å");
      orderCardEl.classList.remove("hidden");
      syncOrderTabVisibility();
      switchTab("orderCard");
      const baseAmount = Number(plan.base_amount_rub || plan.amount_rub || 0);
      const amount = Number(plan.amount_rub || 0);
      const tariffDiscountTail = (plan.discount_percent > 0 && baseAmount > amount)
        ? `, —Å–∫–∏–¥–∫–∞ —Ç–∞—Ä–∏—Ñ–∞: -${plan.discount_percent}% (–±—ã–ª–æ ${baseAmount} ‚ÇΩ)`
        : "";
      const promoCode = String((plan.promo && plan.promo.code) || plan.promo_code || "").trim();
      const promoDiscount = Number((plan.promo && plan.promo.discount_rub) || plan.promo_discount_rub || 0);
      const promoTail = promoCode && promoDiscount > 0
        ? `, –ø—Ä–æ–º–æ–∫–æ–¥ ${promoCode}: -${promoDiscount} ‚ÇΩ`
        : "";
      const expiresTail = expiresAt ? `, –∏—Å—Ç–µ–∫–∞–µ—Ç: ${expiresAt}` : "";
      const providerTail = currentOrderProviderLabel ? `, —Å–µ—Ä–≤–∏—Å: ${currentOrderProviderLabel}` : "";
      orderInfoEl.textContent = `–¢–∞—Ä–∏—Ñ: ${plan.title}, —Å—É–º–º–∞: ${amount} ‚ÇΩ${tariffDiscountTail}${promoTail}${providerTail}${expiresTail}`;
      orderCodeEl.textContent = orderId;
      updateOrderActionButtons();
      const primaryUrl = String(currentPaymentUrl || "").trim();
      const cryptoUrl = String(currentCryptobotPaymentUrl || "").trim();
      const lztUrl = String(currentLztPaymentUrl || "").trim();
      const secondaryUrl = String(currentSecondaryPaymentUrl || "").trim();
      const primaryProvider = String(currentOrderProvider || paymentProvider || "").trim().toLowerCase();
      const primaryProviderLabel = String(
        currentOrderProviderLabel || paymentProviderLabel || ""
      ).trim().toLowerCase();
      const primaryIsCrypto = primaryProvider.includes("crypto") || primaryProviderLabel.includes("crypto");
      const primaryIsLzt = primaryProvider.includes("lzt") || primaryProviderLabel.includes("lzt");
      const hasPrimary = !!primaryUrl;
      const hasCrypto = !!cryptoUrl && !primaryIsCrypto && cryptoUrl !== primaryUrl;
      const hasLzt = !!lztUrl && !primaryIsLzt && lztUrl !== primaryUrl && lztUrl !== cryptoUrl;
      const hasSecondary = (
        !!secondaryUrl
        && secondaryUrl !== primaryUrl
        && secondaryUrl !== cryptoUrl
        && secondaryUrl !== lztUrl
      );
      if (hasPrimary && hasCrypto && hasLzt) {
        setStatus("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: –æ—Å–Ω–æ–≤–Ω–æ–π/ CryptoBot / LZT Market.", "ok");
      } else if (hasPrimary && hasCrypto) {
        setStatus("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: –æ—Å–Ω–æ–≤–Ω–æ–π –∏–ª–∏ CryptoBot.", "ok");
      } else if (hasPrimary && hasLzt) {
        setStatus("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: –æ—Å–Ω–æ–≤–Ω–æ–π –∏–ª–∏ LZT Market.", "ok");
      } else if (hasCrypto && hasLzt) {
        setStatus("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: CryptoBot –∏–ª–∏ LZT Market.", "ok");
      } else if (hasPrimary) {
        setStatus("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –î–æ—Å—Ç—É–ø–Ω–∞ –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥.", "ok");
      } else if (hasCrypto) {
        setStatus("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –î–æ—Å—Ç—É–ø–Ω–∞ –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ CryptoBot.", "ok");
      } else if (hasLzt) {
        setStatus("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –î–æ—Å—Ç—É–ø–Ω–∞ –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ LZT Market.", "ok");
      } else if (hasSecondary) {
        setStatus(`–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –î–æ—Å—Ç—É–ø–Ω–∞ –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ ${currentSecondaryPaymentLabel}.`, "ok");
      } else {
        setStatus("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω, –Ω–æ —Å—Å—ã–ª–∫–∞ –æ–ø–ª–∞—Ç—ã —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑.", "err");
      }
      maybeAutoOpenPayment();
    }

    function stopAutoStatusPolling() {
      if (autoStatusTimer) {
        clearInterval(autoStatusTimer);
        autoStatusTimer = null;
      }
    }

    function startAutoStatusPolling() {
      stopAutoStatusPolling();
      if (!currentOrderId) return;
      autoStatusTimer = setInterval(() => {
        checkOrderStatus(true);
      }, 10000);
    }

    async function loadPlans() {
      renderPlansLoading();
      const data = await requestJson("/webapp/api/plans", "GET");
      paymentProvider = String(data.payment_provider || "cryptobot");
      paymentProviderLabel = String(data.payment_provider_label || "CryptoBot");
      renderPlans(data.plans || [], data.payment_enabled, paymentProviderLabel);
    }

    async function loadProfile() {
      if (!initData) {
        renderReferralLink(0);
        if (orderIdFromQueryValid) {
          const successUrl = `/pay/success?order_id=${encodeURIComponent(orderIdFromQuery)}&src=webapp`;
          profileEl.textContent = "–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ Telegram –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã...";
          setStatus("–í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ Telegram...", "ok");
          setTimeout(() => {
            window.location.href = successUrl;
          }, 250);
          return;
        }
        profileEl.textContent = "–û—Ç–∫—Ä–æ–π—Ç–µ Mini App –∫–Ω–æ–ø–∫–æ–π ¬´üß© Mini App¬ª –≤ Telegram-—á–∞—Ç–µ —Å –±–æ—Ç–æ–º.";
        setStatus("initData –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ¬´üß© Mini App¬ª –≤ Telegram.", "err");
        return;
      }

      const me = await requestJson("/webapp/api/me", "POST", { init_data: initData });
      renderReferralLink(me && me.user ? me.user.id : 0);
      const sub = me.subscription || {};
      const subText = sub.active ? ("–∞–∫—Ç–∏–≤–Ω–∞ –¥–æ " + (sub.subscription_end || "-")) : "–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞";
      const adminText = me.user && me.user.is_admin ? " | –†–æ–ª—å: –∞–¥–º–∏–Ω" : "";
      profileEl.textContent = `ID: ${me.user.id} | –ü–æ–¥–ø–∏—Å–∫–∞: ${subText}${adminText}`;
      if (me.active_promo && me.active_promo.code) {
        activePromoEl.textContent = `–ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥: ${me.active_promo.code} (-${me.active_promo.discount_rub} ‚ÇΩ, –¥–æ ${me.active_promo.expires_at})`;
      } else {
        activePromoEl.textContent = "–ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥: –Ω–µ—Ç";
      }
      lastPaidPlanCode = me.last_paid_plan && me.last_paid_plan.code
        ? String(me.last_paid_plan.code)
        : "";
      refreshQuickRenewButtons();

      isAdmin = !!(me.user && me.user.is_admin);
      setAdminVisible(isAdmin);
      if (isAdmin && !adminLoaded) {
        await loadAdminPanel();
      }

      if (me.pending_order) {
        showOrder(
          me.pending_order.order_id,
          me.pending_order.payment_url || "",
          {
            title: me.pending_order.days + " –¥–Ω–µ–π",
            amount_rub: me.pending_order.amount_rub,
            base_amount_rub: me.pending_order.base_amount_rub,
            provider: me.pending_order.provider || "",
            provider_label: me.pending_order.provider_label || paymentProviderLabel,
            promo_code: me.pending_order.promo_code,
            promo_discount_rub: me.pending_order.promo_discount_rub,
            cryptobot_payment_url: me.pending_order.cryptobot_payment_url || "",
            cryptobot_payment_label: me.pending_order.cryptobot_payment_label || "CryptoBot",
            lzt_payment_url: me.pending_order.lzt_payment_url || "",
            lzt_payment_label: me.pending_order.lzt_payment_label || "LZT Market",
            secondary_payment_url: me.pending_order.secondary_payment_url || "",
            secondary_payment_label: me.pending_order.secondary_payment_label || "–†–µ–∑–µ—Ä–≤–Ω–∞—è –æ–ø–ª–∞—Ç–∞",
          },
          me.pending_order.expires_at || ""
        );
        startAutoStatusPolling();
        setStatus("–ù–∞–π–¥–µ–Ω –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–ª–∞—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.", "ok");
      } else {
        stopAutoStatusPolling();
        clearOrder();
        setStatus("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑.", "ok");
      }
    }

    async function createOrderByDays(days) {
      const code = findPlanCodeByDays(days);
      if (!code) {
        setStatus(`–¢–∞—Ä–∏—Ñ –Ω–∞ ${days} –¥–Ω–µ–π —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.`, "err");
        return;
      }
      await createOrder(code);
    }

    async function createLastPaidOrder() {
      if (!lastPaidPlanCode) {
        setStatus("–ù–µ—Ç –ø—Ä–æ—à–ª–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞.", "err");
        return;
      }
      await createOrder(lastPaidPlanCode);
    }

    async function createOrder(planCode) {
      if (!initData) {
        setStatus("–û—Ç–∫—Ä–æ–π—Ç–µ Mini App —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞.", "err");
        return;
      }
      try {
        const data = await requestJson("/webapp/api/create-order", "POST", {
          init_data: initData,
          plan_code: planCode
        });
        const orderPlan = Object.assign({}, data.plan || {}, {
          provider: data.payment_provider || "",
          provider_label: data.payment_provider_label || paymentProviderLabel,
          cryptobot_payment_url: data.cryptobot_payment_url || "",
          cryptobot_payment_label: data.cryptobot_payment_label || "CryptoBot",
          lzt_payment_url: data.lzt_payment_url || "",
          lzt_payment_label: data.lzt_payment_label || "LZT Market",
          secondary_payment_url: data.secondary_payment_url || "",
          secondary_payment_label: data.secondary_payment_label || "–†–µ–∑–µ—Ä–≤–Ω–∞—è –æ–ø–ª–∞—Ç–∞",
        });
        showOrder(data.order_id, data.payment_url, orderPlan, data.expires_at || "");
        startAutoStatusPolling();
      } catch (err) {
        const code = String(err.code || err.message || "");
        if (code === "order_rate_limited") {
          const retryAfter = Number((err.details && err.details.retry_after_seconds) || 0);
          const message = String(
            (err.details && err.details.message)
            || (retryAfter > 0
              ? `‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${retryAfter} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–∫–∞–∑–æ–º.`
              : "‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–∫–∞–∑–æ–º.")
          );
          setStatus(message, "err");
          return;
        }
        setStatus("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞: " + err.message, "err");
      }
    }

    async function checkOrderStatus(silent = false) {
      if (!currentOrderId) {
        if (!silent) setStatus("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑.", "err");
        return;
      }
      try {
        const data = await requestJson("/webapp/api/order-status", "POST", {
          init_data: initData,
          order_id: currentOrderId
        });
        currentPaymentUrl = String((data.order && data.order.payment_url) || currentPaymentUrl || "").trim();
        currentCryptobotPaymentUrl = String((data.order && data.order.cryptobot_payment_url) || "").trim();
        currentCryptobotPaymentLabel = String(
          (data.order && data.order.cryptobot_payment_label) || "CryptoBot"
        ).trim();
        currentLztPaymentUrl = String((data.order && data.order.lzt_payment_url) || "").trim();
        currentLztPaymentLabel = String(
          (data.order && data.order.lzt_payment_label) || "LZT Market"
        ).trim();
        currentSecondaryPaymentUrl = String((data.order && data.order.secondary_payment_url) || "").trim();
        currentSecondaryPaymentLabel = String(
          (data.order && data.order.secondary_payment_label) || "–†–µ–∑–µ—Ä–≤–Ω–∞—è –æ–ø–ª–∞—Ç–∞"
        ).trim();
        if (data.order.status === "paid") {
          stopAutoStatusPolling();
          currentOrderStatus = "paid";
          updateOrderActionButtons();
          setStatus("–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ ‚úÖ", "ok");
          await loadProfile();
          return;
        }
        if (data.order.status === "cancelled") {
          stopAutoStatusPolling();
          currentOrderStatus = "cancelled";
          updateOrderActionButtons();
          if (!silent) {
            setStatus("–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω –∏–ª–∏ –∏—Å—Ç–µ–∫. –ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑¬ª.", "err");
          }
          return;
        }
        currentOrderStatus = "pending";
        updateOrderActionButtons();
        if (!silent) {
          const expiresAt = data.order.expires_at || "";
          const tail = expiresAt ? ` –ó–∞–∫–∞–∑ –∏—Å—Ç–µ–∫–∞–µ—Ç: ${expiresAt}.` : "";
          setStatus("–ü–ª–∞—Ç–µ–∂ –ø–æ–∫–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω." + tail, "err");
        } else {
          setStatus("–ü–ª–∞—Ç–µ–∂ –ø–æ–∫–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω. –ò–¥–µ—Ç –∞–≤—Ç–æ-–ø—Ä–æ–≤–µ—Ä–∫–∞...", "ok");
        }
      } catch (err) {
        if (!silent) setStatus("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã: " + err.message, "err");
      }
    }

    async function cancelOrder() {
      if (!currentOrderId) {
        setStatus("–ù–µ—Ç –∑–∞–∫–∞–∑–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã.", "err");
        return;
      }
      try {
        await requestJson("/webapp/api/cancel-order", "POST", {
          init_data: initData,
          order_id: currentOrderId
        });
        stopAutoStatusPolling();
        currentOrderStatus = "cancelled";
        updateOrderActionButtons();
        setStatus("–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω. –ú–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å ¬´–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑¬ª.", "ok");
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞: " + err.message, "err");
      }
    }

    async function repeatOrder() {
      if (!currentOrderId) {
        setStatus("–ù–µ—Ç –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞.", "err");
        return;
      }
      try {
        const data = await requestJson("/webapp/api/repeat-order", "POST", {
          init_data: initData,
          source_order_id: currentOrderId,
        });
        const orderPlan = Object.assign({}, data.plan || {}, {
          provider: data.payment_provider || "",
          provider_label: data.payment_provider_label || paymentProviderLabel,
          cryptobot_payment_url: data.cryptobot_payment_url || "",
          cryptobot_payment_label: data.cryptobot_payment_label || "CryptoBot",
          lzt_payment_url: data.lzt_payment_url || "",
          lzt_payment_label: data.lzt_payment_label || "LZT Market",
          secondary_payment_url: data.secondary_payment_url || "",
          secondary_payment_label: data.secondary_payment_label || "–†–µ–∑–µ—Ä–≤–Ω–∞—è –æ–ø–ª–∞—Ç–∞",
        });
        showOrder(data.order_id, data.payment_url || "", orderPlan, data.expires_at || "");
        startAutoStatusPolling();
        if (data.plan_replaced) {
          setStatus("–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–∞—Ä–∏—Ñ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –≤—ã–±—Ä–∞–Ω –±–ª–∏–∂–∞–π—à–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞—Ä–∏—Ñ.", "ok");
        }
      } catch (err) {
        const code = String(err.code || err.message || "");
        if (code === "order_rate_limited") {
          const retryAfter = Number((err.details && err.details.retry_after_seconds) || 0);
          const message = String(
            (err.details && err.details.message)
            || (retryAfter > 0
              ? `‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${retryAfter} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–∫–∞–∑–æ–º.`
              : "‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–∫–∞–∑–æ–º.")
          );
          setStatus(message, "err");
          return;
        }
        setStatus("–û—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–∞ –∑–∞–∫–∞–∑–∞: " + err.message, "err");
      }
    }

    function openPaymentLink() {
      const paymentUrl = String(currentPaymentUrl || "").trim();
      if (!paymentUrl) {
        if (currentCryptobotPaymentUrl) {
          openCryptoPaymentLink();
          return;
        }
        if (currentLztPaymentUrl) {
          openLztPaymentLink();
          return;
        }
        if (currentSecondaryPaymentUrl) {
          openSecondaryPaymentLink();
          return;
        }
        setStatus("–°—Å—ã–ª–∫–∞ –æ–ø–ª–∞—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑.", "err");
        return;
      }
      if (currentOrderId && navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(currentOrderId).catch(() => {});
      }
      setStatus("–û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã...", "ok");
      if (tg && tg.openLink) {
        tg.openLink(paymentUrl, { try_instant_view: false });
      } else {
        window.location.href = paymentUrl;
      }
    }

    function openCryptoPaymentLink() {
      if (!currentCryptobotPaymentUrl) {
        setStatus("–°—Å—ã–ª–∫–∞ CryptoBot –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.", "err");
        return;
      }
      if (currentOrderId && navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(currentOrderId).catch(() => {});
      }
      setStatus("–û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ CryptoBot...", "ok");
      if (tg && tg.openLink) {
        tg.openLink(currentCryptobotPaymentUrl, { try_instant_view: false });
      } else {
        window.location.href = currentCryptobotPaymentUrl;
      }
    }

    function openLztPaymentLink() {
      if (!currentLztPaymentUrl) {
        setStatus("–°—Å—ã–ª–∫–∞ LZT Market –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.", "err");
        return;
      }
      if (currentOrderId && navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(currentOrderId).catch(() => {});
      }
      setStatus("–û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ LZT Market...", "ok");
      if (tg && tg.openLink) {
        tg.openLink(currentLztPaymentUrl, { try_instant_view: false });
      } else {
        window.location.href = currentLztPaymentUrl;
      }
    }

    function openSecondaryPaymentLink() {
      if (!currentSecondaryPaymentUrl) {
        setStatus("–†–µ–∑–µ—Ä–≤–Ω–∞—è —Å—Å—ã–ª–∫–∞ –æ–ø–ª–∞—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.", "err");
        return;
      }
      if (currentOrderId && navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(currentOrderId).catch(() => {});
      }
      setStatus(`–û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ ${currentSecondaryPaymentLabel}...`, "ok");
      if (tg && tg.openLink) {
        tg.openLink(currentSecondaryPaymentUrl, { try_instant_view: false });
      } else {
        window.location.href = currentSecondaryPaymentUrl;
      }
    }

    function maybeAutoOpenPayment() {
      return;
    }

    tabButtons.forEach((btn) => {
      btn.onclick = () => {
        switchTab(btn.dataset.tabTarget || "");
      };
    });

    setCoreTabsVisible();
    setAdminVisible(false);
    syncOrderTabVisibility();
    ensureValidTab(resolveTabFromQuery() || readRememberedTab() || "accountCard");

    function bindAction(button, lockKey, busyText, action) {
      if (!button) return;
      button.onclick = () => runButtonAction(button, lockKey, busyText, action);
    }

    bindAction(payBtn, "order:pay", "–û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã...", async () => {
      openPaymentLink();
    });
    bindAction(cryptoPayBtn, "order:pay:cryptobot", "–û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ CryptoBot...", async () => {
      openCryptoPaymentLink();
    });
    bindAction(lztPayBtn, "order:pay:lzt", "–û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ LZT Market...", async () => {
      openLztPaymentLink();
    });
    bindAction(secondaryPayBtn, "order:pay:secondary", "–û—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –æ–ø–ª–∞—Ç—É...", async () => {
      openSecondaryPaymentLink();
    });

    bindAction(checkBtn, "order:check", "–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–ª–∞—Ç—É...", async () => {
      await checkOrderStatus(false);
    });
    bindAction(cancelBtn, "order:cancel", "–û—Ç–º–µ–Ω—è–µ–º –∑–∞–∫–∞–∑...", async () => {
      await cancelOrder();
    });
    bindAction(promoActivateBtn, "promo:activate", "–ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø—Ä–æ–º–æ–∫–æ–¥...", async () => {
      await activatePromocode();
    });
    bindAction(referralCopyBtn, "referral:copy", "–ö–æ–ø–∏—Ä—É–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É...", async () => {
      if (!currentReferralUrl) {
        setStatus("–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.", "err");
        return;
      }
      try {
        await navigator.clipboard.writeText(currentReferralUrl);
        setStatus("–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞.", "ok");
      } catch (_) {
        setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.", "err");
      }
    });
    bindAction(referralShareBtn, "referral:share", "–û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —à–∞—Ä–∏–Ω–≥–∞...", async () => {
      if (!currentReferralUrl) {
        setStatus("–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.", "err");
        return;
      }
      const shareText = "–ü–æ–¥–∫–ª—é—á–∞–π—Å—è –∫ BoxVolt VPN –ø–æ –º–æ–µ–π —Å—Å—ã–ª–∫–µ";
      const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(currentReferralUrl)}&text=${encodeURIComponent(shareText)}`;
      if (tg && typeof tg.openTelegramLink === "function") {
        tg.openTelegramLink(shareUrl);
      } else {
        window.open(shareUrl, "_blank", "noopener");
      }
      setStatus("–°—Å—ã–ª–∫–∞ –¥–ª—è —à–∞—Ä–∏–Ω–≥–∞ –æ—Ç–∫—Ä—ã—Ç–∞.", "ok");
    });
    bindAction(quickRenew7Btn, "renew:7", "–°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑ –Ω–∞ 7 –¥–Ω–µ–π...", async () => {
      await createOrderByDays(7);
    });
    bindAction(quickRenew30Btn, "renew:30", "–°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑ –Ω–∞ 30 –¥–Ω–µ–π...", async () => {
      await createOrderByDays(30);
    });
    bindAction(quickRenew90Btn, "renew:90", "–°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑ –Ω–∞ 90 –¥–Ω–µ–π...", async () => {
      await createOrderByDays(90);
    });
    bindAction(quickRenew365Btn, "renew:365", "–°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑ –Ω–∞ 365 –¥–Ω–µ–π...", async () => {
      await createOrderByDays(365);
    });
    bindAction(quickRenewLastBtn, "renew:last", "–°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑ –ø–æ –ø—Ä–æ—à–ª–æ–º—É —Ç–∞—Ä–∏—Ñ—É...", async () => {
      await createLastPaidOrder();
    });
    bindAction(repeatBtn, "order:repeat", "–ü–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–∫–∞–∑...", async () => {
      await repeatOrder();
    });

    bindAction(adminSaveBtn, "admin:save-pricing", "–°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–Ω—ã...", async () => {
      await saveAdminPricing();
    });
    bindAction(adminReloadBtn, "admin:reload", "–û–±–Ω–æ–≤–ª—è–µ–º –∞–¥–º–∏–Ω-–∫–æ–Ω—Ñ–∏–≥...", async () => {
      await loadAdminPanel();
      setStatus("–ö–æ–Ω—Ñ–∏–≥ –æ–±–Ω–æ–≤–ª–µ–Ω.", "ok");
    });
    bindAction(adminSendBroadcastBtn, "admin:broadcast", "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–∞—Å—Å—ã–ª–∫—É...", async () => {
      await adminNotify();
    });
    bindAction(adminRuntimeReloadBtn, "admin:runtime", "–û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã...", async () => {
      await loadAdminRuntimeState();
      setStatus("–°—Ç–∞—Ç—É—Å—ã —Ä–µ–∂–∏–º–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.", "ok");
    });
    bindAction(adminToggleUpdateModeBtn, "admin:update-mode", "–ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º update...", async () => {
      await adminToggleUpdateMode();
    });
    bindAction(adminSendUpdateNoticeBtn, "admin:update-notice", "–†–∞—Å—Å—ã–ª–∞–µ–º update-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ...", async () => {
      await adminSendUpdateNotice();
    });
    bindAction(adminToggleMaintenanceBtn, "admin:maintenance", "–ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Ç–µ—Ö—Ä–∞–±–æ—Ç...", async () => {
      await adminToggleMaintenance();
    });
    bindAction(adminAntiabuseSaveBtn, "admin:antiabuse:save", "–°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–Ω—Ç–∏–∞–±—É–∑...", async () => {
      await adminSaveAntiabuseConfig();
    });
    bindAction(adminAntiabuseResetBtn, "admin:antiabuse:reset", "–°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–Ω—Ç–∏–∞–±—É–∑ –∫ .env...", async () => {
      await adminResetAntiabuseConfig();
    });
    bindAction(adminFlagsReloadBtn, "admin:flags:reload", "–ó–∞–≥—Ä—É–∂–∞–µ–º –∞–Ω—Ç–∏—Ñ—Ä–æ–¥-—Ñ–ª–∞–≥–∏...", async () => {
      await loadAdminFlags();
      setStatus("–ê–Ω—Ç–∏—Ñ—Ä–æ–¥-—Ñ–ª–∞–≥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.", "ok");
    });
    bindAction(adminResolveFlagBtn, "admin:flags:resolve", "–ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–ª–∞–≥...", async () => {
      await resolveAdminFlag();
    });
    bindAction(adminPromoSaveBtn, "admin:promo:save", "–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º–æ–∫–æ–¥...", async () => {
      try {
        await saveAdminPromocode();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞: " + adminPromoErrorText(String(err.message || err)), "err");
      }
    });
    bindAction(adminPromoReloadBtn, "admin:promo:reload", "–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤...", async () => {
      try {
        await loadAdminPromocodes();
        setStatus("–°–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω.", "ok");
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤: " + adminPromoErrorText(String(err.message || err)), "err");
      }
    });
    bindAction(adminPromoExtendBtn, "admin:promo:extend", "–ü—Ä–æ–¥–ª–µ–≤–∞–µ–º –ø—Ä–æ–º–æ–∫–æ–¥...", async () => {
      try {
        await adminExtendPromocode();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞: " + adminPromoErrorText(String(err.message || err)), "err");
      }
    });
    bindAction(adminPromoSetExpiryBtn, "admin:promo:expiry", "–û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –ø—Ä–æ–º–æ–∫–æ–¥–∞...", async () => {
      try {
        await adminSetPromocodeExpiry();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—Ç—ã: " + adminPromoErrorText(String(err.message || err)), "err");
      }
    });
    bindAction(adminPromoDeleteBtn, "admin:promo:delete", "–£–¥–∞–ª—è–µ–º –ø—Ä–æ–º–æ–∫–æ–¥...", async () => {
      try {
        await adminDeletePromocode();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞: " + adminPromoErrorText(String(err.message || err)), "err");
      }
    });
    if (adminPromoShowArchivedEl) {
      adminPromoShowArchivedEl.onchange = async () => {
        try {
          setStatus("–§–∏–ª—å—Ç—Ä—É–µ–º –ø—Ä–æ–º–æ–∫–æ–¥—ã...", "busy");
          await loadAdminPromocodes();
        } catch (err) {
          setStatus("–û—à–∏–±–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤: " + adminPromoErrorText(String(err.message || err)), "err");
        }
      };
    }
    bindAction(adminUserSearchBtn, "admin:user:search", "–ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...", async () => {
      await adminFindUsers();
    });
    bindAction(adminGrantBtn, "admin:user:grant", "–í—ã–¥–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É...", async () => {
      await adminGrantSubscription();
    });
    bindAction(adminRemoveSubBtn, "admin:user:remove", "–£–¥–∞–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É...", async () => {
      await adminRemoveSubscription();
    });

    bindAction(copyBtn, "order:copy", "–ö–æ–ø–∏—Ä—É–µ–º –∫–æ–¥ –∑–∞–∫–∞–∑–∞...", async () => {
      if (!currentOrderId) {
        setStatus("–ù–µ—Ç –∫–æ–¥–∞ –∑–∞–∫–∞–∑–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.", "err");
        return;
      }
      try {
        await navigator.clipboard.writeText(currentOrderId);
        setStatus("–ö–æ–¥ –∑–∞–∫–∞–∑–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω.", "ok");
      } catch (_) {
        setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.", "err");
      }
    });

    (function setupGlobalFx() {
      const sparksHost = document.getElementById("fxSparks");
      const spotlight = document.getElementById("fxSpotlight");
      if (!sparksHost || !spotlight) return;

      for (let i = 0; i < 30; i += 1) {
        const spark = document.createElement("div");
        const size = Math.random() * 3 + 1;
        spark.className = "fx-spark";
        spark.style.left = `${Math.random() * 100}%`;
        spark.style.top = `${Math.random() * 100}%`;
        spark.style.width = `${size}px`;
        spark.style.height = `${size}px`;
        spark.style.opacity = String(Math.random() * 0.5 + 0.1);
        spark.style.animationDelay = `${Math.random() * 15}s`;
        spark.style.animationDuration = `${10 + Math.random() * 20}s`;
        spark.style.boxShadow = `0 0 ${size * 2}px rgba(255,255,255,0.5)`;
        sparksHost.appendChild(spark);
      }

      let rafId = 0;
      const updateSpotlight = (event) => {
        if (rafId) cancelAnimationFrame(rafId);
        rafId = requestAnimationFrame(() => {
          spotlight.style.background = `radial-gradient(600px circle at ${event.clientX}px ${event.clientY}px, rgba(249, 115, 22, 0.06), transparent 40%)`;
          rafId = 0;
        });
      };

      window.addEventListener("mousemove", updateSpotlight, { passive: true });
    })();

    (async () => {
      try {
        setStatus("–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ Mini App...", "busy");
        await loadPlans();
        await loadProfile();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + errorMessageFromAny(err), "err");
      }
    })();
  </script>
</body>
</html>
