<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BoxVolt Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --card: #172240;
      --text: #f8fafc;
      --muted: #9aa8bd;
      --accent: #2dd4bf;
      --accent-2: #38bdf8;
      --danger: #f87171;
      --ok: #34d399;
      --border: #2a3a63;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(circle at top, #1a2950 0%, var(--bg) 45%);
      color: var(--text);
      min-height: 100vh;
    }
    .wrap {
      max-width: 720px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }
    .title {
      font-size: 24px;
      font-weight: 700;
      margin: 4px 0 6px;
    }
    .subtitle {
      margin: 0 0 14px;
      color: var(--muted);
      font-size: 14px;
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      margin-bottom: 12px;
    }
    .status {
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 12px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,0.03);
    }
    .status.ok { border-color: rgba(52,211,153,.35); color: var(--ok); }
    .status.err { border-color: rgba(248,113,113,.35); color: var(--danger); }
    .plans {
      display: grid;
      gap: 10px;
    }
    .plan {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: rgba(8, 14, 30, 0.35);
    }
    .plan h3 {
      margin: 0 0 4px;
      font-size: 16px;
    }
    .plan p {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
    }
    button {
      border: 0;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      color: #031826;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      padding: 10px 12px;
      min-width: 118px;
    }
    button.ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    .order-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      word-break: break-all;
      color: #c5d6ea;
      background: rgba(0,0,0,.25);
      border-radius: 8px;
      padding: 8px;
      margin-top: 8px;
      border: 1px solid rgba(255,255,255,.07);
    }
    .hidden { display: none; }
    .small { font-size: 12px; color: var(--muted); }
    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 10px;
    }
    .field label {
      font-size: 12px;
      color: var(--muted);
    }
    .field input, .field textarea {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(8, 14, 30, 0.35);
      color: var(--text);
      padding: 9px 10px;
      font-size: 13px;
      font-family: inherit;
      outline: none;
    }
    .field textarea { min-height: 88px; resize: vertical; }
    .admin-plans {
      display: grid;
      gap: 8px;
      margin-top: 10px;
    }
    .admin-plan {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: rgba(8, 14, 30, 0.35);
    }
    .admin-plan-head {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .admin-plan-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }
    @media (max-width: 520px) {
      .admin-plan-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <h1 class="title">‚ö° BoxVolt Mini App</h1>
    <p class="subtitle">–ü–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã –≤ –æ–¥–Ω–æ–º –æ–∫–Ω–µ Telegram</p>

    <div id="status" class="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <section class="card">
      <strong>–ê–∫–∫–∞—É–Ω—Ç</strong>
      <div id="profile" class="small" style="margin-top:8px;">–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ...</div>
      <div id="activePromo" class="small" style="margin-top:8px;">–ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥: –Ω–µ—Ç</div>
      <div class="field">
        <label for="promoCodeInput">–ü—Ä–æ–º–æ–∫–æ–¥</label>
        <input id="promoCodeInput" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: BOXVOLT100">
      </div>
      <div class="order-row">
        <button id="promoActivateBtn" class="ghost">üéü –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
      </div>
    </section>

    <section class="card">
      <strong>–¢–∞—Ä–∏—Ñ—ã</strong>
      <div id="plans" class="plans" style="margin-top:10px;"></div>
    </section>

    <section id="adminCard" class="card hidden">
      <strong>üõ† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</strong>
      <p class="small" style="margin-top:8px;">
        –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω –∏ –∞–∫—Ü–∏–π –ø—Ä—è–º–æ –≤ Mini App.
      </p>

      <div class="field">
        <label for="adminGlobalDiscount">–ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ (%)</label>
        <input id="adminGlobalDiscount" type="number" min="0" max="90" value="0">
      </div>

      <div class="field">
        <label for="adminSaleTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∞–∫—Ü–∏–∏</label>
        <input id="adminSaleTitle" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Weekend Sale">
      </div>

      <div class="field">
        <label for="adminSaleMessage">–¢–µ–∫—Å—Ç –∞–∫—Ü–∏–∏</label>
        <textarea id="adminSaleMessage" placeholder="–¢–æ–ª—å–∫–æ –¥–æ –∫–æ–Ω—Ü–∞ –Ω–µ–¥–µ–ª–∏..."></textarea>
      </div>

      <strong style="display:block; margin-top:12px;">–ü–ª–∞–Ω—ã</strong>
      <div id="adminPlans" class="admin-plans"></div>

      <strong style="display:block; margin-top:14px;">–ü—Ä–æ–º–æ–∫–æ–¥—ã</strong>
      <div class="field">
        <label for="adminPromoCode">–ö–æ–¥</label>
        <input id="adminPromoCode" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: START50">
      </div>
      <div class="admin-plan-grid">
        <div class="field">
          <label for="adminPromoDiscount">–°–∫–∏–¥–∫–∞ (‚ÇΩ)</label>
          <input id="adminPromoDiscount" type="number" min="1" max="100000" value="50">
        </div>
        <div class="field">
          <label for="adminPromoExpires">–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ</label>
          <input id="adminPromoExpires" type="text" placeholder="2026-03-01 23:59">
        </div>
        <div class="field">
          <label for="adminPromoMaxActivations">–õ–∏–º–∏—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–π (0 = –±–µ–∑ –ª–∏–º–∏—Ç–∞)</label>
          <input id="adminPromoMaxActivations" type="number" min="0" max="1000000" value="0">
        </div>
      </div>
      <div class="order-row">
        <button id="adminPromoSaveBtn" class="ghost">üéü –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
        <button id="adminPromoReloadBtn" class="ghost">üìã –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
      </div>
      <div id="adminPromoList" class="small" style="margin-top:8px; white-space:pre-wrap;"></div>

      <strong style="display:block; margin-top:14px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</strong>
      <div class="field">
        <label for="adminUserQuery">–ü–æ–∏—Å–∫ –ø–æ @username –∏–ª–∏ Telegram ID</label>
        <input id="adminUserQuery" type="text" placeholder="@username –∏–ª–∏ 123456789">
      </div>
      <div class="order-row">
        <button id="adminUserSearchBtn" class="ghost">üîé –ù–∞–π—Ç–∏</button>
      </div>
      <div id="adminUserResults" class="small" style="margin-top:8px; white-space:pre-wrap;"></div>
      <div id="adminSelectedUser" class="small" style="margin-top:8px;">–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –Ω–µ—Ç</div>
      <div class="admin-plan-grid">
        <div class="field">
          <label for="adminGrantDays">–í—ã–¥–∞—Ç—å –¥–Ω–µ–π</label>
          <input id="adminGrantDays" type="number" min="1" max="3650" value="30">
        </div>
      </div>
      <div class="order-row">
        <button id="adminGrantBtn" class="ghost">‚ûï –í—ã–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
        <button id="adminRemoveSubBtn" class="ghost">üóë –£–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
      </div>

      <div class="field">
        <label for="adminNotifyText">–¢–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <textarea id="adminNotifyText" placeholder="–ï—Å–ª–∏ –ø—É—Å—Ç–æ, –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç –∞–∫—Ü–∏–∏."></textarea>
      </div>

      <div class="order-row">
        <button id="adminSaveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–Ω—ã</button>
        <button id="adminReloadBtn" class="ghost">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button id="adminNotifyBtn" class="ghost">üì£ –†–∞—Å—Å—ã–ª–∫–∞</button>
      </div>
    </section>

    <section id="orderCard" class="card hidden">
      <strong>–¢–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑</strong>
      <div id="orderInfo" class="small" style="margin-top:8px;"></div>
      <div id="orderCode" class="mono"></div>
      <div class="order-row">
        <button id="payBtn">üí∏ –û–ø–ª–∞—Ç–∏—Ç—å</button>
        <button id="checkBtn" class="ghost">‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É</button>
        <button id="cancelBtn" class="ghost">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
        <button id="copyBtn" class="ghost">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
      </div>
      <p class="small" style="margin-top:10px;">
        –£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –∫–∞–∫ –≤ –∑–∞–∫–∞–∑–µ. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–∫–æ–¥ –∑–∞–∫–∞–∑–∞) –∂–µ–ª–∞—Ç–µ–ª–µ–Ω, –Ω–æ –µ—Å–ª–∏ –ø–æ–ª—è –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –æ–ø–ª–∞—Ç–∏—Ç–µ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É¬ª.
      </p>
    </section>
  </main>

  <script>
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
      tg.ready();
      tg.expand();
    }

    const initData = tg ? tg.initData : "";
    const urlParams = new URLSearchParams(window.location.search || "");
    const requestedOrderId = String(urlParams.get("order_id") || "").trim().toUpperCase();
    const autoPayRequested = String(urlParams.get("autopay") || "") === "1";
    let currentOrderId = "";
    let currentPaymentUrl = "";
    let currentOrderProviderLabel = "DonatePay";
    let autoStatusTimer = null;
    let autoPayTriggered = false;
    let isAdmin = false;
    let adminLoaded = false;
    let selectedAdminUserId = 0;
    let adminFoundUsers = [];
    let paymentProvider = "donatepay";
    let paymentProviderLabel = "DonatePay";

    const statusEl = document.getElementById("status");
    const profileEl = document.getElementById("profile");
    const activePromoEl = document.getElementById("activePromo");
    const promoCodeInputEl = document.getElementById("promoCodeInput");
    const promoActivateBtn = document.getElementById("promoActivateBtn");
    const plansEl = document.getElementById("plans");
    const adminCardEl = document.getElementById("adminCard");
    const adminGlobalDiscountEl = document.getElementById("adminGlobalDiscount");
    const adminSaleTitleEl = document.getElementById("adminSaleTitle");
    const adminSaleMessageEl = document.getElementById("adminSaleMessage");
    const adminPlansEl = document.getElementById("adminPlans");
    const adminPromoCodeEl = document.getElementById("adminPromoCode");
    const adminPromoDiscountEl = document.getElementById("adminPromoDiscount");
    const adminPromoExpiresEl = document.getElementById("adminPromoExpires");
    const adminPromoMaxActivationsEl = document.getElementById("adminPromoMaxActivations");
    const adminPromoSaveBtn = document.getElementById("adminPromoSaveBtn");
    const adminPromoReloadBtn = document.getElementById("adminPromoReloadBtn");
    const adminPromoListEl = document.getElementById("adminPromoList");
    const adminUserQueryEl = document.getElementById("adminUserQuery");
    const adminUserSearchBtn = document.getElementById("adminUserSearchBtn");
    const adminUserResultsEl = document.getElementById("adminUserResults");
    const adminSelectedUserEl = document.getElementById("adminSelectedUser");
    const adminGrantDaysEl = document.getElementById("adminGrantDays");
    const adminGrantBtn = document.getElementById("adminGrantBtn");
    const adminRemoveSubBtn = document.getElementById("adminRemoveSubBtn");
    const adminNotifyTextEl = document.getElementById("adminNotifyText");
    const adminSaveBtn = document.getElementById("adminSaveBtn");
    const adminReloadBtn = document.getElementById("adminReloadBtn");
    const adminNotifyBtn = document.getElementById("adminNotifyBtn");
    const orderCardEl = document.getElementById("orderCard");
    const orderInfoEl = document.getElementById("orderInfo");
    const orderCodeEl = document.getElementById("orderCode");
    const payBtn = document.getElementById("payBtn");
    const checkBtn = document.getElementById("checkBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const copyBtn = document.getElementById("copyBtn");

    function setStatus(text, kind) {
      statusEl.textContent = text;
      statusEl.className = "status";
      if (kind === "ok") statusEl.classList.add("ok");
      if (kind === "err") statusEl.classList.add("err");
    }

    async function requestJson(url, method, payload) {
      const options = { method, headers: { "Content-Type": "application/json" } };
      if (payload) options.body = JSON.stringify(payload);
      const res = await fetch(url, options);
      let data = {};
      try {
        data = await res.json();
      } catch (_) {
        throw new Error("bad_json_response");
      }
      if (!res.ok || data.ok === false) {
        throw new Error(data.error || ("http_" + res.status));
      }
      return data;
    }

    function setAdminVisible(visible) {
      if (visible) adminCardEl.classList.remove("hidden");
      else adminCardEl.classList.add("hidden");
    }

    function toInt(value, fallback = 0) {
      const parsed = Number.parseInt(String(value), 10);
      return Number.isFinite(parsed) ? parsed : fallback;
    }

    function promoErrorText(code) {
      const map = {
        bad_code_format: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø—Ä–æ–º–æ–∫–æ–¥–∞.",
        promo_not_found: "–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω.",
        promo_inactive: "–ü—Ä–æ–º–æ–∫–æ–¥ –æ—Ç–∫–ª—é—á–µ–Ω.",
        promo_expired: "–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—Ç–µ–∫.",
        promo_limit_reached: "–õ–∏–º–∏—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–π –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—á–µ—Ä–ø–∞–Ω.",
        promo_already_activated: "–í—ã —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥."
      };
      return map[code] || ("–û—à–∏–±–∫–∞: " + code);
    }

    function renderAdminPromocodes(promocodes) {
      if (!adminPromoListEl) return;
      const items = (promocodes || []).map((promo) => {
        const limit = Number(promo.max_activations || 0) > 0
          ? `${promo.total_activations || 0}/${promo.max_activations}`
          : `${promo.total_activations || 0}/‚àû`;
        const used = Number(promo.used_activations || 0);
        const state = promo.is_expired ? "–∏—Å—Ç–µ–∫" : (promo.is_active ? "–∞–∫—Ç–∏–≤–µ–Ω" : "–≤—ã–∫–ª");
        return `‚Ä¢ ${promo.code}: -${promo.discount_rub} ‚ÇΩ, –¥–æ ${promo.expires_at}, –∞–∫—Ç–∏–≤–∞—Ü–∏–π ${limit}, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ ${used}, —Å—Ç–∞—Ç—É—Å ${state}`;
      });
      adminPromoListEl.textContent = items.length ? items.join("\n") : "–ü—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.";
    }

    function updateSelectedUserView() {
      if (!adminSelectedUserEl) return;
      if (!selectedAdminUserId) {
        adminSelectedUserEl.textContent = "–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –Ω–µ—Ç";
        return;
      }
      const user = adminFoundUsers.find((item) => Number(item.telegram_id) === Number(selectedAdminUserId));
      if (!user) {
        adminSelectedUserEl.textContent = `–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ID ${selectedAdminUserId}`;
        return;
      }
      const username = user.username ? "@" + user.username : "-";
      const sub = user.subscription_active
        ? `–∞–∫—Ç–∏–≤–Ω–∞ –¥–æ ${user.subscription_end || "-"}`
        : "–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞";
      adminSelectedUserEl.textContent = `–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.telegram_id} (${username}), –ø–æ–¥–ø–∏—Å–∫–∞ ${sub}`;
    }

    function renderAdminUsers(users) {
      adminFoundUsers = Array.isArray(users) ? users : [];
      if (!adminUserResultsEl) return;
      if (!adminFoundUsers.length) {
        adminUserResultsEl.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.";
        selectedAdminUserId = 0;
        updateSelectedUserView();
        return;
      }

      adminUserResultsEl.innerHTML = "";
      adminFoundUsers.forEach((user) => {
        const username = user.username ? "@" + user.username : "-";
        const sub = user.subscription_active
          ? `–∞–∫—Ç–∏–≤–Ω–∞ –¥–æ ${user.subscription_end || "-"}`
          : "–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞";
        const line = document.createElement("div");
        line.className = "order-row";
        const btn = document.createElement("button");
        btn.className = "ghost";
        btn.textContent = `ID ${user.telegram_id} | ${username} | ${sub}`;
        btn.onclick = () => {
          selectedAdminUserId = Number(user.telegram_id);
          updateSelectedUserView();
          setStatus(`–í—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${selectedAdminUserId}.`, "ok");
        };
        line.appendChild(btn);
        adminUserResultsEl.appendChild(line);
      });
      if (!selectedAdminUserId && adminFoundUsers.length) {
        selectedAdminUserId = Number(adminFoundUsers[0].telegram_id || 0);
      }
      updateSelectedUserView();
    }

    function renderAdminPlans(plans) {
      adminPlansEl.innerHTML = "";
      (plans || []).forEach((plan) => {
        const row = document.createElement("div");
        row.className = "admin-plan";
        row.dataset.code = plan.code || "";
        row.innerHTML = `
          <div class="admin-plan-head">–ö–æ–¥: ${plan.code || "-"}</div>
          <div class="admin-plan-grid">
            <div class="field">
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input class="admin-title" type="text" value="${plan.title || ""}">
            </div>
            <div class="field">
              <label>–î–Ω–µ–π</label>
              <input class="admin-days" type="number" min="1" max="3650" value="${plan.days || 1}">
            </div>
            <div class="field">
              <label>–¶–µ–Ω–∞ (‚ÇΩ)</label>
              <input class="admin-amount" type="number" min="1" max="100000" value="${plan.amount_rub || 1}">
            </div>
            <div class="field">
              <label>–°–∫–∏–¥–∫–∞ –ø–ª–∞–Ω–∞ (%)</label>
              <input class="admin-discount" type="number" min="0" max="90" value="${plan.discount_percent || 0}">
            </div>
          </div>
        `;
        adminPlansEl.appendChild(row);
      });
    }

    function collectAdminPricing() {
      const rows = Array.from(adminPlansEl.querySelectorAll(".admin-plan"));
      const plans = rows.map((row) => ({
        code: String(row.dataset.code || "").trim().toLowerCase(),
        title: String(row.querySelector(".admin-title")?.value || "").trim(),
        days: toInt(row.querySelector(".admin-days")?.value, 1),
        amount_rub: toInt(row.querySelector(".admin-amount")?.value, 1),
        discount_percent: toInt(row.querySelector(".admin-discount")?.value, 0)
      }));

      return {
        global_discount_percent: toInt(adminGlobalDiscountEl.value, 0),
        sale_title: String(adminSaleTitleEl.value || "").trim(),
        sale_message: String(adminSaleMessageEl.value || "").trim(),
        plans
      };
    }

    function applyAdminPricing(pricing) {
      adminGlobalDiscountEl.value = pricing.global_discount_percent ?? 0;
      adminSaleTitleEl.value = pricing.sale_title || "";
      adminSaleMessageEl.value = pricing.sale_message || "";
      renderAdminPlans(pricing.plans || []);
    }

    async function loadAdminPanel() {
      if (!isAdmin) return;
      const data = await requestJson("/webapp/api/admin/pricing", "POST", { init_data: initData });
      applyAdminPricing(data.pricing || {});
      await loadAdminPromocodes();
      adminLoaded = true;
    }

    async function saveAdminPricing() {
      if (!isAdmin) return;
      const pricing = collectAdminPricing();
      const data = await requestJson("/webapp/api/admin/save-pricing", "POST", {
        init_data: initData,
        pricing
      });
      applyAdminPricing(data.pricing || {});
      await loadPlans();
      setStatus("–¶–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.", "ok");
    }

    async function adminNotify() {
      if (!isAdmin) return;
      const text = String(adminNotifyTextEl.value || "").trim();
      const data = await requestJson("/webapp/api/admin/notify", "POST", {
        init_data: initData,
        text
      });
      setStatus(`–†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: ${data.sent}, –æ—à–∏–±–æ–∫: ${data.failed}.`, "ok");
      adminNotifyTextEl.value = "";
    }

    async function loadAdminPromocodes() {
      if (!isAdmin) return;
      const data = await requestJson("/webapp/api/admin/promocodes", "POST", { init_data: initData });
      renderAdminPromocodes(data.promocodes || []);
    }

    async function saveAdminPromocode() {
      if (!isAdmin) return;
      const payload = {
        init_data: initData,
        code: String(adminPromoCodeEl.value || "").trim(),
        discount_rub: toInt(adminPromoDiscountEl.value, 0),
        expires_at: String(adminPromoExpiresEl.value || "").trim(),
        max_activations: toInt(adminPromoMaxActivationsEl.value, 0)
      };
      const data = await requestJson("/webapp/api/admin/create-promocode", "POST", payload);
      renderAdminPromocodes(data.promocodes || []);
      setStatus("–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω.", "ok");
    }

    async function adminFindUsers() {
      if (!isAdmin) return;
      const query = String(adminUserQueryEl.value || "").trim();
      if (!query) {
        setStatus("–í–≤–µ–¥–∏—Ç–µ username –∏–ª–∏ Telegram ID.", "err");
        return;
      }
      const data = await requestJson("/webapp/api/admin/find-user", "POST", {
        init_data: initData,
        query
      });
      renderAdminUsers(data.users || []);
      setStatus(`–ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${(data.users || []).length}.`, "ok");
    }

    async function adminGrantSubscription() {
      if (!isAdmin) return;
      const telegramId = Number(selectedAdminUserId || 0);
      if (!telegramId) {
        setStatus("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.", "err");
        return;
      }
      const days = toInt(adminGrantDaysEl.value, 0);
      if (days <= 0) {
        setStatus("–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π.", "err");
        return;
      }
      const data = await requestJson("/webapp/api/admin/grant-subscription", "POST", {
        init_data: initData,
        telegram_id: telegramId,
        days
      });
      setStatus(`–ü–æ–¥–ø–∏—Å–∫–∞ –≤—ã–¥–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${telegramId}.`, "ok");
      if (data.user) {
        renderAdminUsers([data.user]);
      }
    }

    async function adminRemoveSubscription() {
      if (!isAdmin) return;
      const telegramId = Number(selectedAdminUserId || 0);
      if (!telegramId) {
        setStatus("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.", "err");
        return;
      }
      const data = await requestJson("/webapp/api/admin/remove-subscription", "POST", {
        init_data: initData,
        telegram_id: telegramId
      });
      setStatus(`–ü–æ–¥–ø–∏—Å–∫–∞ —É–¥–∞–ª–µ–Ω–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${telegramId}.`, "ok");
      if (data.user) {
        renderAdminUsers([data.user]);
      }
    }

    async function activatePromocode() {
      if (!initData) {
        setStatus("–û—Ç–∫—Ä–æ–π—Ç–µ Mini App —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞.", "err");
        return;
      }
      const promoCode = String(promoCodeInputEl.value || "").trim();
      if (!promoCode) {
        setStatus("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥.", "err");
        return;
      }
      try {
        await requestJson("/webapp/api/activate-promocode", "POST", {
          init_data: initData,
          promo_code: promoCode
        });
        promoCodeInputEl.value = "";
        await loadProfile();
        setStatus("–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.", "ok");
      } catch (err) {
        setStatus(promoErrorText(err.message), "err");
      }
    }

    function renderPlans(plans, paymentEnabled, providerLabel) {
      plansEl.innerHTML = "";
      if (!paymentEnabled) {
        const muted = document.createElement("div");
        muted.className = "small";
        muted.textContent = "–û–ø–ª–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞: –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.";
        plansEl.appendChild(muted);
        return;
      }

      plans.forEach((plan) => {
        const item = document.createElement("div");
        item.className = "plan";
        const discountLine = (plan.discount_percent > 0 && plan.base_amount_rub > plan.amount_rub)
          ? `<p>–°–∫–∏–¥–∫–∞: -${plan.discount_percent}% (–±—ã–ª–æ ${plan.base_amount_rub} ‚ÇΩ)</p>`
          : "";
        item.innerHTML = `
          <div>
            <h3>${plan.title} ‚Ä¢ ${plan.amount_rub} ‚ÇΩ</h3>
            <p>${plan.days} –¥–Ω–µ–π –¥–æ—Å—Ç—É–ø–∞</p>
            ${discountLine}
          </div>
        `;
        const btn = document.createElement("button");
        btn.textContent = "–ö—É–ø–∏—Ç—å";
        btn.onclick = () => createOrder(plan.code);
        item.appendChild(btn);
        plansEl.appendChild(item);
      });

      if (providerLabel) {
        const note = document.createElement("div");
        note.className = "small";
        note.style.marginTop = "8px";
        note.textContent = `–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑: ${providerLabel}`;
        plansEl.appendChild(note);
      }
    }

    function clearOrder() {
      currentOrderId = "";
      currentPaymentUrl = "";
      orderCardEl.classList.add("hidden");
      orderInfoEl.textContent = "";
      orderCodeEl.textContent = "";
    }

    function showOrder(orderId, paymentUrl, plan, expiresAt) {
      currentOrderId = orderId;
      currentPaymentUrl = paymentUrl || "";
      currentOrderProviderLabel = String(plan.provider_label || paymentProviderLabel || "–ø–ª–∞—Ç–µ–∂–Ω—ã–π —Å–µ—Ä–≤–∏—Å");
      orderCardEl.classList.remove("hidden");
      const baseAmount = Number(plan.base_amount_rub || plan.amount_rub || 0);
      const amount = Number(plan.amount_rub || 0);
      const tariffDiscountTail = (plan.discount_percent > 0 && baseAmount > amount)
        ? `, —Å–∫–∏–¥–∫–∞ —Ç–∞—Ä–∏—Ñ–∞: -${plan.discount_percent}% (–±—ã–ª–æ ${baseAmount} ‚ÇΩ)`
        : "";
      const promoCode = String((plan.promo && plan.promo.code) || plan.promo_code || "").trim();
      const promoDiscount = Number((plan.promo && plan.promo.discount_rub) || plan.promo_discount_rub || 0);
      const promoTail = promoCode && promoDiscount > 0
        ? `, –ø—Ä–æ–º–æ–∫–æ–¥ ${promoCode}: -${promoDiscount} ‚ÇΩ`
        : "";
      const expiresTail = expiresAt ? `, –∏—Å—Ç–µ–∫–∞–µ—Ç: ${expiresAt}` : "";
      const providerTail = currentOrderProviderLabel ? `, —Å–µ—Ä–≤–∏—Å: ${currentOrderProviderLabel}` : "";
      orderInfoEl.textContent = `–¢–∞—Ä–∏—Ñ: ${plan.title}, —Å—É–º–º–∞: ${amount} ‚ÇΩ${tariffDiscountTail}${promoTail}${providerTail}${expiresTail}`;
      orderCodeEl.textContent = orderId;
      setStatus(`–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –ù–∞–∂–º–∏—Ç–µ ¬´–û–ø–ª–∞—Ç–∏—Ç—å¬ª (${currentOrderProviderLabel}).`, "ok");
      maybeAutoOpenPayment();
    }

    function stopAutoStatusPolling() {
      if (autoStatusTimer) {
        clearInterval(autoStatusTimer);
        autoStatusTimer = null;
      }
    }

    function startAutoStatusPolling() {
      stopAutoStatusPolling();
      if (!currentOrderId) return;
      autoStatusTimer = setInterval(() => {
        checkOrderStatus(true);
      }, 10000);
    }

    async function loadPlans() {
      const data = await requestJson("/webapp/api/plans", "GET");
      paymentProvider = String(data.payment_provider || "donatepay");
      paymentProviderLabel = String(data.payment_provider_label || "DonatePay");
      renderPlans(data.plans || [], data.payment_enabled, paymentProviderLabel);
    }

    async function loadProfile() {
      if (!initData) {
        profileEl.textContent = "–û—Ç–∫—Ä–æ–π—Ç–µ Mini App –∏–∑ Telegram-–±–æ—Ç–∞.";
        setStatus("initData –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.", "err");
        return;
      }

      const me = await requestJson("/webapp/api/me", "POST", { init_data: initData });
      const sub = me.subscription || {};
      const subText = sub.active ? ("–∞–∫—Ç–∏–≤–Ω–∞ –¥–æ " + (sub.subscription_end || "-")) : "–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞";
      const adminText = me.user && me.user.is_admin ? " | –†–æ–ª—å: –∞–¥–º–∏–Ω" : "";
      profileEl.textContent = `ID: ${me.user.id} | –ü–æ–¥–ø–∏—Å–∫–∞: ${subText}${adminText}`;
      if (me.active_promo && me.active_promo.code) {
        activePromoEl.textContent = `–ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥: ${me.active_promo.code} (-${me.active_promo.discount_rub} ‚ÇΩ, –¥–æ ${me.active_promo.expires_at})`;
      } else {
        activePromoEl.textContent = "–ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥: –Ω–µ—Ç";
      }

      isAdmin = !!(me.user && me.user.is_admin);
      setAdminVisible(isAdmin);
      if (isAdmin && !adminLoaded) {
        await loadAdminPanel();
      }

      if (me.pending_order) {
        showOrder(
          me.pending_order.order_id,
          me.pending_order.payment_url || "",
          {
            title: me.pending_order.days + " –¥–Ω–µ–π",
            amount_rub: me.pending_order.amount_rub,
            base_amount_rub: me.pending_order.base_amount_rub,
            provider_label: me.pending_order.provider_label || paymentProviderLabel,
            promo_code: me.pending_order.promo_code,
            promo_discount_rub: me.pending_order.promo_discount_rub
          },
          me.pending_order.expires_at || ""
        );
        startAutoStatusPolling();
        setStatus("–ù–∞–π–¥–µ–Ω –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–ª–∞—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.", "ok");
      } else {
        stopAutoStatusPolling();
        clearOrder();
        setStatus("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑.", "ok");
      }
    }

    async function createOrder(planCode) {
      if (!initData) {
        setStatus("–û—Ç–∫—Ä–æ–π—Ç–µ Mini App —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞.", "err");
        return;
      }
      try {
        const data = await requestJson("/webapp/api/create-order", "POST", {
          init_data: initData,
          plan_code: planCode
        });
        const orderPlan = Object.assign({}, data.plan || {}, {
          provider_label: data.payment_provider_label || paymentProviderLabel
        });
        showOrder(data.order_id, data.payment_url, orderPlan, data.expires_at || "");
        startAutoStatusPolling();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞: " + err.message, "err");
      }
    }

    async function checkOrderStatus(silent = false) {
      if (!currentOrderId) {
        if (!silent) setStatus("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑.", "err");
        return;
      }
      try {
        const data = await requestJson("/webapp/api/order-status", "POST", {
          init_data: initData,
          order_id: currentOrderId
        });
        if (data.order.status === "paid") {
          stopAutoStatusPolling();
          setStatus("–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ ‚úÖ", "ok");
          await loadProfile();
          return;
        }
        if (data.order.status === "cancelled") {
          stopAutoStatusPolling();
          clearOrder();
          if (!silent) {
            setStatus("–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω –∏–ª–∏ –∏—Å—Ç–µ–∫. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π.", "err");
          }
          return;
        }
        if (!silent) {
          const expiresAt = data.order.expires_at || "";
          const tail = expiresAt ? ` –ó–∞–∫–∞–∑ –∏—Å—Ç–µ–∫–∞–µ—Ç: ${expiresAt}.` : "";
          setStatus("–ü–ª–∞—Ç–µ–∂ –ø–æ–∫–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω." + tail, "err");
        } else {
          setStatus("–ü–ª–∞—Ç–µ–∂ –ø–æ–∫–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω. –ò–¥–µ—Ç –∞–≤—Ç–æ-–ø—Ä–æ–≤–µ—Ä–∫–∞...", "ok");
        }
      } catch (err) {
        if (!silent) setStatus("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã: " + err.message, "err");
      }
    }

    async function cancelOrder() {
      if (!currentOrderId) {
        setStatus("–ù–µ—Ç –∑–∞–∫–∞–∑–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã.", "err");
        return;
      }
      try {
        await requestJson("/webapp/api/cancel-order", "POST", {
          init_data: initData,
          order_id: currentOrderId
        });
        stopAutoStatusPolling();
        clearOrder();
        setStatus("–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω.", "ok");
        await loadProfile();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞: " + err.message, "err");
      }
    }

    function openPaymentLink() {
      if (!currentPaymentUrl) {
        setStatus("–°—Å—ã–ª–∫–∞ –æ–ø–ª–∞—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑.", "err");
        return;
      }
      if (currentOrderId && navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(currentOrderId).catch(() => {});
      }
      if (tg && tg.openLink) {
        tg.openLink(currentPaymentUrl, { try_instant_view: false });
      } else {
        window.location.href = currentPaymentUrl;
      }
    }

    function maybeAutoOpenPayment() {
      if (!autoPayRequested || autoPayTriggered) return;
      if (!currentOrderId || !currentPaymentUrl) return;
      if (requestedOrderId && requestedOrderId !== String(currentOrderId).toUpperCase()) return;
      autoPayTriggered = true;
      setStatus(`–û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–ø–ª–∞—Ç—É –≤ ${currentOrderProviderLabel}...`, "ok");
      openPaymentLink();
    }

    payBtn.onclick = () => {
      openPaymentLink();
    };

    checkBtn.onclick = () => checkOrderStatus(false);
    cancelBtn.onclick = cancelOrder;
    promoActivateBtn.onclick = async () => {
      await activatePromocode();
    };
    adminSaveBtn.onclick = async () => {
      try {
        await saveAdminPricing();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–µ–Ω: " + err.message, "err");
      }
    };
    adminReloadBtn.onclick = async () => {
      try {
        await loadAdminPanel();
        setStatus("–ö–æ–Ω—Ñ–∏–≥ –æ–±–Ω–æ–≤–ª–µ–Ω.", "ok");
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞: " + err.message, "err");
      }
    };
    adminNotifyBtn.onclick = async () => {
      try {
        await adminNotify();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏: " + err.message, "err");
      }
    };
    adminPromoSaveBtn.onclick = async () => {
      try {
        await saveAdminPromocode();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞: " + promoErrorText(err.message), "err");
      }
    };
    adminPromoReloadBtn.onclick = async () => {
      try {
        await loadAdminPromocodes();
        setStatus("–°–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω.", "ok");
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤: " + err.message, "err");
      }
    };
    adminUserSearchBtn.onclick = async () => {
      try {
        await adminFindUsers();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: " + err.message, "err");
      }
    };
    adminGrantBtn.onclick = async () => {
      try {
        await adminGrantSubscription();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏ –ø–æ–¥–ø–∏—Å–∫–∏: " + err.message, "err");
      }
    };
    adminRemoveSubBtn.onclick = async () => {
      try {
        await adminRemoveSubscription();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏: " + err.message, "err");
      }
    };

    copyBtn.onclick = async () => {
      if (!currentOrderId) {
        setStatus("–ù–µ—Ç –∫–æ–¥–∞ –∑–∞–∫–∞–∑–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.", "err");
        return;
      }
      try {
        await navigator.clipboard.writeText(currentOrderId);
        setStatus("–ö–æ–¥ –∑–∞–∫–∞–∑–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω.", "ok");
      } catch (_) {
        setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.", "err");
      }
    };

    (async () => {
      try {
        await loadPlans();
        await loadProfile();
      } catch (err) {
        setStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + err.message, "err");
      }
    })();
  </script>
</body>
</html>
