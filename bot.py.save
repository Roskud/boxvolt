import os
import sqlite3
import datetime
import datetime
from aiogram.types import LabeledPrice
from pathlib import Path
from dotenv import load_dotenv

from aiogram import Bot, Dispatcher
from aiogram.types import Message, ReplyKeyboardMarkup, KeyboardButton
from aiogram.filters import Command

# === –ó–∞–≥—Ä—É–∑–∫–∞ .env ===
load_dotenv(Path(__file__).parent / ".env")
BOT_TOKEN = os.getenv("BOT_TOKEN")

if not BOT_TOKEN:
    raise ValueError("BOT_TOKEN not found in .env file")

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# === –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ===
def init_db():
    conn = sqlite3.connect("users.db")
    cursor = conn.cursor()
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS users (
        telegram_id INTEGER PRIMARY KEY,
        username TEXT,
        subscription_end TEXT,
        trial_used INTEGER DEFAULT 0,
        traffic_limit INTEGER DEFAULT 0,
        traffic_used INTEGER DEFAULT 0,
        plan_type TEXT DEFAULT 'none'
    )
    """)
    conn.commit()
    conn.close()

init_db()

# === –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ===
main_kb = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="üöÄ –ü–æ–¥–∫–ª—é—á–∏—Ç—å VPN")],
        [KeyboardButton(text="üéÅ –¢–µ—Å—Ç –Ω–∞ 3 –¥–Ω—è")],
        [KeyboardButton(text="üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç")],
        [KeyboardButton(text="üìò –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è")],
        [KeyboardButton(text="üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞")]
    ],
    resize_keyboard=True
)

# === /start ===
@dp.message(Command("start"))
async def start_handler(message: Message):
    conn = sqlite3.connect("users.db")
    cursor = conn.cursor()

    cursor.execute(
        "INSERT OR IGNORE INTO users (telegram_id, username) VALUES (?, ?)",
        (message.from_user.id, message.from_user.username)
    )

    conn.commit()
    conn.close()

    text = (
        "‚ö°Ô∏è BoxVolt VPN\n"
        "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        "üåç –°–µ—Ä–≤–µ—Ä: NL-1 (Netherlands)\n\n"
        "–°–∫–æ—Ä–æ—Å—Ç—å –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.\n"
        "–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ VLESS Reality."
    )

    await message.answer(text, reply_markup=main_kb)

# === –¢–µ—Å—Ç –Ω–∞ 3 –¥–Ω—è ===
@dp.message(lambda m: m.text == "üéÅ –¢–µ—Å—Ç –Ω–∞ 3 –¥–Ω—è")
async def trial_handler(message: Message):
    conn = sqlite3.connect("users.db")
    cursor = conn.cursor()

    cursor.execute(
        "SELECT trial_used FROM users WHERE telegram_id=?",
        (message.from_user.id,)
    )

    result = cursor.fetchone()

    if result and result[0] == 1:
        await message.answer("‚ùå –¢–µ—Å—Ç —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω.")
        conn.close()
        return

    trial_end = datetime.datetime.now() + datetime.timedelta(days=3)

    cursor.execute("""
        UPDATE users
        SET trial_used=1,
            subscription_end=?,
            plan_type='trial',
            traffic_limit=15
        WHERE telegram_id=?
    """, (trial_end.strftime("%Y-%m-%d %H:%M:%S"), message.from_user.id))

    conn.commit()
    conn.close()

    await message.answer("‚úÖ –¢–µ—Å—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞ 3 –¥–Ω—è.\n–õ–∏–º–∏—Ç: 15 –ì–ë")

# === –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ===
@dp.message(lambda m: m.text == "üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç")
async def profile_handler(message: Message):
    conn = sqlite3.connect("users.db")
    cursor = conn.cursor()

    cursor.execute("""
        SELECT subscription_end, trial_used, traffic_limit, traffic_used, plan_type
        FROM users
        WHERE telegram_id=?
    """, (message.from_user.id,))

    user = cursor.fetchone()
    conn.close()

    if not user:
        await message.answer("–û—à–∏–±–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        return

    subscription_end, trial_used, traffic_limit, traffic_used, plan_type = user

    text = (
        "üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç\n"
        "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"–¢–∞—Ä–∏—Ñ: {plan_type}\n"
        f"–û–∫–æ–Ω—á–∞–Ω–∏–µ: {subscription_end}\n"
        f"–¢—Ä–∞—Ñ–∏–∫: {traffic_used} / {traffic_limit} –ì–ë\n"
        "–°–µ—Ä–≤–µ—Ä: NL-1"
    )

    await message.answer(text)

# === –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è ===
@dp.message(lambda m: m.text == "üìò –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è")
async def instruction_handler(message: Message):
    text = (
        "üìò –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:\n\n"
        "Android: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Happ –∏–ª–∏ V2RayTun\n"
        "iOS: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Happ\n"
        "Windows: V2RayTun\n\n"
        "–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥."
    )
    await message.answer(text)

# === –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ===
@dp.message(lambda m: m.text == "üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞")
async def support_handler(message: Message):
    await message.answer("–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å, –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏—Ç –≤–∞–º.")

# === –ó–∞–ø—É—Å–∫ ===
async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    import asyncio
    asyncio.run(main())
